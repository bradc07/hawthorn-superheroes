<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hawthorn Superheroes: Platinum Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;800;900&family=Rajdhani:wght@500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #020617;
            --card-bg: #0f172a;

            /* ELEMENTAL COLORS */
            --col-electric: #fbbf24;
            --col-ice: #22d3ee;
            --col-impact: #ef4444;

            /* AMBIENCE */
            --nebula-1: rgba(76, 29, 149, 0.2);
            --nebula-2: rgba(56, 189, 248, 0.1);

            --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            background-color: var(--bg-deep);
            font-family: "Rajdhani", "Inter", sans-serif;
            color: #fff;
            overflow-x: hidden;
            perspective: 1200px;
            -webkit-tap-highlight-color: transparent;
            cursor: default;
            transition: background-color 1s;
        }

        /* --- DEEP SPACE PARALLAX BACKGROUND --- */
        .space-bg {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
            overflow: hidden;
            transition: 1s;
        }

        .stars {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            box-shadow: 100px 200px #fff, 400px 500px #fff, 700px 100px #fff, 900px 800px #fff;
            animation: starMove 100s linear infinite;
            opacity: 0.5;
        }

        .stars.md {
            width: 3px;
            height: 3px;
            animation-duration: 150s;
            opacity: 0.3;
        }

        @keyframes starMove {
            from { transform: translateY(0); }
            to { transform: translateY(-2000px); }
        }

        .nebula-layer {
            position: absolute;
            inset: -50%;
            background: radial-gradient(circle at 20% 30%, var(--nebula-1), transparent 50%), radial-gradient(circle at 80% 70%, var(--nebula-2), transparent 50%);
            filter: blur(60px);
            animation: nebulaPulse 20s ease-in-out infinite alternate;
            transition: background 1.5s;
        }

        @keyframes nebulaPulse {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.1); }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            mask-image: radial-gradient(circle at center, black 30%, transparent 90%);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            padding-bottom: 6rem;
        }

        /* HEADER */
        header {
            text-align: center;
            margin: 3rem 0 3rem 0;
            animation: fadeSlideDown 1s var(--ease-smooth) forwards;
        }

        header h1 {
            font-family: "Bangers", cursive;
            font-size: clamp(4rem, 12vw, 8rem);
            letter-spacing: 4px;
            line-height: 0.9;
            background: linear-gradient(180deg, #ffffff 20%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 40px rgba(255, 255, 255, 0.15));
            margin-bottom: 1rem;
            transform: skewY(-2deg);
        }

        .subtitle {
            font-size: 1.2rem;
            color: #38bdf8;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-weight: 700;
            display: inline-block;
            padding: 0.5rem 2rem;
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 4px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }

        /* --- CONTROLS BAR --- */
        .controls-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 3rem;
            animation: fadeSlideDown 1.2s var(--ease-smooth) forwards;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.5rem;
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-family: "Rajdhani";
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.3s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            text-shadow: 0 0 10px currentColor;
        }

        .filter-btn.active {
            background: var(--active-color);
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 20px var(--active-color);
        }

        /* Battle Button Style */
        .battle-btn {
            background: rgba(76, 29, 149, 0.3);
            border: 1px solid #a855f7;
            color: #e9d5ff;
        }
        .battle-btn:hover, .battle-btn.active {
             background: #a855f7;
             color: #fff;
             box-shadow: 0 0 25px #a855f7;
        }

        /* --- GRID --- */
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 3rem;
            padding-top: 1rem;
        }

        .hero-card-container {
            perspective: 1500px;
            transition: 0.5s;
        }

        .hero-card-container.hidden {
            display: none;
        }

        /* --- CARD --- */
        .hero-card {
            height: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.2s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.3s, border-color 0.3s;
            cursor: pointer;
            overflow: hidden;
            opacity: 0;
            transform: translateY(100px) rotateX(10deg);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.05);
        }

        .hero-card.reveal {
            opacity: 1;
            transform: translateY(0) rotateX(0);
            transition: opacity 0.8s ease-out, transform 0.8s var(--ease-smooth);
        }

        .hero-card:hover {
            z-index: 10;
            box-shadow: 0 50px 80px -20px rgba(0, 0, 0, 0.9);
        }

        .hero-card.selected {
            border-color: #4ade80;
            box-shadow: 0 0 40px rgba(74, 222, 128, 0.6);
            transform: scale(1.05) !important;
        }
        
        .hero-card.dimmed {
            opacity: 0.4;
            filter: grayscale(0.8);
        }

        /* Glows */
        .hero-card[data-type="electric"]:hover {
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.3);
            border-color: var(--col-electric);
        }
        .hero-card[data-type="ice"]:hover {
            box-shadow: 0 0 50px rgba(34, 211, 238, 0.3);
            border-color: var(--col-ice);
        }
        .hero-card[data-type="impact"]:hover {
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.3);
            border-color: var(--col-impact);
        }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30;
            background: linear-gradient(to bottom, transparent 40%, rgba(255, 255, 255, 0.1) 50%, transparent 60%);
            background-size: 100% 200%; opacity: 0; transition: opacity 0.3s;
        }
        .hero-card:hover .scan-line { opacity: 1; animation: scanDown 2s infinite linear; }
        @keyframes scanDown { 0% { background-position: 0% 0%; } 100% { background-position: 0% 200%; } }

        .card-foil {
            position: absolute; inset: 0; z-index: 20; opacity: 0; transition: opacity 0.4s; pointer-events: none;
            background: linear-gradient(115deg, transparent 20%, rgba(255, 255, 255, 0.4) 30%, rgba(255, 0, 255, 0.3) 40%, rgba(0, 255, 255, 0.3) 50%, rgba(255, 255, 0, 0.3) 60%, transparent 80%);
            mix-blend-mode: overlay; transform: translateZ(1px); background-size: 200% 200%;
        }
        .hero-card:hover .card-foil { opacity: 1; }

        .card-image-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .hero-card img {
            width: 100%; height: 100%; object-fit: cover; object-position: center top;
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.5s; filter: grayscale(0.2) contrast(1.1);
        }
        .hero-card:hover img { transform: scale(1.1); filter: grayscale(0) contrast(1.2); }

        .card-content {
            position: absolute; bottom: 0; width: 100%; padding: 1.5rem;
            background: linear-gradient(to top, rgba(2, 6, 23, 0.95) 20%, rgba(2, 6, 23, 0.6) 80%, transparent 100%);
            display: flex; flex-direction: column; justify-content: flex-end; transform: translateZ(20px); height: 50%;
        }
        .hero-name {
            font-family: "Bangers", cursive; font-size: 3rem; letter-spacing: 2px; color: #fff; line-height: 0.9;
            margin-bottom: 0.25rem; text-shadow: 0 4px 10px rgba(0, 0, 0, 0.8); transition: 0.3s; transform-origin: left;
        }
        .hero-card:hover .hero-name { transform: scale(1.05); }
        .hero-alias {
            font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.5); padding: 4px 10px; border-radius: 4px; backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1); display: inline-block;
        }
        .class-badge {
            position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; font-family: "Rajdhani"; font-weight: 700; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 1px; z-index: 25; backdrop-filter: blur(4px); transform: translateZ(30px);
        }

        /* --- MODAL (BIO) --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 1600; display: flex; align-items: center; justify-content: center;
            background: rgba(2, 6, 23, 0.6); backdrop-filter: blur(0px); transition: 0.4s; pointer-events: none; opacity: 0;
        }
        .modal-overlay.active { background: rgba(2, 6, 23, 0.85); backdrop-filter: blur(15px); pointer-events: all; opacity: 1; }

        .modal-card {
            width: min(1100px, 95%); height: min(700px, 90vh); background: rgba(15, 23, 42, 0.9); border-radius: 16px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1), 0 50px 100px -20px rgba(0, 0, 0, 0.8);
            transform: scale(0.95) translateY(20px); transition: 0.5s var(--ease-smooth); display: grid;
            grid-template-columns: 45% 55%; overflow: hidden; position: relative;
        }
        .modal-overlay.active .modal-card { transform: scale(1) translateY(0); background: rgba(15, 23, 42, 0.95); }

        .modal-col-img { position: relative; height: 100%; overflow: hidden; }
        .modal-image-full { width: 100%; height: 100%; object-fit: cover; object-position: center top; mask-image: linear-gradient(to right, black 80%, transparent 100%); }
        .modal-col-data { padding: 3rem; display: flex; flex-direction: column; background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.03), transparent 70%); overflow-y: auto; position: relative; }
        .modal-name-display {
            font-family: "Bangers"; font-size: 5rem; line-height: 0.9; margin-bottom: 0.5rem; text-transform: uppercase;
            letter-spacing: 2px; background: linear-gradient(180deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .modal-role-display { font-size: 1rem; text-transform: uppercase; letter-spacing: 4px; font-weight: 700; color: var(--theme-color); display: flex; align-items: center; gap: 1rem; }
        .modal-desc { font-size: 1.1rem; line-height: 1.7; color: #cbd5e1; margin-bottom: 2.5rem; font-weight: 300; border-left: 2px solid rgba(255, 255, 255, 0.1); padding-left: 1.5rem; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .dash-panel { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; }
        .move-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .move-name { font-weight: 600; font-size: 0.95rem; color: #e2e8f0; }
        .move-val { font-family: "Bangers"; font-size: 1.4rem; color: var(--theme-color); text-shadow: 0 0 10px currentColor; }
        .stat-row { display: flex; align-items: center; margin-bottom: 10px; }
        .stat-label { width: 90px; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-track { flex-grow: 1; height: 6px; background: rgba(255, 255, 255, 0.05); border-radius: 2px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 0%; position: relative; z-index: 1; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); }
        .fill-electric { background: #fbbf24; box-shadow: 0 0 15px #fbbf24; }
        .fill-ice { background: #22d3ee; box-shadow: 0 0 15px #22d3ee; }
        .fill-impact { background: #ef4444; box-shadow: 0 0 15px #ef4444; }

        .close-btn {
            position: absolute; top: 20px; right: 20px; font-size: 2rem; color: rgba(255, 255, 255, 0.5); cursor: pointer;
            z-index: 20; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .close-btn:hover { color: #fff; transform: rotate(90deg); }

        /* --- VILLAIN MODAL --- */
        .villain-modal-overlay {
            position: fixed; inset: 0; z-index: 1700; display: flex; align-items: center; justify-content: center;
            background: rgba(139, 0, 0, 0); backdrop-filter: blur(0px); transition: 0.4s; pointer-events: none; opacity: 0;
        }
        .villain-modal-overlay.active {
            background: rgba(20, 0, 0, 0.95); backdrop-filter: blur(20px); pointer-events: all; opacity: 1;
        }

        .villain-modal-card {
            width: min(1100px, 95%); max-height: 90vh;
            background: linear-gradient(135deg, rgba(40, 0, 0, 0.95) 0%, rgba(20, 0, 20, 0.95) 100%);
            border-radius: 16px;
            box-shadow: 0 0 0 2px rgba(220, 38, 38, 0.5), 0 0 60px rgba(220, 38, 38, 0.4), 0 50px 100px -20px rgba(0, 0, 0, 0.9);
            transform: scale(0.8) rotateX(-15deg); opacity: 0;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out;
            transform-style: preserve-3d;
            overflow: hidden;
            position: relative;
            border: 3px solid;
            border-image: repeating-linear-gradient(45deg, #dc2626 0px, #dc2626 10px, #000 10px, #000 20px) 1;
        }
        .villain-modal-overlay.active .villain-modal-card {
            transform: scale(1) rotateX(0deg); opacity: 1;
        }

        .villain-modal-header {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.3) 0%, rgba(168, 85, 247, 0.3) 100%);
            border-bottom: 2px solid rgba(220, 38, 38, 0.5);
            padding: 1rem;
            text-align: center;
        }

        .threat-label {
            font-family: "Rajdhani";
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: 6px;
            color: #fca5a5;
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.8), 0 0 40px rgba(220, 38, 38, 0.5);
            animation: dangerPulse 2s infinite;
        }

        .villain-modal-content {
            display: grid;
            grid-template-columns: 40% 60%;
            overflow-y: auto;
            max-height: calc(90vh - 80px);
        }

        .villain-col-img {
            position: relative;
            height: 100%;
            min-height: 500px;
            overflow: hidden;
            background: radial-gradient(circle at center, rgba(220, 38, 38, 0.2), transparent 70%);
        }

        .villain-modal-image-full {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            filter: brightness(0.9) contrast(1.3) saturate(1.2);
            mask-image: linear-gradient(to right, black 60%, transparent 100%);
        }

        .villain-type-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
            transform: scale(0) rotate(-180deg);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s;
        }
        .villain-modal-overlay.active .villain-type-badge {
            transform: scale(1) rotate(0deg);
        }

        .villain-col-data {
            padding: 2.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            opacity: 0;
            transform: translateX(30px);
            transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s;
        }
        .villain-modal-overlay.active .villain-col-data {
            opacity: 1;
            transform: translateX(0);
        }

        .villain-name-group {
            margin-bottom: 1rem;
        }

        .villain-name-display {
            font-family: "Bangers";
            font-size: 4rem;
            line-height: 0.9;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: linear-gradient(180deg, #fca5a5, #dc2626);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(220, 38, 38, 0.5));
        }

        .villain-type-display {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 4px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.7);
        }

        .dossier-section {
            background: rgba(0, 0, 0, 0.4);
            border-left: 3px solid rgba(220, 38, 38, 0.5);
            padding: 1.2rem;
            border-radius: 4px;
        }

        .dossier-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #fca5a5;
            font-weight: 800;
            margin-bottom: 0.8rem;
            letter-spacing: 2px;
        }

        .villain-desc {
            font-size: 1rem;
            line-height: 1.7;
            color: #cbd5e1;
            font-weight: 300;
        }

        .villain-stats-grid {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .villain-stat-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .villain-stat-label {
            width: 90px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .villain-stat-track {
            flex-grow: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .villain-stat-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #dc2626, #ef4444);
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.8);
            transition: width 1.2s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
            z-index: 1;
        }

        .villain-signature {
            font-size: 1.1rem;
            font-weight: 600;
            color: #fbbf24;
            font-style: italic;
            text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
        }

        .weakness-section {
            border-left-color: #fbbf24;
            background: rgba(251, 191, 36, 0.05);
        }

        .villain-weakness {
            font-size: 0.95rem;
            color: #fde68a;
            line-height: 1.6;
            font-weight: 500;
        }

        /* --- BATTLE ARENA MODAL --- */
        .battle-overlay {
            position: fixed; inset: 0; z-index: 1800; background: #000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .battle-overlay.active { opacity: 1; pointer-events: all; }
        
        .battle-stage {
            width: 100%; max-width: 1000px; height: 80vh; background: radial-gradient(circle at center, #1e1b4b 0%, #000 70%);
            border: 2px solid #a855f7; border-radius: 20px; box-shadow: 0 0 50px rgba(168, 85, 247, 0.3);
            display: flex; flex-direction: column; padding: 2rem; position: relative; overflow: hidden;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1); /* For Slow Mo Zoom */
        }
        /* Zoom effect class */
        .battle-stage.slow-mo { transform: scale(1.1); filter: contrast(1.2); }

        .battle-stage::before {
             content: ""; position: absolute; inset:0; 
             background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a855f7' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
             opacity: 0.5;
        }
        
        .battle-header { text-align: center; margin-bottom: 2rem; z-index: 2; }
        .battle-title { font-family: 'Bangers'; font-size: 3rem; color: #a855f7; text-shadow: 0 0 20px #a855f7; }

        .battle-area { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; z-index: 2; }
        .side { width: 300px; text-align: center; position: relative; }
        .side-img {
            width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
            transition: transform 0.2s; border-radius: 12px;
        }
        
        /* Shake Animation */
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, 0); }
            60% { transform: translate(10px, 0); }
            100% { transform: translate(0, 0); }
        }

        /* Violent Finale Shake */
        .shake-hard { animation: shakeHard 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeHard {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-20px, -20px) rotate(-5deg); }
            40% { transform: translate(20px, 20px) rotate(5deg); }
            60% { transform: translate(-20px, 20px) rotate(-5deg); }
            80% { transform: translate(20px, -20px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Damage Flash */
        .damage-flash { animation: flashRed 0.3s ease-out; }
        @keyframes flashRed {
            0% { filter: sepia(1) saturate(5) hue-rotate(-50deg) brightness(2); }
            100% { filter: none; }
        }

        .hp-bar-container {
            width: 100%; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; margin-top: 1rem;
            border: 1px solid rgba(255,255,255,0.2); overflow: hidden;
        }
        .hp-fill { height: 100%; width: 100%; transition: width 0.5s ease-out, background 0.5s ease-out; }
        .hp-villain { background: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .hp-heroes { background: #22c55e; box-shadow: 0 0 10px #22c55e; }

        .battle-log {
            margin-top: 2rem; height: 100px; background: rgba(0,0,0,0.6); border: 1px solid #a855f7; border-radius: 8px;
            padding: 1rem; font-family: 'Rajdhani'; font-size: 1.2rem; color: #fff; display: flex; align-items: center;
            justify-content: center; text-align: center; z-index: 2;
        }

        /* INITIATE BUTTON (Outside) */
        .battle-btn-initiate {
             font-family: 'Bangers'; font-size: 2.5rem; padding: 20px 60px; 
             background: linear-gradient(135deg, #9333ea, #7e22ce); color: white; border: 2px solid #d8b4fe; border-radius: 12px;
             margin-top: 20px; cursor: pointer; box-shadow: 0 0 40px rgba(168, 85, 247, 0.8);
             display: none; /* hidden until 2 selected */
             transition: 0.3s; animation: pulseBtn 1s infinite alternate;
        }
        .battle-btn-initiate:hover { transform: scale(1.05); background: #a855f7; }

        /* START COMBAT BUTTON (Inside Modal) */
        .battle-btn-commence {
             font-family: 'Bangers'; font-size: 3rem; padding: 30px 80px; 
             background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: 2px solid #86efac; border-radius: 16px;
             cursor: pointer; box-shadow: 0 0 60px rgba(34, 197, 94, 0.8);
             transition: 0.3s; z-index: 20; animation: pulseGreen 1s infinite alternate;
        }
        .battle-btn-commence:hover { transform: scale(1.05); background: #4ade80; }

        .dossier-btn {
            font-family: 'Rajdhani';
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 2px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(220, 38, 38, 0.8), rgba(153, 27, 27, 0.8));
            color: #fca5a5;
            border: 2px solid rgba(220, 38, 38, 0.5);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            margin-bottom: 10px;
            text-transform: uppercase;
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.4);
            backdrop-filter: blur(4px);
        }
        .dossier-btn:hover {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.8);
            color: #fff;
        }

        @keyframes pulseBtn { from { box-shadow: 0 0 20px #9333ea; } to { box-shadow: 0 0 50px #d8b4fe; } }
        @keyframes pulseGreen { from { box-shadow: 0 0 20px #22c55e; } to { box-shadow: 0 0 60px #86efac; } }

        /* FX */
        #flashOverlay {
            position: fixed; inset: 0; background: #fff; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.1s; mix-blend-mode: overlay;
        }
        #flashOverlay.active { opacity: 0.8; }
        
        /* Elemental Overlays for Finale */
        #elementalOverlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 1900; opacity: 0; transition: opacity 0.5s;
        }
        .overlay-ice { background: radial-gradient(circle, rgba(34, 211, 238, 0.3) 0%, transparent 80%); }
        .overlay-electric { background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 80%); }
        .overlay-impact { background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 80%); }

        #particleContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; overflow: hidden; }
        .particle { position: absolute; border-radius: 50%; animation: burstOut 0.8s ease-out forwards; }
        @keyframes burstOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        /* TIER BADGES */
        .tier-badge {
            display: inline-block;
            font-family: 'Rajdhani';
            font-size: 0.85rem;
            font-weight: 800;
            letter-spacing: 2px;
            padding: 4px 12px;
            border-radius: 4px;
            margin: 8px 0;
            text-transform: uppercase;
            border: 2px solid currentColor;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .tier-elite {
            animation: elitePulse 1s infinite alternate;
        }

        @keyframes elitePulse {
            from { transform: scale(1); }
            to { transform: scale(1.05); }
        }

        /* ABILITY VISUAL EFFECTS */
        .ability-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Bangers';
            font-size: 2rem;
            color: #fbbf24;
            text-shadow: 0 0 20px currentColor;
            z-index: 50;
            pointer-events: none;
            animation: abilityPop 0.8s ease-out forwards;
        }

        @keyframes abilityPop {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            100% { opacity: 0; transform: translate(-50%, -80%) scale(1); }
        }

        /* STUN EFFECT */
        .stunned {
            filter: brightness(0.5) saturate(0.3);
            position: relative;
        }

        .stun-stars {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2rem;
            animation: spinStars 2s linear infinite;
        }

        @keyframes spinStars {
            from { transform: translateX(-50%) rotate(0deg); }
            to { transform: translateX(-50%) rotate(360deg); }
        }

        /* EVASION EFFECT */
        .evading {
            opacity: 0.3;
            filter: blur(2px);
            animation: phaseShift 0.5s ease-in-out;
        }

        @keyframes phaseShift {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.1; }
        }

        /* ARMOR EFFECT */
        .armor-flash {
            animation: armorSparks 0.3s ease-out;
        }

        @keyframes armorSparks {
            0% { filter: brightness(2) saturate(2); }
            100% { filter: none; }
        }

        /* REGENERATE EFFECT */
        .regenerating {
            animation: healPulse 0.8s ease-out;
        }

        @keyframes healPulse {
            0% { filter: brightness(1.5) saturate(1.5) hue-rotate(90deg); }
            100% { filter: none; }
        }

        /* FLOATING TEXT FOR ABILITIES */
        .floating-text {
            position: absolute;
            font-family: 'Rajdhani';
            font-weight: 800;
            font-size: 1.2rem;
            pointer-events: none;
            z-index: 100;
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-80px); }
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .modal-card { grid-template-columns: 1fr; height: auto; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
            .modal-col-img { height: 250px; flex-shrink: 0; mask-image: none; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
            .modal-col-data { padding: 1.5rem; overflow: visible; }
            .modal-name-display { font-size: 3rem; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 1rem; }
            .battle-area { flex-direction: column; gap: 20px; }
        }
        @keyframes fadeSlideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>

<body>

    <div class="space-bg">
        <div class="stars"></div>
        <div class="stars md"></div>
        <div class="nebula-layer"></div>
    </div>
    <div class="grid-overlay"></div>
    <div id="flashOverlay"></div>
    <div id="elementalOverlay"></div>
    <div id="particleContainer"></div>

    <div class="app">
        <header>
            <h1>Hawthorn <span style="color:#fbbf24; text-shadow: 0 0 30px #fbbf24;">Superheroes</span></h1>
            <div class="subtitle">Platinum Edition</div>
        </header>

        <div class="controls-bar">
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterGrid('all', this)" style="--active-color:#fff">All</button>
                <button class="filter-btn" onclick="filterGrid('electric', this)" style="--active-color:#fbbf24">Electric</button>
                <button class="filter-btn" onclick="filterGrid('ice', this)" style="--active-color:#22d3ee">Ice</button>
                <button class="filter-btn" onclick="filterGrid('impact', this)" style="--active-color:#ef4444">Impact</button>
            </div>
            <div class="filter-group">
                 <button class="filter-btn battle-btn" id="muddlewickBtn" onclick="toggleBattleMode()">üßô‚Äç‚ôÇÔ∏è Muddlewick has Chosen</button>
            </div>
        </div>
        
        <div id="battleInstructions" style="text-align:center; margin-bottom:1rem; color:#a855f7; font-weight:bold; display:none; text-transform:uppercase; letter-spacing:2px; animation:fadeSlideDown 0.5s forwards;">
             <div id="selectText" style="margin-bottom: 20px; font-size: 1.2rem;">Select 2 Heroes to Fight!</div>
             <button id="startFightBtn" class="battle-btn-initiate" onclick="openBattleArena()">INITIATE BATTLE</button>
        </div>

        <div id="heroGrid" class="hero-grid"></div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
        <div id="modalCard" class="modal-card" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeModal()">√ó</div>
            <div class="modal-col-img">
                <img id="modalImage" class="modal-image-full">
                <div id="modalTypeBadge" class="modal-type-badge"
                    style="position:absolute; top:30px; left:30px; width:70px; height:70px; border-radius:12px; background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.2); color:#fff; display:flex; align-items:center; justify-content:center; font-size:2.5rem; backdrop-filter:blur(10px); z-index:5; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                </div>
            </div>
            <div class="modal-col-data">
                <div class="modal-header-group">
                    <div id="modalName" class="modal-name-display"></div>
                    <div id="modalRole" class="modal-role-display"></div>
                </div>
                <p id="modalDescription" class="modal-desc"></p>
                <div class="dashboard-grid">
                    <div class="dash-panel">
                        <div class="panel-label" style="font-size:0.7rem; text-transform:uppercase; color:#64748b; font-weight:800; margin-bottom:1.2rem; letter-spacing:2px; display:flex; justify-content:space-between;">
                            <span>Signature Moves</span> <span>PWR</span></div>
                        <div id="modalMoves"></div>
                    </div>
                    <div class="dash-panel">
                        <div class="panel-label" style="font-size:0.7rem; text-transform:uppercase; color:#64748b; font-weight:800; margin-bottom:1.2rem; letter-spacing:2px; display:flex; justify-content:space-between;">
                            <span>Attributes</span> <span>LVL</span></div>
                        <div id="modalStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VILLAIN DOSSIER MODAL -->
    <div id="villainModalOverlay" class="villain-modal-overlay" onclick="closeVillainModal()">
        <div id="villainModalCard" class="villain-modal-card" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeVillainModal()">√ó</div>

            <div class="villain-modal-header">
                <div class="threat-label">‚ö†Ô∏è THREAT ASSESSMENT ‚ö†Ô∏è</div>
            </div>

            <div class="villain-modal-content">
                <div class="villain-col-img">
                    <img id="villainModalImage" class="villain-modal-image-full">
                    <div id="villainModalTypeBadge" class="villain-type-badge"></div>
                </div>

                <div class="villain-col-data">
                    <div class="villain-name-group">
                        <div id="villainModalName" class="villain-name-display"></div>
                        <div id="villainModalType" class="villain-type-display"></div>
                    </div>

                    <div class="dossier-section">
                        <div class="dossier-label">THREAT PROFILE</div>
                        <p id="villainModalDescription" class="villain-desc"></p>
                    </div>

                    <div class="dossier-section">
                        <div class="dossier-label">COMBAT ANALYSIS</div>
                        <div id="villainModalStats" class="villain-stats-grid"></div>
                    </div>

                    <div class="dossier-section">
                        <div class="dossier-label">SIGNATURE TECHNIQUE</div>
                        <div id="villainModalSignature" class="villain-signature"></div>
                    </div>

                    <div class="dossier-section weakness-section">
                        <div class="dossier-label">‚ö†Ô∏è TACTICAL WEAKNESS</div>
                        <div id="villainModalWeakness" class="villain-weakness"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="battleOverlay" class="battle-overlay">
         <div class="battle-stage" id="battleStage">
              <div class="close-btn" onclick="closeBattle()">√ó</div>
              
              <div id="combatStartOverlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:100; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px);">
                  <button class="battle-btn-commence" onclick="beginCombatSequence()">START COMBAT</button>
              </div>

              <div class="battle-header">
                   <div class="battle-title" id="battleTitle">BOSS BATTLE</div>
              </div>
              
              <div class="battle-area">
                   <div class="side" id="villainSide">
                        <h2 style="color:#a855f7; font-family:'Bangers'; letter-spacing:2px; margin-bottom:10px;" id="villainName">Baddie</h2>
                        <button id="viewDossierBtn" class="dossier-btn" onclick="openVillainModal(currentVillain)">
                            üìã VIEW DOSSIER
                        </button>
                        <img id="villainImg" class="side-img" src="">
                        <div class="hp-bar-container">
                             <div id="villainHP" class="hp-fill hp-villain"></div>
                        </div>
                   </div>
                   
                   <div style="font-family:'Bangers'; font-size:4rem; color:#fff; text-shadow:0 0 20px white;">VS</div>
                   
                   <div class="side" id="heroesSide">
                        <h2 style="color:#22c55e; font-family:'Bangers'; letter-spacing:2px; margin-bottom:10px;">The Heroes</h2>
                        <div style="display:flex; justify-content:center; gap:10px;">
                             <img id="hero1Img" class="side-img" style="width:100px; height:100px;" src="">
                             <img id="hero2Img" class="side-img" style="width:100px; height:100px;" src="">
                        </div>
                        <div class="hp-bar-container">
                             <div id="heroesHP" class="hp-fill hp-heroes"></div>
                        </div>
                   </div>
              </div>
              
              <div class="battle-log">
                   <span id="battleText">Waiting for command...</span>
              </div>
         </div>
    </div>

    <script>
        /* HERO DATA */
        const heroes = [
            { id: "art", type: "electric", icon: "‚ö°", role: "Speedster Class", name: "Art", alias: "Velocity", image: "images/art.png", description: "Known as the fastest kid alive, Art can circumvent the globe before his toast pops up.", moves: [{ name: "Hypersonic Sprint", pwr: 94 }, { name: "Vertical Wall Run", pwr: 75 }, { name: "Vacuum Funnel", pwr: 88 }], stats: { bravery: 4, speed: 5, strength: 3, teamwork: 4, focus: 5 } },
            { id: "alexei", type: "electric", icon: "‚ö°", role: "Tech Artificer", name: "Alexei", alias: "Magnet Master", image: "images/alexei.png", description: "A mechanical prodigy with a magnetic personality. Alexei can sense the atomic structure of any metal nearby.", moves: [{ name: "Magnetic Crush", pwr: 90 }, { name: "Scrap Shield", pwr: 85 }, { name: "Tech Disruption", pwr: 70 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 5 } },
            { id: "florrie", type: "ice", icon: "‚ùÑÔ∏è", role: "Cryomancer", name: "Florrie", alias: "Frostbeam", image: "images/florrie.png", description: "With a single touch, Florrie can lower the temperature of a room to absolute zero.", moves: [{ name: "Flash Freeze", pwr: 88 }, { name: "Glacial Wall", pwr: 92 }, { name: "Ice Slide", pwr: 65 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 4 } },
            { id: "joshua", type: "impact", icon: "üí•", role: "Guardian Tank", name: "Joshua", alias: "Shield Guardian", image: "images/joshua.png", description: "The unbreakable heart of the team, Joshua wields a shield made of pure kinetic energy.", moves: [{ name: "Titan Charge", pwr: 95 }, { name: "Energy Reflect", pwr: 85 }, { name: "Shield Bash", pwr: 80 }], stats: { bravery: 5, speed: 3, strength: 4, teamwork: 5, focus: 3 } },
            { id: "lulu", type: "electric", icon: "‚ö°", role: "Speed Striker", name: "Lulu", alias: "Red Comet", image: "images/lulu.png", description: "Lulu vibrates at such a high frequency that he appears as a red blur. Specializing in stealth.", moves: [{ name: "Mach-1 Strike", pwr: 93 }, { name: "Red Blur", pwr: 82 }, { name: "After-Image", pwr: 70 }], stats: { bravery: 5, speed: 5, strength: 3, teamwork: 5, focus: 4 } },
            { id: "manny", type: "impact", icon: "üí•", role: "Heavy Hitter", name: "Manny", alias: "Earth Hammer", image: "images/manny.png", description: "Manny is connected to the very core of the planet, allowing him to channel seismic energy through his fists.", moves: [{ name: "Seismic Slam", pwr: 96 }, { name: "Tremor Wave", pwr: 85 }, { name: "Fortify", pwr: 90 }], stats: { bravery: 5, speed: 2, strength: 5, teamwork: 5, focus: 3 } },
            { id: "maurits", type: "ice", icon: "‚ùÑÔ∏è", role: "Storm Mage", name: "Maurits", alias: "Storm Caller", image: "images/maurits.png", description: "Maurits commands the atmosphere itself, summoning rain, wind, and lightning at will.", moves: [{ name: "Lightning Bolt", pwr: 94 }, { name: "Blizzard Howl", pwr: 88 }, { name: "Fog Cover", pwr: 60 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 5 } },
            { id: "noa", type: "impact", icon: "üí•", role: "Sniper Scout", name: "Noa", alias: "Sky Archer", image: "images/noa.png", description: "Possessing telescopic vision and unerring accuracy, Noa can spot a danger from three miles away.", moves: [{ name: "Sure Shot", pwr: 95 }, { name: "Eagle Eye", pwr: 50 }, { name: "Ricochet Arrow", pwr: 82 }], stats: { bravery: 4, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "noah", type: "ice", icon: "‚ùÑÔ∏è", role: "Sonic Controller", name: "Noah", alias: "Soundwave", image: "images/noah.png", description: "Noah sees the world in frequencies and vibrations. She can create absolute silence or unleash a sonic boom.", moves: [{ name: "Sonic Boom", pwr: 91 }, { name: "Silence Bubble", pwr: 70 }, { name: "Echo Pulse", pwr: 85 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 4 } },
            { id: "phaedra", type: "ice", icon: "‚ùÑÔ∏è", role: "Wind Dancer", name: "Phaedra", alias: "Whirlwind", image: "images/phaedra.png", description: "Phaedra dances on the air currents, moving with a grace that defies gravity.", moves: [{ name: "Tornado Spin", pwr: 96 }, { name: "Hurricane Blast", pwr: 92 }, { name: "Air Cushion", pwr: 82 }], stats: { bravery: 4, speed: 5, strength: 3, teamwork: 5, focus: 5 } },
            { id: "rex", type: "electric", icon: "‚ö°", role: "Trickster", name: "Rex", alias: "Triple Strike", image: "images/rex.png", description: "Rex exists in three places at once, splitting into temporal clones to overwhelm opponents.", moves: [{ name: "Tri-Attack", pwr: 92 }, { name: "Clone Swap", pwr: 75 }, { name: "Confusion", pwr: 65 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 3 } },
            { id: "rory", type: "impact", icon: "üí•", role: "Duelist", name: "Rory", alias: "Blue Flash", image: "images/rory.png", description: "Rory wields twin blades made of solidified plasma that can cut through any material.", moves: [{ name: "Blade Dance", pwr: 93 }, { name: "Cross Slash", pwr: 88 }, { name: "Flash Cut", pwr: 90 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "viola", type: "impact", icon: "üí•", role: "Blade Master", name: "Viola", alias: "Twin Saber", image: "images/viola.png", description: "Viola turns combat into an art form, using her twin energy sabers to deflect incoming projectiles.", moves: [{ name: "Saber Deflect", pwr: 94 }, { name: "Twin Strike", pwr: 89 }, { name: "Pushback", pwr: 80 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "wilbur", type: "impact", icon: "üí•", role: "Titan", name: "Wilbur", alias: "Titan Punch", image: "images/wilbur.png", description: "Possessing the strength of a hundred men, Wilbur is the team's muscle.", moves: [{ name: "Mega Punch", pwr: 98 }, { name: "Ground Breaker", pwr: 92 }, { name: "Atlas Lift", pwr: 85 }], stats: { bravery: 5, speed: 3, strength: 5, teamwork: 5, focus: 4 } },
            { id: "zane", type: "electric", icon: "‚ö°", role: "Technomancer", name: "Zane", alias: "Storm Pulse", image: "images/zane.png", description: "Zane is a living battery, crackling with raw static electricity.", moves: [{ name: "Overload", pwr: 95 }, { name: "Static Shock", pwr: 85 }, { name: "EMP Blast", pwr: 90 }], stats: { bravery: 5, speed: 5, strength: 3, teamwork: 5, focus: 4 } }
        ];
        heroes.sort((a, b) => a.name.localeCompare(b.name));

        const villains = [
             {
                name: "Neon Tiger",
                type: "electric",
                img: "images/tiger.png",
                move: "Razor Slash",
                description: "A genetically enhanced predator escaped from a secret lab. Covered in bioluminescent stripes that crackle with stolen electricity. Hunts with terrifying speed and precision.",
                stats: { danger: 4, speed: 5, cunning: 4, power: 4 },
                weakness: "Impact-type heroes can overpower its agility with raw force",
                signature: "Lightning-fast slashes that leave electrical burns",
                ability: "double_strike",
                abilityName: "Lightning Reflexes",
                abilityDesc: "30% chance to attack twice in one turn",
                abilityChance: 0.3
             },
             {
                name: "Cyber Grizzly",
                type: "impact",
                img: "images/bear.png",
                move: "Crushing Maul",
                description: "A robotic beast built from scrapped military hardware. Its crushing strength can flatten cars like tin cans. Nearly unstoppable once it begins its rampage.",
                stats: { danger: 5, speed: 2, cunning: 2, power: 5 },
                weakness: "Electric-type heroes can short-circuit its systems",
                signature: "Devastating ground pounds that create shockwaves",
                ability: "armor",
                abilityName: "Steel Plating",
                abilityDesc: "Takes 25% reduced damage from all attacks",
                damageReduction: 0.25
             },
             {
                name: "Shadow Panther",
                type: "ice",
                img: "images/panthers.png",
                move: "Silent Strike",
                description: "A spectral feline that phases between dimensions. Leaves trails of freezing mist wherever it stalks. You never see it coming until it's too late.",
                stats: { danger: 4, speed: 4, cunning: 5, power: 3 },
                weakness: "Ice-type heroes can freeze it in one dimension",
                signature: "Dimensional ambushes from impossible angles",
                ability: "evasion",
                abilityName: "Phase Shift",
                abilityDesc: "40% chance to completely dodge any attack",
                abilityChance: 0.4
             },
             {
                name: "Thunder Gorilla",
                type: "electric",
                img: "images/gorilla.png",
                move: "Seismic Smash",
                description: "An ancient primate awakened by a lightning strike. Channels storm energy through its massive fists. Each roar summons thunder from the skies.",
                stats: { danger: 5, speed: 3, cunning: 3, power: 5 },
                weakness: "Impact-type heroes can match its brute strength",
                signature: "Thunder-charged punches that shake the earth",
                ability: "stun",
                abilityName: "Thunderclap Stun",
                abilityDesc: "25% chance attacks stun a hero, skipping their next turn",
                abilityChance: 0.25
             },
             {
                name: "Omega Droid",
                type: "impact",
                img: "images/robot.png",
                move: "Plasma Beam",
                description: "The final creation of a mad inventor. Cold, calculating, and programmed only to destroy. Its targeting systems never miss their mark.",
                stats: { danger: 5, speed: 3, cunning: 4, power: 5 },
                weakness: "Electric-type heroes can overload its circuits",
                signature: "Precision plasma blasts that pierce through defenses",
                ability: "regenerate",
                abilityName: "Self-Repair Protocol",
                abilityDesc: "Regenerates 8 HP at the start of each turn",
                healAmount: 8
             }
        ];

        /* --- AUDIO ENGINE & MUSIC SYNTH --- */
        const AudioEngine = {
            ctx: null,
            interval: null,
            init: function () { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },

            playTone: function(freq, type, duration) {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },

            // Soft "Cinematic Heartbeat" Music Generator
            startMusic: function() {
                if(!this.ctx) this.init();
                if(this.interval) return;
                
                this.ctx.resume();
                let beat = 0;
                const tempo = 600; 
                
                this.interval = setInterval(() => {
                    const t = this.ctx.currentTime;
                    // KICK DRUM
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.frequency.setValueAtTime(100, t);
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                    osc.start(t); osc.stop(t + 0.5);

                    // BASS
                    if(beat % 2 !== 0) {
                        const bassOsc = this.ctx.createOscillator();
                        const bassGain = this.ctx.createGain();
                        bassOsc.type = 'sine';
                        bassOsc.connect(bassGain); bassGain.connect(this.ctx.destination);
                        bassOsc.frequency.setValueAtTime(50, t); 
                        bassOsc.frequency.linearRampToValueAtTime(40, t + 0.4);
                        bassGain.gain.setValueAtTime(0.1, t);
                        bassGain.gain.linearRampToValueAtTime(0, t + 0.5);
                        bassOsc.start(t); bassOsc.stop(t + 0.5);
                    }
                    beat++;
                }, tempo);
            },

            stopMusic: function() {
                if(this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            },

            hitSound: function() {
                if(!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            }
        };

        // Auto-Init Audio
        document.addEventListener('click', () => { AudioEngine.init(); }, { once: true });

        /* --- BATTLE LOGIC --- */
        let isBattleSelecting = false;
        let isBattleActive = false; 
        let selectedHeroes = [];
        let currentVillain = null;

        // BATTLE STATE
        let currentHeroHP = 100;
        let currentVillainHP = 100;
        let currentVillainTier = 'boss'; // miniboss, boss, elite
        let stunnedHeroes = { hero1: false, hero2: false }; // Track stun status

        /* --- VILLAIN PHASE SYSTEM --- */
        const VillainPhaseSystem = {
            currentPhase: 1,

            reset: function() {
                this.currentPhase = 1;
            },

            checkPhaseTransition: function(oldHP, newHP) {
                // Check Phase 2 (50% threshold)
                if(oldHP > 50 && newHP <= 50 && this.currentPhase === 1) {
                    return 2;
                }
                // Check Phase 3 (25% threshold)
                if(oldHP > 25 && newHP <= 25 && this.currentPhase === 2) {
                    return 3;
                }
                return null; // No transition
            },

            async triggerPhaseTransition(phase, villainName) {
                this.currentPhase = phase;
                const stage = document.getElementById('battleStage');
                const vImg = document.getElementById('villainImg');
                const log = document.getElementById('battleText');

                if(phase === 2) {
                    // Phase 2 Animation
                    log.innerText = `${villainName} howls with rage - Phase 2 begins!`;
                    AudioEngine.playTone(200, 'sawtooth', 0.5);
                    stage.classList.add('slow-mo');
                    stage.classList.add('shake');

                    // Orange aura
                    vImg.style.filter = 'drop-shadow(0 0 20px rgba(255,255,255,0.2)) drop-shadow(0 0 40px orange)';
                    vImg.style.transform = 'scale(1.1)';

                    await delay(1500);
                    stage.classList.remove('slow-mo', 'shake');

                } else if(phase === 3) {
                    // Phase 3 Animation
                    log.innerText = `${villainName} is critically wounded - FINAL PHASE!`;
                    AudioEngine.playTone(100, 'sawtooth', 0.8);

                    const flash = document.getElementById('flashOverlay');
                    flash.classList.add('active');
                    setTimeout(() => flash.classList.remove('active'), 100);

                    stage.classList.add('slow-mo');
                    stage.classList.add('shake-hard');

                    // Red crackling energy
                    vImg.style.filter = 'drop-shadow(0 0 20px rgba(255,255,255,0.2)) drop-shadow(0 0 60px #ef4444) brightness(1.2)';
                    vImg.style.transform = 'scale(1.15)';
                    vImg.style.animation = 'dangerPulse 0.5s infinite';

                    // Darken screen edges
                    const overlay = document.getElementById('elementalOverlay');
                    overlay.style.background = 'radial-gradient(circle, transparent 30%, rgba(139, 0, 0, 0.5) 100%)';
                    overlay.style.opacity = 1;

                    await delay(2000);
                    stage.classList.remove('slow-mo', 'shake-hard');
                }
            },

            getAbilityModifier: function() {
                // Phase 2: +15%, Phase 3: +30%
                if(this.currentPhase === 2) return 0.15;
                if(this.currentPhase === 3) return 0.30;
                return 0;
            },

            getDamageModifier: function() {
                // Phase 3 increases damage by 25%
                if(this.currentPhase === 3) return 1.25;
                return 1.0;
            }
        };

        /* --- VILLAIN TIER SYSTEM --- */
        function selectVillainTier() {
            const roll = Math.random();
            if(roll < 0.3) return 'miniboss';  // 30%
            if(roll < 0.8) return 'boss';       // 50%
            return 'elite';                     // 20%
        }

        function getTierMultipliers(tier) {
            const tiers = {
                miniboss: {
                    hp: 80,
                    damageMultiplier: 0.8,
                    abilityMultiplier: 0.8,
                    xpMultiplier: 0.75,
                    badge: 'MINIBOSS',
                    badgeColor: '#cd7f32', // Bronze
                    badgeGlow: 'rgba(205, 127, 50, 0.6)'
                },
                boss: {
                    hp: 100,
                    damageMultiplier: 1.0,
                    abilityMultiplier: 1.0,
                    xpMultiplier: 1.0,
                    badge: 'BOSS',
                    badgeColor: '#c0c0c0', // Silver
                    badgeGlow: 'rgba(192, 192, 192, 0.6)'
                },
                elite: {
                    hp: 130,
                    damageMultiplier: 1.3,
                    abilityMultiplier: 1.2,
                    xpMultiplier: 1.5,
                    badge: 'ELITE',
                    badgeColor: '#ffd700', // Gold
                    badgeGlow: 'rgba(255, 215, 0, 0.8)'
                }
            };
            return tiers[tier];
        }

        function toggleBattleMode() {
            AudioEngine.playTone(400, 'sine', 0.1);
            const btn = document.getElementById('muddlewickBtn');
            const instructions = document.getElementById('battleInstructions');
            const selectTxt = document.getElementById('selectText');
            
            isBattleSelecting = !isBattleSelecting;
            selectedHeroes = [];
            document.querySelectorAll('.hero-card').forEach(c => {
                 c.classList.remove('selected', 'dimmed');
            });
            document.getElementById('startFightBtn').style.display = 'none';
            selectTxt.innerText = "Select 2 Heroes to Fight!";
            selectTxt.style.color = "#a855f7";

            if(isBattleSelecting) {
                 btn.classList.add('active');
                 btn.innerText = "Cancel Challenge";
                 instructions.style.display = 'block';
                 document.querySelectorAll('.hero-card').forEach(c => c.classList.add('dimmed'));
            } else {
                 btn.classList.remove('active');
                 btn.innerText = "üßô‚Äç‚ôÇÔ∏è Muddlewick has Chosen";
                 instructions.style.display = 'none';
                 document.querySelectorAll('.hero-card').forEach(c => c.classList.remove('dimmed'));
            }
        }

        function handleBattleSelection(id) {
             const card = document.getElementById(`card-${id}`);
             const startBtn = document.getElementById('startFightBtn');
             const selectTxt = document.getElementById('selectText');
             
             if(selectedHeroes.includes(id)) {
                  AudioEngine.playTone(200, 'sine', 0.1);
                  selectedHeroes = selectedHeroes.filter(h => h !== id);
                  card.classList.remove('selected');
                  card.classList.add('dimmed');
             } else {
                  if(selectedHeroes.length < 2) {
                       AudioEngine.playTone(600, 'sine', 0.1);
                       selectedHeroes.push(id);
                       card.classList.add('selected');
                       card.classList.remove('dimmed');
                  }
             }

             if(selectedHeroes.length === 2) {
                  startBtn.style.display = 'inline-block';
                  selectTxt.innerText = "TEAM READY!";
                  selectTxt.style.color = "#4ade80"; 
                  document.querySelectorAll('.hero-card:not(.selected)').forEach(c => c.classList.add('dimmed'));
             } else {
                  startBtn.style.display = 'none';
                  selectTxt.innerText = "Select 2 Heroes to Fight!";
                  selectTxt.style.color = "#a855f7"; 
             }
        }

        function openBattleArena() {
             AudioEngine.playTone(800, 'sine', 0.3);

             currentVillain = villains[Math.floor(Math.random() * villains.length)];

             // SELECT TIER AND APPLY MODIFIERS
             currentVillainTier = selectVillainTier();
             const tierData = getTierMultipliers(currentVillainTier);

             document.getElementById('villainName').innerText = currentVillain.name;
             document.getElementById('villainImg').src = currentVillain.img;

             const hero1 = heroes.find(h => h.id === selectedHeroes[0]);
             const hero2 = heroes.find(h => h.id === selectedHeroes[1]);

             document.getElementById('hero1Img').src = hero1.image;
             document.getElementById('hero2Img').src = hero2.image;

             // RESET HEALTH (Use tier HP)
             currentHeroHP = 100;
             currentVillainHP = tierData.hp;
             updateHealthUI('villain', 100); // Always show 100% visually
             updateHealthUI('heroes', 100);

             // RESET PHASE SYSTEM
             VillainPhaseSystem.reset();

             // RESET STUN STATUS
             stunnedHeroes = { hero1: false, hero2: false };

             // RESET VILLAIN IMAGE EFFECTS
             const vImg = document.getElementById('villainImg');
             vImg.style.filter = 'drop-shadow(0 0 20px rgba(255,255,255,0.2))';
             vImg.style.transform = 'scale(1)';
             vImg.style.animation = '';

             // ADD TIER BADGE
             let tierBadgeHTML = '';
             if(currentVillainTier === 'elite') {
                 tierBadgeHTML = `<div class="tier-badge tier-elite" style="color:${tierData.badgeColor}; box-shadow: 0 0 20px ${tierData.badgeGlow};">üî• ${tierData.badge} üî•</div>`;
                 // Elite visual: glowing red eyes effect
                 vImg.style.filter = 'drop-shadow(0 0 20px rgba(255,255,255,0.2)) drop-shadow(0 0 30px rgba(255, 0, 0, 0.4)) brightness(0.9) saturate(1.3)';
             } else {
                 tierBadgeHTML = `<div class="tier-badge tier-${currentVillainTier}" style="color:${tierData.badgeColor}; box-shadow: 0 0 15px ${tierData.badgeGlow};">${tierData.badge}</div>`;
             }

             // Insert tier badge next to villain name
             const villainSide = document.getElementById('villainSide');
             const existingBadge = villainSide.querySelector('.tier-badge');
             if(existingBadge) existingBadge.remove();

             const nameEl = villainSide.querySelector('h2');
             nameEl.insertAdjacentHTML('afterend', tierBadgeHTML);

             document.getElementById('battleText').innerText = "Waiting for command...";
             document.getElementById('battleStage').classList.remove('slow-mo', 'shake-hard');

             // Reset Overlays
             const elOverlay = document.getElementById('elementalOverlay');
             elOverlay.className = '';
             elOverlay.style.opacity = 0;
             elOverlay.style.background = '';

             document.getElementById('combatStartOverlay').style.display = 'flex';
             document.getElementById('battleOverlay').classList.add('active');
        }

        function updateHealthUI(side, pct) {
            const bar = document.getElementById(side === 'villain' ? 'villainHP' : 'heroesHP');
            bar.style.width = pct + '%';
            if(pct > 60) bar.style.background = side === 'villain' ? '#ef4444' : '#22c55e'; // Green/Red
            else if(pct > 30) bar.style.background = 'orange';
            else bar.style.background = '#dc2626'; // Deep Red
        }

        function beginCombatSequence() {
             document.getElementById('combatStartOverlay').style.display = 'none';
             isBattleActive = true;
             AudioEngine.startMusic();
             
             const hero1 = heroes.find(h => h.id === selectedHeroes[0]);
             const hero2 = heroes.find(h => h.id === selectedHeroes[1]);
             
             runDynamicBattle(hero1, hero2);
        }
        
        function closeBattle() {
             isBattleActive = false;
             AudioEngine.stopMusic();
             document.getElementById('battleOverlay').classList.remove('active');
             toggleBattleMode(); 
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));

        function hitEffect(element) {
            element.classList.add('shake');
            element.classList.add('damage-flash');
            AudioEngine.hitSound();
            setTimeout(() => {
                element.classList.remove('shake');
                element.classList.remove('damage-flash');
            }, 500);
        }

        /* --- ABILITY VISUAL EFFECTS --- */
        function showFloatingText(element, text, color = '#fbbf24') {
            const rect = element.getBoundingClientRect();
            const stage = document.getElementById('battleStage');
            const stageRect = stage.getBoundingClientRect();

            const floater = document.createElement('div');
            floater.className = 'floating-text';
            floater.textContent = text;
            floater.style.color = color;
            floater.style.left = (rect.left + rect.width/2 - stageRect.left) + 'px';
            floater.style.top = (rect.top - stageRect.top) + 'px';

            stage.appendChild(floater);
            setTimeout(() => floater.remove(), 1500);
        }

        function showStunEffect(element) {
            element.classList.add('stunned');
            const stars = document.createElement('div');
            stars.className = 'stun-stars';
            stars.textContent = '‚≠ê‚ú®‚≠ê';
            element.parentElement.style.position = 'relative';
            element.parentElement.appendChild(stars);

            setTimeout(() => {
                element.classList.remove('stunned');
                stars.remove();
            }, 2000);
        }

        function showEvasionEffect(element) {
            element.classList.add('evading');
            AudioEngine.playTone(800, 'sine', 0.2);
            setTimeout(() => element.classList.remove('evading'), 500);
        }

        function showArmorEffect(element) {
            element.classList.add('armor-flash');
            // Create metallic spark particles
            const colors = ['#c0c0c0', '#fff', '#a0a0a0'];
            for(let i = 0; i < 8; i++) {
                const spark = document.createElement('div');
                spark.style.cssText = `
                    position: absolute;
                    width: 4px;
                    height: 4px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    border-radius: 50%;
                    left: 50%;
                    top: 50%;
                `;
                const angle = (Math.PI * 2 * i) / 8;
                const distance = 30 + Math.random() * 20;
                element.parentElement.appendChild(spark);

                setTimeout(() => {
                    spark.style.transition = 'all 0.5s ease-out';
                    spark.style.transform = `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                    spark.style.opacity = '0';
                }, 10);

                setTimeout(() => spark.remove(), 600);
            }
            setTimeout(() => element.classList.remove('armor-flash'), 300);
        }

        function showRegenerateEffect(element) {
            element.classList.add('regenerating');
            // Create healing particles
            const colors = ['#4ade80', '#86efac', '#22c55e'];
            for(let i = 0; i < 12; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.style.cssText = `
                        position: absolute;
                        width: 6px;
                        height: 6px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: 50%;
                        left: ${30 + Math.random() * 40}%;
                        bottom: 0;
                        box-shadow: 0 0 10px currentColor;
                    `;
                    element.parentElement.appendChild(particle);

                    setTimeout(() => {
                        particle.style.transition = 'all 1s ease-out';
                        particle.style.transform = 'translateY(-100px)';
                        particle.style.opacity = '0';
                    }, 10);

                    setTimeout(() => particle.remove(), 1100);
                }, i * 50);
            }
            setTimeout(() => element.classList.remove('regenerating'), 800);
        }

        function showDoubleStrikeEffect(element) {
            const afterimage = element.cloneNode(true);
            afterimage.style.cssText = `
                position: absolute;
                left: ${element.offsetLeft}px;
                top: ${element.offsetTop}px;
                width: ${element.offsetWidth}px;
                height: ${element.offsetHeight}px;
                opacity: 0.5;
                filter: hue-rotate(60deg) brightness(1.5);
                pointer-events: none;
            `;
            element.parentElement.appendChild(afterimage);

            setTimeout(() => {
                afterimage.style.transition = 'all 0.4s ease-out';
                afterimage.style.transform = 'translateX(20px)';
                afterimage.style.opacity = '0';
            }, 10);

            setTimeout(() => afterimage.remove(), 450);
        }

        /* --- ELEMENTAL FINALE LOGIC --- */
        function triggerElementalFinale(type) {
            const overlay = document.getElementById('elementalOverlay');
            const stage = document.getElementById('battleStage');
            
            // Set Overlay
            if(type === 'electric') overlay.className = 'overlay-electric';
            if(type === 'ice') overlay.className = 'overlay-ice';
            if(type === 'impact') overlay.className = 'overlay-impact';
            
            // Trigger Effects
            overlay.style.opacity = 1;
            stage.classList.add('shake-hard');
            AudioEngine.playTone(150, 'sawtooth', 0.8); // Big crash sound
            
            // Massive Particles
            createMegaBurst(type);
            setTimeout(() => createMegaBurst(type), 200);
            setTimeout(() => createMegaBurst(type), 400);

            // Cleanup
            setTimeout(() => {
                overlay.style.opacity = 0;
                stage.classList.remove('shake-hard');
            }, 1000);
        }

        /* --- DYNAMIC BATTLE ENGINE --- */
        async function runDynamicBattle(h1, h2) {
            const log = document.getElementById('battleText');
            const vImg = document.getElementById('villainImg');
            const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
            const stage = document.getElementById('battleStage');

            // Get tier multipliers
            const tierData = getTierMultipliers(currentVillainTier);
            const maxVillainHP = tierData.hp;

            // 1. Determine Winner (70% Heroes Win)
            const heroesWin = Math.random() < 0.7;

            // 2. Setup Moves Helpers
            const getStandardMove = (h) => h.moves[0] || h.moves[1];
            const getUltimateMove = (h) => h.moves.reduce((prev, current) => (prev.pwr > current.pwr) ? prev : current);

            log.innerText = `Muddlewick summons a ${currentVillain.name}!`;
            await delay(2000); if(!isBattleActive) return;

            // 3. GENERATE BATTLE SEQUENCE (6-8 Turns)
            const totalTurns = Math.floor(Math.random() * 3) + 6;

            for(let i = 0; i < totalTurns; i++) {
                if(!isBattleActive) return;

                // VILLAIN REGENERATION at start of turn
                if(currentVillain.ability === 'regenerate') {
                    const healAmount = currentVillain.healAmount;
                    const oldHP = currentVillainHP;
                    currentVillainHP = Math.min(maxVillainHP, currentVillainHP + healAmount);
                    if(currentVillainHP > oldHP) {
                        log.innerText = `${currentVillain.name}'s Self-Repair restores ${healAmount} HP!`;
                        showRegenerateEffect(vImg);
                        showFloatingText(vImg, `+${healAmount}`, '#4ade80');
                        updateHealthUI('villain', (currentVillainHP / maxVillainHP) * 100);
                        await delay(1200);
                    }
                }

                const isHeroTurn = (i % 2 === 0) ? Math.random() > 0.4 : Math.random() > 0.6;

                if(isHeroTurn) {
                    // HERO ATTACKS
                    const attackerIndex = Math.random() > 0.5 ? 0 : 1;
                    const attacker = attackerIndex === 0 ? h1 : h2;
                    const heroKey = attackerIndex === 0 ? 'hero1' : 'hero2';

                    // Check if stunned
                    if(stunnedHeroes[heroKey]) {
                        log.innerText = `${attacker.name} is stunned and can't attack!`;
                        stunnedHeroes[heroKey] = false; // Clear stun
                        await delay(1500);
                        continue;
                    }

                    const move = getStandardMove(attacker);

                    log.innerText = `${attacker.name} uses ${move.name}!`;
                    AudioEngine.playTone(600 + (Math.random()*200), 'sine', 0.2);
                    await delay(800);

                    let damage = 15 + Math.random() * 10;
                    const oldVillainHP = currentVillainHP;

                    // Check EVASION
                    if(currentVillain.ability === 'evasion') {
                        const abilityChance = currentVillain.abilityChance + VillainPhaseSystem.getAbilityModifier();
                        const abilityMod = tierData.abilityMultiplier;
                        if(Math.random() < (abilityChance * abilityMod)) {
                            log.innerText = `${currentVillain.name} phase shifts - attack passes through!`;
                            showEvasionEffect(vImg);
                            showFloatingText(vImg, 'DODGED!', '#22d3ee');
                            await delay(1500);
                            continue; // Skip damage
                        }
                    }

                    hitEffect(vImg);

                    // Apply ARMOR
                    if(currentVillain.ability === 'armor') {
                        const reduction = currentVillain.damageReduction;
                        damage *= (1 - reduction);
                        log.innerText = `${currentVillain.name}'s Steel Plating absorbs ${Math.round(damage * reduction / (1-reduction))} damage!`;
                        showArmorEffect(vImg);
                        showFloatingText(vImg, 'ARMORED!', '#c0c0c0');
                        await delay(1000);
                    }

                    currentVillainHP = Math.max(0, currentVillainHP - damage);
                    updateHealthUI('villain', (currentVillainHP / maxVillainHP) * 100);

                    // Check PHASE TRANSITION
                    const newPhase = VillainPhaseSystem.checkPhaseTransition(oldVillainHP, currentVillainHP);
                    if(newPhase) {
                        await delay(500);
                        await VillainPhaseSystem.triggerPhaseTransition(newPhase, currentVillain.name);
                    }

                    log.innerText = "A solid hit!";

                } else {
                    // VILLAIN ATTACKS
                    log.innerText = `${currentVillain.name} strikes with ${currentVillain.move}!`;
                    await delay(800);

                    let damage = (15 + Math.random() * 10) * tierData.damageMultiplier * VillainPhaseSystem.getDamageModifier();

                    hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                    currentHeroHP = Math.max(10, currentHeroHP - damage);
                    updateHealthUI('heroes', currentHeroHP);
                    log.innerText = "The heroes take damage!";

                    // Check STUN
                    if(currentVillain.ability === 'stun') {
                        const abilityChance = currentVillain.abilityChance + VillainPhaseSystem.getAbilityModifier();
                        const abilityMod = tierData.abilityMultiplier;
                        if(Math.random() < (abilityChance * abilityMod)) {
                            const stunTarget = Math.random() > 0.5 ? 0 : 1;
                            const stunHero = stunTarget === 0 ? h1 : h2;
                            const stunKey = stunTarget === 0 ? 'hero1' : 'hero2';
                            stunnedHeroes[stunKey] = true;

                            await delay(500);
                            log.innerText = `${currentVillain.name}'s Thunderclap STUNS ${stunHero.name}!`;
                            showStunEffect(hImgs[stunTarget]);
                            showFloatingText(hImgs[stunTarget], 'STUNNED!', '#fbbf24');
                            await delay(1200);
                        }
                    }

                    // Check DOUBLE STRIKE
                    if(currentVillain.ability === 'double_strike') {
                        const abilityChance = currentVillain.abilityChance + VillainPhaseSystem.getAbilityModifier();
                        const abilityMod = tierData.abilityMultiplier;
                        if(Math.random() < (abilityChance * abilityMod)) {
                            await delay(500);
                            log.innerText = `${currentVillain.name}'s Lightning Reflexes activate - DOUBLE STRIKE!`;
                            showDoubleStrikeEffect(vImg);
                            showFloatingText(vImg, 'DOUBLE STRIKE!', '#fbbf24');
                            await delay(800);

                            hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                            const secondDamage = damage * 0.7;
                            currentHeroHP = Math.max(10, currentHeroHP - secondDamage);
                            updateHealthUI('heroes', currentHeroHP);
                            log.innerText = "A devastating second strike!";
                            await delay(1000);
                        }
                    }
                }

                await delay(2000);
            }

            if(!isBattleActive) return;

            // 4. THE FINALE
            if(heroesWin) {
                // HEROES WIN SCENARIO
                log.innerText = `${currentVillain.name} roars and attacks furiously!`;
                hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                currentHeroHP = 10;
                updateHealthUI('heroes', currentHeroHP);
                log.innerText = "The heroes are down to their last spark!";
                await delay(2500); if(!isBattleActive) return;

                // Slow Mo Tension
                AudioEngine.stopMusic();
                stage.classList.add('slow-mo');

                const finisher = Math.random() > 0.5 ? h1 : h2;
                const ult = getUltimateMove(finisher);
                log.innerText = `But ${finisher.name} prepares ${ult.name}...`;
                await delay(2500); if(!isBattleActive) return;

                // ELEMENTAL EXPLOSION
                stage.classList.remove('slow-mo');
                triggerElementalFinale(finisher.type);
                hitEffect(vImg);
                currentVillainHP = 0;
                updateHealthUI('villain', 0);
                log.innerText = "K.O.!!!";
                await delay(2000); if(!isBattleActive) return;

                log.innerText = `The ${currentVillain.name} is defeated! The Heroes Win!`;
                playVictoryTunes();

            } else {
                // HEROES LOSE SCENARIO (30% Chance)
                const trier = h1;
                log.innerText = `${trier.name} tries to end it, but misses!`;
                await delay(2000); if(!isBattleActive) return;

                log.innerText = `${currentVillain.name} unleashes TOTAL CHAOS!`;
                stage.classList.add('shake-hard');
                AudioEngine.playTone(100, 'sawtooth', 0.5);
                await delay(1000); stage.classList.remove('shake-hard');

                hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                updateHealthUI('heroes', 0);

                log.innerText = "The heroes are overwhelmed!";
                await delay(2000); if(!isBattleActive) return;

                AudioEngine.stopMusic();
                log.innerText = "Muddlewick laughs... The Heroes must retreat!";
                AudioEngine.playTone(150, 'sine', 1.0);
            }
        }
        
        function playVictoryTunes() {
             createMegaBurst('electric'); // Confetti
             setTimeout(() => createMegaBurst('ice'), 500);
             AudioEngine.playTone(400, 'sine', 0.1);
             setTimeout(() => AudioEngine.playTone(600, 'sine', 0.1), 100);
             setTimeout(() => AudioEngine.playTone(800, 'sine', 0.2), 200);
        }

        /* --- RENDER --- */
        const grid = document.getElementById("heroGrid");

        function renderGrid(filterType = 'all') {
            grid.innerHTML = heroes.map(hero => {
                const isHidden = filterType !== 'all' && hero.type !== filterType;
                if (isHidden) return '';
                return `
      <div class="hero-card-container">
        <div class="hero-card" id="card-${hero.id}" data-type="${hero.type}" 
             onclick="triggerMegaReveal('${hero.id}')" 
             onmouseenter="AudioEngine.playTone(100, 'sine', 0.05)"
             onmousemove="tiltCard(event, this)" 
             onmouseleave="resetTilt(this)">
          <div class="class-badge">${hero.role.split(' ')[0]}</div>
          <div class="scan-line"></div>
          <div class="card-foil"></div>
          <div class="card-image-wrapper">
            <img src="${hero.image}" alt="${hero.name}" onerror="this.src='https://placehold.co/400x500/1e293b/FFF?text=${hero.name.charAt(0)}'">
          </div>
          <div class="card-content">
            <div class="hero-name">${hero.name}</div>
            <div class="hero-alias">${hero.alias}</div>
          </div>
        </div>
      </div>
    `;
            }).join("");
            setTimeout(() => {
                document.querySelectorAll('.hero-card').forEach((card, i) => {
                    setTimeout(() => card.classList.add('reveal'), i * 50);
                });
            }, 50);
        }
        renderGrid();

        /* --- REVEAL / SELECT LOGIC --- */
        function triggerMegaReveal(id) {
            // IF IN BATTLE MODE:
            if(isBattleSelecting) {
                 handleBattleSelection(id);
                 return;
            }
            // NORMAL MODE:
            AudioEngine.playTone(600, 'sine', 0.1);
            const hero = heroes.find(h => h.id === id);
            const flash = document.getElementById('flashOverlay');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 150);
            createMegaBurst(hero.type);
            setTimeout(() => { openModal(hero); AudioEngine.playTone(200, 'sine', 0.2); }, 100);
        }

        function createMegaBurst(type) {
            const container = document.getElementById('particleContainer');
            const colors = type === 'electric' ? ['#fbbf24', '#fffbeb'] : type === 'ice' ? ['#22d3ee', '#ecfeff'] : ['#ef4444', '#fef2f2'];
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                const angle = Math.random() * Math.PI * 2;
                const velocity = 200 + Math.random() * 400;
                p.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                p.style.width = (3 + Math.random() * 5) + 'px'; p.style.height = p.style.width;
                p.style.left = window.innerWidth / 2 + 'px'; p.style.top = window.innerHeight / 2 + 'px';
                p.style.setProperty('--tx', Math.cos(angle) * velocity + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * velocity + 'px');
                container.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        /* --- MODAL --- */
        const overlay = document.getElementById("modalOverlay");
        const modalCardEl = document.getElementById("modalCard");
        const modalImage = document.getElementById("modalImage");
        const typeBadge = document.getElementById("modalTypeBadge");
        const nameEl = document.getElementById("modalName");
        const roleEl = document.getElementById("modalRole");
        const descEl = document.getElementById("modalDescription");
        const movesEl = document.getElementById("modalMoves");
        const statsEl = document.getElementById("modalStats");

        function openModal(hero) {
            modalImage.src = hero.image;
            modalImage.onerror = function () { this.src = `https://placehold.co/400x500/1e293b/FFF?text=${hero.name.charAt(0)}` };
            const themeColor = hero.type === 'electric' ? '#fbbf24' : hero.type === 'ice' ? '#22d3ee' : '#ef4444';
            const statClass = hero.type === 'electric' ? 'fill-electric' : hero.type === 'ice' ? 'fill-ice' : 'fill-impact';

            modalCardEl.style.setProperty('--theme-color', themeColor);
            typeBadge.style.borderColor = themeColor; typeBadge.style.color = themeColor; typeBadge.innerHTML = hero.icon; typeBadge.style.boxShadow = `0 0 30px ${themeColor}`;
            nameEl.textContent = hero.name; roleEl.innerHTML = `${hero.alias} ‚Ä¢ ${hero.role}`; descEl.textContent = hero.description;

            movesEl.innerHTML = hero.moves.map(m => `<div class="move-row"><span class="move-name">${m.name}</span><span class="move-val">${m.pwr}</span></div>`).join("");
            statsEl.innerHTML = `
                ${createStatRow('Bravery', hero.stats.bravery, statClass)}
                ${createStatRow('Speed', hero.stats.speed, statClass)}
                ${createStatRow('Strength', hero.stats.strength, statClass)}
                ${createStatRow('Teamwork', hero.stats.teamwork, statClass)}
                ${createStatRow('Focus', hero.stats.focus, statClass)}
            `;
            overlay.classList.add("active");
            setTimeout(() => { document.querySelectorAll('.stat-fill').forEach((bar, i) => setTimeout(() => bar.style.width = bar.getAttribute('data-pct'), i * 100)); }, 300);
        }

        function createStatRow(label, val, colorClass) {
            const pct = (val / 5) * 100 + '%';
            return `<div class="stat-row"><div class="stat-label">${label}</div><div class="stat-track"><div class="stat-fill ${colorClass}" data-pct="${pct}"></div></div></div>`;
        }

        function closeModal() {
            AudioEngine.playTone(300, 'sine', 0.1);
            overlay.classList.remove("active");
            document.querySelectorAll('.stat-fill').forEach(bar => bar.style.width = '0%');
        }

        /* --- VILLAIN MODAL FUNCTIONS --- */
        function openVillainModal(villain) {
            const villainOverlay = document.getElementById('villainModalOverlay');
            const villainImage = document.getElementById('villainModalImage');
            const villainTypeBadge = document.getElementById('villainModalTypeBadge');
            const villainName = document.getElementById('villainModalName');
            const villainType = document.getElementById('villainModalType');
            const villainDescription = document.getElementById('villainModalDescription');
            const villainStats = document.getElementById('villainModalStats');
            const villainSignature = document.getElementById('villainModalSignature');
            const villainWeakness = document.getElementById('villainModalWeakness');

            // Set image
            villainImage.src = villain.img;
            villainImage.onerror = function () { this.src = `https://placehold.co/400x500/1e293b/FFF?text=${villain.name.charAt(0)}` };

            // Set theme color based on type
            const themeColor = villain.type === 'electric' ? '#fbbf24' : villain.type === 'ice' ? '#22d3ee' : '#ef4444';
            const icon = villain.type === 'electric' ? '‚ö°' : villain.type === 'ice' ? '‚ùÑÔ∏è' : 'üí•';

            // Set badge
            villainTypeBadge.style.borderColor = themeColor;
            villainTypeBadge.style.color = themeColor;
            villainTypeBadge.innerHTML = icon;
            villainTypeBadge.style.boxShadow = `0 0 30px ${themeColor}`;

            // Set content
            villainName.textContent = villain.name;
            villainType.textContent = `${villain.type.toUpperCase()} TYPE ‚Ä¢ ${villain.move.toUpperCase()}`;
            villainDescription.textContent = villain.description;
            villainSignature.textContent = villain.signature;
            villainWeakness.textContent = villain.weakness;

            // Set stats
            const statLabels = ['Danger', 'Speed', 'Cunning', 'Power'];
            const statValues = [villain.stats.danger, villain.stats.speed, villain.stats.cunning, villain.stats.power];

            villainStats.innerHTML = statLabels.map((label, i) => {
                const pct = (statValues[i] / 5) * 100;
                return `
                    <div class="villain-stat-row">
                        <div class="villain-stat-label">${label}</div>
                        <div class="villain-stat-track">
                            <div class="villain-stat-fill" data-pct="${pct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');

            // Show modal
            villainOverlay.classList.add("active");

            // Animate stat bars
            setTimeout(() => {
                document.querySelectorAll('.villain-stat-fill').forEach((bar, i) => {
                    setTimeout(() => bar.style.width = bar.getAttribute('data-pct'), i * 100);
                });
            }, 300);

            // Play menacing sound
            AudioEngine.playTone(60, 'sawtooth', 0.3);
            setTimeout(() => AudioEngine.playTone(40, 'sawtooth', 0.2), 150);
        }

        function closeVillainModal() {
            const villainOverlay = document.getElementById('villainModalOverlay');
            AudioEngine.playTone(200, 'sine', 0.1);
            villainOverlay.classList.remove("active");

            // Reset stat bars
            document.querySelectorAll('.villain-stat-fill').forEach(bar => bar.style.width = '0%');
        }

        /* --- TILT --- */
        function tiltCard(e, card) {
            if(card.classList.contains('selected')) return;
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            const rotateX = ((y - rect.height / 2) / (rect.height / 2)) * -8;
            const rotateY = ((x - rect.width / 2) / (rect.width / 2)) * 8;
            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
            card.querySelector('.card-foil').style.backgroundPosition = `${50 + (x / rect.width) * 50}% ${50 + (y / rect.height) * 50}%`;
        }
        function resetTilt(card) { 
             if(card.classList.contains('selected')) { card.style.transform = `scale(1.05)`; } 
             else { card.style.transform = `rotateX(0deg) rotateY(0deg) scale(1)`; }
        }

        /* --- FILTER --- */
        function filterGrid(type, btn) {
            if(isBattleSelecting) return;
            AudioEngine.playTone(500, 'sine', 0.05);
            document.querySelectorAll('.filter-btn:not(#muddlewickBtn)').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const root = document.documentElement;
            if (type === 'electric') { root.style.setProperty('--nebula-1', 'rgba(251, 191, 36, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(245, 158, 11, 0.1)'); } 
            else if (type === 'ice') { root.style.setProperty('--nebula-1', 'rgba(34, 211, 238, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(14, 165, 233, 0.1)'); } 
            else if (type === 'impact') { root.style.setProperty('--nebula-1', 'rgba(239, 68, 68, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(220, 38, 38, 0.1)'); } 
            else { root.style.setProperty('--nebula-1', 'rgba(76, 29, 149, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(56, 189, 248, 0.1)'); }
            document.querySelectorAll('.hero-card-container').forEach(c => c.classList.add('hidden'));
            setTimeout(() => renderGrid(type), 300);
        }
    </script>

</body>

</html>
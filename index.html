<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Hawthorn Superheroes: Platinum Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Bangers&family=Inter:wght@400;600;800;900&family=Rajdhani:wght@500;600;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-deep: #020617;
            --card-bg: #0f172a;

            /* ELEMENTAL COLORS */
            --col-electric: #fbbf24;
            --col-ice: #22d3ee;
            --col-impact: #ef4444;

            /* AMBIENCE */
            --nebula-1: rgba(76, 29, 149, 0.2);
            --nebula-2: rgba(56, 189, 248, 0.1);

            --ease-smooth: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            min-height: 100vh;
            background-color: var(--bg-deep);
            font-family: "Rajdhani", "Inter", sans-serif;
            color: #fff;
            overflow-x: hidden;
            perspective: 1200px;
            -webkit-tap-highlight-color: transparent;
            cursor: default;
            transition: background-color 1s;
        }

        /* --- DEEP SPACE PARALLAX BACKGROUND --- */
        .space-bg {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: radial-gradient(circle at 50% 50%, #1e1b4b 0%, #020617 100%);
            overflow: hidden;
            transition: 1s;
        }

        .stars {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            box-shadow: 100px 200px #fff, 400px 500px #fff, 700px 100px #fff, 900px 800px #fff;
            animation: starMove 100s linear infinite;
            opacity: 0.5;
        }

        .stars.md {
            width: 3px;
            height: 3px;
            animation-duration: 150s;
            opacity: 0.3;
        }

        @keyframes starMove {
            from { transform: translateY(0); }
            to { transform: translateY(-2000px); }
        }

        /* PERFORMANCE: Disable parallax for reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .stars, .nebula-layer, .hero-card, .flying-card {
                animation: none !important;
                transition: none !important;
                transform: none !important;
            }
            .hero-card:hover { transform: none !important; }
        }

        .nebula-layer {
            position: absolute;
            inset: -50%;
            background: radial-gradient(circle at 20% 30%, var(--nebula-1), transparent 50%), radial-gradient(circle at 80% 70%, var(--nebula-2), transparent 50%);
            filter: blur(60px);
            animation: nebulaPulse 20s ease-in-out infinite alternate;
            transition: background 1.5s;
        }

        @keyframes nebulaPulse {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 0.8; transform: scale(1.1); }
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            mask-image: radial-gradient(circle at center, black 30%, transparent 90%);
        }

        .app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            padding-bottom: 6rem;
        }

        /* HEADER */
        header {
            text-align: center;
            margin: 3rem 0 3rem 0;
            animation: fadeSlideDown 1s var(--ease-smooth) forwards;
        }

        header h1 {
            font-family: "Bangers", cursive;
            font-size: clamp(4rem, 12vw, 8rem);
            letter-spacing: 4px;
            line-height: 0.9;
            background: linear-gradient(to right, #fff 20%, #fbbf24 40%, #fbbf24 60%, #fff 80%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 40px rgba(255, 255, 255, 0.15));
            margin-bottom: 1rem;
            transform: skewY(-2deg);
            animation: shine 5s linear infinite;
        }
        
        @keyframes shine {
            to { background-position: 200% center; }
        }

        .subtitle {
            font-size: 1.2rem;
            color: #38bdf8;
            letter-spacing: 8px;
            text-transform: uppercase;
            font-weight: 700;
            display: inline-block;
            padding: 0.5rem 2rem;
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.3);
            border-radius: 4px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
        }

        /* --- CONTROLS BAR --- */
        .controls-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom: 3rem;
            animation: fadeSlideDown 1.2s var(--ease-smooth) forwards;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.8);
            padding: 0.5rem;
            border-radius: 40px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-btn {
            background: transparent;
            border: none;
            color: #94a3b8;
            padding: 0.8rem 2rem;
            border-radius: 30px;
            font-family: "Rajdhani";
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: 0.3s;
        }

        .filter-btn:hover,
        .filter-btn.active {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            text-shadow: 0 0 10px currentColor;
        }

        .filter-btn.active {
            background: var(--active-color);
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 20px var(--active-color);
        }

        /* Battle Button Style */
        .battle-btn {
            background: rgba(76, 29, 149, 0.3);
            border: 1px solid #a855f7;
            color: #e9d5ff;
        }
        .battle-btn:hover, .battle-btn.active {
             background: #a855f7;
             color: #fff;
             box-shadow: 0 0 25px #a855f7;
        }

        /* --- GRID --- */
        .hero-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 3rem;
            padding-top: 1rem;
        }

        .hero-card-container {
            perspective: 1500px;
            transition: 0.5s;
        }

        .hero-card-container.hidden {
            display: none;
        }

        /* --- CARD --- */
        .hero-card {
            height: 500px;
            background: var(--card-bg);
            border-radius: 20px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.2s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.3s, border-color 0.3s;
            cursor: pointer;
            overflow: hidden;
            opacity: 0;
            transform: translateY(100px) rotateX(10deg);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-bottom: 3px solid var(--hero-color, rgba(255,255,255,0.1));
        }
        
        /* Accessibility Focus Style */
        .hero-card:focus {
            outline: none;
            box-shadow: 0 0 0 4px #fff, 0 50px 80px -20px rgba(0,0,0,0.9);
            transform: translateY(0) scale(1.05);
        }

        .hero-card.reveal {
            opacity: 1;
            transform: translateY(0) rotateX(0);
            transition: opacity 0.8s ease-out, transform 0.8s var(--ease-smooth);
        }

        .hero-card:hover {
            z-index: 10;
            box-shadow: 0 50px 80px -20px rgba(0, 0, 0, 0.9);
        }

        .hero-card.selected {
            border-color: #4ade80;
            box-shadow: 0 0 40px rgba(74, 222, 128, 0.6);
            transform: scale(1.05) !important;
        }
        
        .hero-card.dimmed {
            opacity: 0.4;
            filter: grayscale(0.8);
        }

        /* Glows */
        .hero-card[data-type="electric"]:hover {
            box-shadow: 0 0 50px rgba(251, 191, 36, 0.3);
            border-color: var(--col-electric);
        }
        .hero-card[data-type="ice"]:hover {
            box-shadow: 0 0 50px rgba(34, 211, 238, 0.3);
            border-color: var(--col-ice);
        }
        .hero-card[data-type="impact"]:hover {
            box-shadow: 0 0 50px rgba(239, 68, 68, 0.3);
            border-color: var(--col-impact);
        }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 30;
            background: linear-gradient(to bottom, transparent 40%, rgba(255, 255, 255, 0.1) 50%, transparent 60%);
            background-size: 100% 200%; opacity: 0; transition: opacity 0.3s;
        }
        .hero-card:hover .scan-line { opacity: 1; animation: scanDown 2s infinite linear; }
        @keyframes scanDown { 0% { background-position: 0% 0%; } 100% { background-position: 0% 200%; } }

        /* UPGRADED FOIL: Uses mix-blend-mode for better holographic look */
        .card-foil {
            position: absolute; inset: 0; z-index: 20; opacity: 0; transition: opacity 0.4s; pointer-events: none;
            background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,255,255,0.3) 0%, transparent 60%),
                        linear-gradient(115deg, transparent 30%, rgba(255, 0, 255, 0.3) 45%, rgba(0, 255, 255, 0.3) 55%, transparent 70%);
            mix-blend-mode: color-dodge; 
            transform: translateZ(1px); 
            background-size: 150% 150%, 200% 200%;
        }
        .hero-card:hover .card-foil { opacity: 1; }

        .card-image-wrapper { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .hero-card img {
            width: 100%; height: 100%; object-fit: cover; object-position: center top;
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94), filter 0.5s; filter: grayscale(0.2) contrast(1.1);
        }
        .hero-card:hover img { transform: scale(1.1); filter: grayscale(0) contrast(1.2); }

        .card-content {
            position: absolute; bottom: 0; width: 100%; padding: 1.5rem;
            background: linear-gradient(to top, rgba(2, 6, 23, 0.95) 20%, rgba(2, 6, 23, 0.6) 80%, transparent 100%);
            display: flex; flex-direction: column; justify-content: flex-end; transform: translateZ(20px); height: 50%;
        }
        .hero-name {
            font-family: "Bangers", cursive; font-size: 3rem; letter-spacing: 2px; color: #fff; line-height: 0.9;
            margin-bottom: 0.25rem; text-shadow: 0 4px 10px rgba(0, 0, 0, 0.8); transition: 0.3s; transform-origin: left;
        }
        .hero-card:hover .hero-name { transform: scale(1.05); }
        .hero-alias {
            font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: rgba(255, 255, 255, 0.7);
            background: rgba(0, 0, 0, 0.5); padding: 4px 10px; border-radius: 4px; backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1); display: inline-block;
        }
        .class-badge {
            position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff; font-family: "Rajdhani"; font-weight: 700; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 1px; z-index: 25; backdrop-filter: blur(4px); transform: translateZ(30px);
        }

        /* --- MODAL (BIO) --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 1600; display: flex; align-items: center; justify-content: center;
            background: rgba(2, 6, 23, 0); backdrop-filter: blur(0px); transition: 0.4s; pointer-events: none; opacity: 0;
        }
        .modal-overlay.active { 
            background: rgba(2, 6, 23, 0.92); backdrop-filter: blur(20px); pointer-events: all; opacity: 1; 
        }

        .modal-card {
            width: min(1100px, 95%); height: min(700px, 90vh); background: rgba(15, 23, 42, 0.9); border-radius: 16px;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1), 0 50px 100px -20px rgba(0, 0, 0, 0.8);
            transform: scale(0.8) rotateY(-15deg); opacity: 0;
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease-out;
            transform-style: preserve-3d;
            display: grid;
            grid-template-columns: 45% 55%; overflow: hidden; position: relative;
        }
        .modal-overlay.active .modal-card { 
            transform: scale(1) rotateY(0deg); opacity: 1; background: rgba(15, 23, 42, 0.95);
        }

        .modal-col-img { position: relative; height: 100%; overflow: hidden; }
        .modal-image-full { width: 100%; height: 100%; object-fit: cover; object-position: center top; mask-image: linear-gradient(to right, black 80%, transparent 100%); }
        
        .modal-col-data { 
            padding: 3rem; display: flex; flex-direction: column; background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.03), transparent 70%); overflow-y: auto; position: relative;
            opacity: 0; transform: translateX(30px); transition: opacity 0.5s ease-out 0.2s, transform 0.5s ease-out 0.2s;
        }
        .modal-overlay.active .modal-col-data { 
            opacity: 1; transform: translateX(0); 
        }

        .modal-name-display {
            font-family: "Bangers"; font-size: 5rem; line-height: 0.9; margin-bottom: 0.5rem; text-transform: uppercase;
            letter-spacing: 2px; background: linear-gradient(180deg, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .modal-role-display { font-size: 1rem; text-transform: uppercase; letter-spacing: 4px; font-weight: 700; color: var(--theme-color); display: flex; align-items: center; gap: 1rem; }
        .modal-desc { font-size: 1.1rem; line-height: 1.7; color: #cbd5e1; margin-bottom: 2.5rem; font-weight: 300; border-left: 2px solid rgba(255, 255, 255, 0.1); padding-left: 1.5rem; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .dash-panel { background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.05); position: relative; }
        .move-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .move-name { font-weight: 600; font-size: 0.95rem; color: #e2e8f0; }
        .move-val { font-family: "Bangers"; font-size: 1.4rem; color: var(--theme-color); text-shadow: 0 0 10px currentColor; }
        .stat-row { display: flex; align-items: center; margin-bottom: 10px; }
        .stat-label { width: 90px; font-size: 0.75rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-track { flex-grow: 1; height: 6px; background: rgba(255, 255, 255, 0.05); border-radius: 2px; overflow: hidden; position: relative; }
        .stat-fill { height: 100%; width: 0%; position: relative; z-index: 1; transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1); }
        .fill-electric { background: #fbbf24; box-shadow: 0 0 15px #fbbf24; }
        .fill-ice { background: #22d3ee; box-shadow: 0 0 15px #22d3ee; }
        .fill-impact { background: #ef4444; box-shadow: 0 0 15px #ef4444; }

        .modal-type-badge {
            transform: scale(0) rotate(-180deg);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) 0.3s;
        }
        .modal-overlay.active .modal-type-badge {
            transform: scale(1) rotate(0deg);
        }

        .close-btn {
            position: absolute; top: 20px; right: 20px; font-size: 2rem; color: rgba(255, 255, 255, 0.5); cursor: pointer;
            z-index: 20; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .close-btn:hover { color: #fff; transform: rotate(90deg); }

        /* --- NEW ANIMATION CLASSES --- */
        .flying-card {
            position: fixed; z-index: 2000; pointer-events: none; border-radius: 20px; overflow: hidden;
            box-shadow: 0 0 100px rgba(255, 255, 255, 0.5); transform-style: preserve-3d;
            backface-visibility: hidden;
        }
        .flying-card img { width: 100%; height: 100%; object-fit: cover; }
        
        .energy-ring {
            position: fixed; border-radius: 50%; pointer-events: none; z-index: 1999; border: 4px solid;
            animation: ringExplosion 0.8s ease-out forwards;
        }
        @keyframes ringExplosion {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }
        
        .speed-line {
            position: fixed; height: 3px; background: linear-gradient(90deg, transparent, var(--line-color), transparent);
            pointer-events: none; z-index: 1998; animation: speedLineZoom 0.5s ease-out forwards;
        }
        @keyframes speedLineZoom {
            0% { transform: scaleX(0); opacity: 1; }
            50% { transform: scaleX(1); opacity: 1; }
            100% { transform: scaleX(0); opacity: 0; }
        }

        /* SYNERGY OVERLAY - FIXED POSITION */
        .synergy-overlay {
            position: fixed;
            inset: 0;
            z-index: 2500; /* Higher than battle */
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.85);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .synergy-overlay.active {
            opacity: 1;
            pointer-events: all;
            backdrop-filter: blur(10px);
        }
        .synergy-text {
            font-family: "Bangers";
            font-size: clamp(3rem, 8vw, 6rem);
            color: #fff;
            text-shadow: 0 0 30px currentColor;
            transform: scale(0);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-align: center;
            line-height: 1;
            z-index: 2501;
        }
        .synergy-overlay.active .synergy-text {
            transform: scale(1);
        }
        /* Element Colors for Text */
        .synergy-electric .synergy-text { color: #fbbf24; text-shadow: 0 0 40px #fbbf24; }
        .synergy-ice .synergy-text { color: #22d3ee; text-shadow: 0 0 40px #22d3ee; }
        .synergy-impact .synergy-text { color: #ef4444; text-shadow: 0 0 40px #ef4444; }


        /* --- BATTLE ARENA MODAL --- */
        .battle-overlay {
            position: fixed; inset: 0; z-index: 1800; background: #000; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .battle-overlay.active { opacity: 1; pointer-events: all; }
        
        .battle-stage {
            width: 100%; max-width: 1000px; height: 80vh; background: radial-gradient(circle at center, #1e1b4b 0%, #000 70%);
            border: 2px solid #a855f7; border-radius: 20px; box-shadow: 0 0 50px rgba(168, 85, 247, 0.3);
            display: flex; flex-direction: column; padding: 2rem; position: relative; overflow: hidden;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
            perspective: 1000px; /* Enable 3D for floor */
        }
        .battle-stage.slow-mo { transform: scale(1.1); filter: contrast(1.2); }
        
        /* LOW HEALTH DANGER PULSE */
        @keyframes dangerPulse {
            0% { box-shadow: inset 0 0 0 rgba(239, 68, 68, 0); border-color: #a855f7; }
            50% { box-shadow: inset 0 0 50px rgba(239, 68, 68, 0.3); border-color: #ef4444; }
            100% { box-shadow: inset 0 0 0 rgba(239, 68, 68, 0); border-color: #a855f7; }
        }
        .battle-stage.danger {
            animation: dangerPulse 1s infinite;
        }

        .battle-stage::before {
             content: ""; position: absolute; inset:0; 
             background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a855f7' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
             opacity: 0.5;
             z-index: 1;
        }
        
        /* 3D FLOOR UPGRADE */
        .battle-stage::after {
            content: '';
            position: absolute;
            bottom: -50%;
            left: -50%;
            width: 200%;
            height: 100%;
            background:
                linear-gradient(transparent 0%, rgba(168, 85, 247, 0.3) 2%, transparent 3%),
                linear-gradient(90deg, transparent 0%, rgba(168, 85, 247, 0.3) 2%, transparent 3%);
            background-size: 50px 50px;
            transform: rotateX(60deg);
            z-index: 0;
            pointer-events: none;
            mask-image: linear-gradient(to top, black 20%, transparent 80%);
        }
        
        .battle-header { text-align: center; margin-bottom: 2rem; z-index: 2; }
        .battle-title { font-family: 'Bangers'; font-size: 3rem; color: #a855f7; text-shadow: 0 0 20px #a855f7; }

        .battle-area { display: flex; justify-content: space-between; align-items: center; flex-grow: 1; z-index: 2; }
        .side { width: 300px; text-align: center; position: relative; }
        .side-img {
            width: 200px; height: 200px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(255,255,255,0.2));
            transition: transform 0.2s; border-radius: 12px;
        }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 
            0% { transform: translate(0, 0); }
            10% { transform: translate(-10px, -10px); }
            20% { transform: translate(10px, 10px); }
            30% { transform: translate(-10px, 10px); }
            40% { transform: translate(10px, -10px); }
            50% { transform: translate(-10px, 0); }
            60% { transform: translate(10px, 0); }
            100% { transform: translate(0, 0); }
        }

        .shake-hard { animation: shakeHard 0.6s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shakeHard {
            0% { transform: translate(0, 0) rotate(0deg); }
            20% { transform: translate(-20px, -20px) rotate(-5deg); }
            40% { transform: translate(20px, 20px) rotate(5deg); }
            60% { transform: translate(-20px, 20px) rotate(-5deg); }
            80% { transform: translate(20px, -20px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .damage-flash { animation: flashRed 0.3s ease-out; }
        @keyframes flashRed {
            0% { filter: sepia(1) saturate(5) hue-rotate(-50deg) brightness(2); }
            100% { filter: none; }
        }

        .hp-bar-container {
            width: 100%; height: 24px; background: rgba(0,0,0,0.5); border-radius: 4px; margin-top: 1rem;
            border: 2px solid rgba(255,255,255,0.3); overflow: hidden;
            transform: skewX(-20deg);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        /* SEGMENTED HEALTH BAR UPGRADE */
        .hp-fill { 
            height: 100%; width: 100%; transition: width 0.5s ease-out, background 0.5s ease-out; 
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px);
            background-size: 28px 28px;
        }
        .hp-villain { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .hp-heroes { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; }

        .battle-log {
            margin-top: 2rem; height: 100px; background: rgba(0,0,0,0.6); border: 1px solid #a855f7; border-radius: 8px;
            padding: 1rem; font-family: 'Rajdhani'; font-size: 1.2rem; color: #fff; display: flex; align-items: center;
            justify-content: center; text-align: center; z-index: 2;
        }

        .battle-btn-initiate {
             font-family: 'Bangers'; font-size: 2.5rem; padding: 20px 60px; 
             background: linear-gradient(135deg, #9333ea, #7e22ce); color: white; border: 2px solid #d8b4fe; border-radius: 12px;
             margin-top: 20px; cursor: pointer; box-shadow: 0 0 40px rgba(168, 85, 247, 0.8);
             display: none;
             transition: 0.3s; animation: pulseBtn 1s infinite alternate;
        }
        .battle-btn-initiate:hover { transform: scale(1.05); background: #a855f7; }

        .battle-btn-commence {
             font-family: 'Bangers'; font-size: 3rem; padding: 30px 80px; 
             background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: 2px solid #86efac; border-radius: 16px;
             cursor: pointer; box-shadow: 0 0 60px rgba(34, 197, 94, 0.8);
             transition: 0.3s; z-index: 20; animation: pulseGreen 1s infinite alternate;
        }
        .battle-btn-commence:hover { transform: scale(1.05); background: #4ade80; }

        @keyframes pulseBtn { from { box-shadow: 0 0 20px #9333ea; } to { box-shadow: 0 0 50px #d8b4fe; } }
        @keyframes pulseGreen { from { box-shadow: 0 0 20px #22c55e; } to { box-shadow: 0 0 60px #86efac; } }

        #flashOverlay {
            position: fixed; inset: 0; background: #fff; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.1s; mix-blend-mode: overlay;
        }
        #flashOverlay.active { opacity: 0.8; }

        #elementalOverlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 1900; opacity: 0; transition: opacity 0.5s;
        }
        .overlay-ice { background: radial-gradient(circle, rgba(34, 211, 238, 0.3) 0%, transparent 80%); }
        .overlay-electric { background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 80%); }
        .overlay-impact { background: radial-gradient(circle, rgba(239, 68, 68, 0.3) 0%, transparent 80%); }

        #particleContainer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; overflow: hidden; }
        .particle { 
            position: absolute; 
            /* border-radius removed to allow shapes */
            animation: burstOut 0.8s ease-out forwards; 
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; color: #fff; /* For text particles */
        }
        @keyframes burstOut {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0) rotate(180deg); }
        }

        .projectile {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
            filter: blur(4px);
            animation: projectileFly 0.6s ease-out forwards;
        }
        .projectile::before {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            background: inherit;
            filter: blur(8px);
            opacity: 0.6;
        }
        .projectile::after {
            content: '';
            position: absolute;
            inset: 5px;
            border-radius: 50%;
            background: white;
            opacity: 0.8;
        }
        @keyframes projectileFly {
            0% {
                transform: translate(var(--start-x), var(--start-y)) scale(0.5);
                opacity: 0;
            }
            20% { opacity: 1; }
            100% {
                transform: translate(var(--end-x), var(--end-y)) scale(1.2);
                opacity: 0;
            }
        }

        .projectile-trail {
            position: absolute;
            width: 200px;
            height: 4px;
            pointer-events: none;
            z-index: 99;
            opacity: 0.6;
            animation: trailFade 0.6s ease-out forwards;
            transform-origin: left center;
        }
        @keyframes trailFade {
            0% { opacity: 0.8; width: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; width: 200px; }
        }

        .damage-number {
            position: absolute;
            font-family: 'Bangers';
            font-size: 4rem;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px currentColor, 0 4px 10px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 150;
            animation: damageFloat 1.2s ease-out forwards;
        }
        @keyframes damageFloat {
            0% { transform: translateY(0) scale(0.5); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.3); opacity: 1; }
            50% { transform: translateY(-60px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-120px) scale(0.8); opacity: 0; }
        }

        .damage-number.critical {
            font-size: 5rem;
            color: #fbbf24;
            animation: criticalFloat 1.5s ease-out forwards;
        }
        @keyframes criticalFloat {
            0% { transform: translateY(0) scale(0.3) rotate(-10deg); opacity: 0; }
            15% { transform: translateY(-30px) scale(1.5) rotate(5deg); opacity: 1; }
            30% { transform: translateY(-50px) scale(1.3) rotate(-5deg); }
            60% { transform: translateY(-90px) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-150px) scale(0.8) rotate(0deg); opacity: 0; }
        }

        .charging {
            position: relative;
            animation: chargeGlow 1s ease-in-out infinite;
        }
        .charging::after {
            content: '';
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--charge-color) 0%, transparent 70%);
            animation: chargePulse 0.8s ease-in-out infinite;
            z-index: -1;
        }
        @keyframes chargeGlow {
            0%, 100% { filter: brightness(1) drop-shadow(0 0 10px var(--charge-color)); }
            50% { filter: brightness(1.5) drop-shadow(0 0 30px var(--charge-color)); }
        }
        @keyframes chargePulse {
            0%, 100% { transform: scale(1); opacity: 0.6; }
            50% { transform: scale(1.3); opacity: 0.9; }
        }

        .battle-stage.focus-left .side:first-child,
        .battle-stage.focus-right .side:last-child {
            transform: scale(1.15);
            filter: brightness(1.3) drop-shadow(0 0 40px currentColor);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), filter 0.3s;
        }

        .combo-counter {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Bangers';
            font-size: 3rem;
            color: #fbbf24;
            text-shadow: 0 0 20px #fbbf24, 0 4px 10px rgba(0,0,0,0.8);
            z-index: 200;
            opacity: 0;
            animation: comboAppear 0.3s ease-out forwards;
        }
        @keyframes comboAppear {
            0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
            100% { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        .combo-counter.high {
            font-size: 4rem;
            color: #ef4444;
            animation: comboShake 0.5s ease-in-out infinite;
        }
        @keyframes comboShake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-3deg) scale(1.05); }
            75% { transform: translateX(-50%) rotate(3deg) scale(1.05); }
        }

        .impact-ring {
            position: absolute;
            width: 100px;
            height: 100px;
            border: 4px solid;
            border-radius: 50%;
            pointer-events: none;
            z-index: 120;
            animation: ringExpand 0.6s ease-out forwards;
        }
        @keyframes ringExpand {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        @keyframes shakeLight {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-5px, 5px); }
            75% { transform: translate(5px, -5px); }
        }
        .battle-stage.shake-light { animation: shakeLight 0.3s ease-in-out; }

        .victory-pose {
            animation: victoryBounce 1s ease-in-out infinite;
        }
        @keyframes victoryBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }

        .battle-stage.intensity-low { filter: brightness(0.8); }
        .battle-stage.intensity-high { filter: brightness(1.3) saturate(1.5); }
        
        .speech-bubble {
            position: absolute;
            bottom: 100%; 
            left: 50%;
            transform: translateX(-50%) scale(0);
            background: #fff;
            color: #000;
            padding: 10px 15px;
            border-radius: 12px;
            font-family: 'Bangers';
            font-size: 1.2rem;
            white-space: nowrap;
            z-index: 200;
            box-shadow: 4px 4px 0px rgba(0,0,0,1);
            border: 2px solid #000;
            pointer-events: none;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            border-width: 8px 8px 0; border-style: solid; border-color: #000 transparent transparent transparent;
        }
        @keyframes popIn { to { transform: translateX(-50%) scale(1); } }
        
        .dodge-left { animation: dodgeLeft 0.5s ease-in-out; }
        .dodge-right { animation: dodgeRight 0.5s ease-in-out; }

        @keyframes dodgeLeft {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-50px) skewX(-10deg); }
        }
        @keyframes dodgeRight {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(50px) skewX(10deg); }
        }
        
        .enraged-boss {
            filter: sepia(1) hue-rotate(-50deg) saturate(3) drop-shadow(0 0 20px #ef4444) !important;
            animation: rapidPulse 0.5s infinite alternate !important;
        }
        @keyframes rapidPulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }
        
        .screen-flash-white { animation: flashWhite 0.2s ease-out; }
        @keyframes flashWhite {
            0% { background: white; opacity: 0.8; }
            100% { background: transparent; opacity: 0; }
        }

        .post-battle-modal {
            position: absolute; inset: 0; z-index: 500;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(10px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .post-battle-modal.active { opacity: 1; pointer-events: all; }
        
        .victory-header {
            font-family: "Bangers"; font-size: 6rem;
            background: linear-gradient(180deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 30px rgba(251, 191, 36, 0.5));
            margin-bottom: 1rem; transform: scale(0.5); transition: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .post-battle-modal.active .victory-header { transform: scale(1); }
        
        .star-row { display: flex; gap: 1rem; margin-bottom: 2rem; }
        .star {
            font-size: 4rem; color: #334155; transition: 0.3s; transform: scale(0);
        }
        .star.active { color: #fbbf24; filter: drop-shadow(0 0 20px #fbbf24); animation: popStar 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popStar { from { transform: scale(0) rotate(-180deg); } to { transform: scale(1) rotate(0); } }
        
        .score-details {
            font-family: "Rajdhani"; font-size: 1.5rem; text-align: center; color: #94a3b8; margin-bottom: 2rem;
        }
        .score-row { display: flex; justify-content: space-between; width: 300px; margin-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
        .score-val { color: #fff; font-weight: bold; }

        /* --- VILLAIN DOSSIER THEME --- */
        .villain-theme {
            background: linear-gradient(135deg, #1a0505 0%, #2d0a18 100%);
            border: 1px solid #7f1d1d;
            box-shadow: 0 0 60px rgba(220, 38, 38, 0.15);
        }

        .villain-header-band {
            font-family: "Rajdhani";
            font-weight: 800;
            font-size: 1.5rem;
            color: #ef4444;
            text-transform: uppercase;
            letter-spacing: 6px;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #ef4444;
            display: flex;
            align-items: center;
            gap: 15px;
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        .warning-stripe {
            height: 12px;
            width: 100%;
            background: repeating-linear-gradient(
                45deg,
                #7f1d1d,
                #7f1d1d 10px,
                #000 10px,
                #000 20px
            );
            margin-top: auto;
            opacity: 0.8;
        }
        
        .dossier-btn {
            background: transparent;
            border: 1px solid #ef4444;
            color: #ef4444;
            font-family: "Rajdhani";
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 4px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 8px;
            transition: 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .dossier-btn:hover {
            background: #ef4444;
            color: #000;
            box-shadow: 0 0 20px #ef4444;
        }

        .villain-stat-fill { 
            background: #ef4444; 
            box-shadow: 0 0 10px #ef4444; 
        }
        
        .weakness-box {
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 6px;
            color: #cbd5e1;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        .weakness-box strong { color: #ef4444; text-transform: uppercase; letter-spacing: 1px; }

        /* --- ITEM SELECTION OVERLAY --- */
        .item-selection-overlay {
            position: fixed;
            inset: 0;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .item-selection-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .item-selection-container {
            background: radial-gradient(circle at center, #1e1b4b 0%, #0f0a2e 70%);
            border: 3px solid #a855f7;
            border-radius: 20px;
            padding: 3rem;
            max-width: 900px;
            width: 90%;
            box-shadow: 0 0 60px rgba(168, 85, 247, 0.5);
        }

        .item-selection-title {
            font-family: 'Bangers';
            font-size: 3rem;
            color: #a855f7;
            text-align: center;
            text-shadow: 0 0 30px #a855f7;
            margin-bottom: 1rem;
        }

        .item-selection-counter {
            text-align: center;
            font-family: 'Rajdhani';
            font-size: 1.5rem;
            color: #fbbf24;
            margin-bottom: 2rem;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .item-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .item-card:hover {
            transform: translateY(-5px);
            border-color: #a855f7;
            box-shadow: 0 5px 20px rgba(168, 85, 247, 0.3);
        }

        .item-card.selected {
            border: 3px solid #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
            background: rgba(34, 197, 94, 0.1);
        }

        .item-card.rarity-common {
            border-color: #94a3b8;
        }

        .item-card.rarity-uncommon {
            border-color: #22c55e;
        }

        .item-card.rarity-rare {
            border-color: #3b82f6;
        }

        .item-card.selected.rarity-common {
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }

        .item-card.selected.rarity-uncommon {
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }

        .item-card.selected.rarity-rare {
            border-color: #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.6);
        }

        .item-icon-large {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }

        .item-card-name {
            font-family: 'Bangers';
            font-size: 1.5rem;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .item-card-desc {
            font-family: 'Rajdhani';
            font-size: 0.95rem;
            color: #cbd5e1;
            line-height: 1.4;
        }

        .enter-battle-btn {
            font-family: 'Bangers';
            font-size: 2.5rem;
            padding: 20px 60px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: 2px solid #86efac;
            border-radius: 16px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            box-shadow: 0 0 40px rgba(34, 197, 94, 0.6);
            transition: all 0.3s;
        }

        .enter-battle-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.8);
        }

        /* --- BATTLE ITEMS UI --- */
        .battle-items-container {
            position: absolute;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 1rem;
            z-index: 10;
        }

        .battle-item-btn {
            font-family: 'Rajdhani';
            font-size: 1rem;
            padding: 12px 20px;
            background: linear-gradient(135deg, #9333ea, #7e22ce);
            color: white;
            border: 2px solid #d8b4fe;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.5);
            transition: all 0.3s;
            animation: itemPulse 2s infinite alternate;
        }

        .battle-item-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.8);
        }

        .battle-item-btn.used {
            background: rgba(100, 100, 100, 0.5);
            border-color: #666;
            cursor: not-allowed;
            animation: none;
            opacity: 0.5;
        }

        .battle-item-btn .item-icon {
            font-size: 1.5rem;
        }

        .battle-item-btn .item-name {
            font-weight: 600;
        }

        @keyframes itemPulse {
            from { box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); }
            to { box-shadow: 0 0 25px rgba(168, 85, 247, 0.7); }
        }

        /* Item effect animations */
        @keyframes floatUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-100px);
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .shield-effect, .smoke-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            animation: scaleUpFade 2s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        @keyframes scaleUpFade {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(2);
                opacity: 0;
            }
        }

        .critical-glow {
            animation: criticalGlowAnim 0.5s ease-in-out infinite alternate;
        }

        @keyframes criticalGlowAnim {
            from {
                filter: drop-shadow(0 0 10px #ef4444);
            }
            to {
                filter: drop-shadow(0 0 30px #ef4444);
            }
        }

        .power-glow {
            animation: powerGlowAnim 0.5s ease-in-out infinite alternate;
        }

        @keyframes powerGlowAnim {
            from {
                filter: drop-shadow(0 0 10px #a855f7);
            }
            to {
                filter: drop-shadow(0 0 30px #a855f7);
            }
        }

        /* === CINEMATIC ANIMATIONS === */

        /* Cinematic Overlay */
        .cinematic-overlay {
            position: absolute;
            inset: 0;
            z-index: 400;
            pointer-events: none;
            background: transparent;
        }

        /* Slow Motion Effect */
        .slow-motion-active * {
            animation-duration: 2s !important;
            transition-duration: 2s !important;
        }

        /* Screen Flash */
        .screen-flash {
            position: fixed;
            inset: 0;
            z-index: 450;
            pointer-events: none;
            opacity: 0;
        }

        .screen-flash.flash-white {
            background: white;
            animation: flashTransition 0.3s ease-out;
        }

        @keyframes flashTransition {
            0% { opacity: 0; }
            50% { opacity: 0.9; }
            100% { opacity: 0; }
        }

        /* Victory Hero Pose */
        .hero-victory-center {
            position: absolute !important;
            left: 50% !important;
            top: 50% !important;
            transform: translate(-50%, -50%) scale(1.2) !important;
            z-index: 300 !important;
            animation: heroVictoryPose 1.5s ease-in-out forwards !important;
        }

        @keyframes heroVictoryPose {
            0% {
                transform: translate(-50%, -50%) scale(1);
                filter: brightness(1);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.25) rotate(2deg);
                filter: brightness(1.3);
            }
            100% {
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg);
                filter: brightness(1.2);
            }
        }

        /* Victory Aura */
        .victory-aura {
            position: absolute;
            inset: -20px;
            border-radius: 50%;
            opacity: 0.6;
            z-index: -1;
            animation: victoryAuraPulse 2s ease-in-out infinite;
        }

        @keyframes victoryAuraPulse {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }

        .victory-aura.electric {
            background: radial-gradient(circle, rgba(251, 191, 36, 0.8), transparent 70%);
            box-shadow: 0 0 40px #fbbf24, 0 0 80px #fbbf24;
        }

        .victory-aura.ice {
            background: radial-gradient(circle, rgba(34, 211, 238, 0.8), transparent 70%);
            box-shadow: 0 0 40px #22d3ee, 0 0 80px #22d3ee;
        }

        .victory-aura.impact {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.8), transparent 70%);
            box-shadow: 0 0 40px #ef4444, 0 0 80px #ef4444;
        }

        .victory-aura.synergy {
            background: radial-gradient(circle, rgba(168, 85, 247, 0.9), rgba(251, 191, 36, 0.7), transparent 70%);
            box-shadow: 0 0 60px #a855f7, 0 0 100px #fbbf24;
            animation: victoryAuraPulse 1.5s ease-in-out infinite, synergyRotate 3s linear infinite;
        }

        @keyframes synergyRotate {
            from { transform: scale(1.1) rotate(0deg); }
            to { transform: scale(1.1) rotate(360deg); }
        }

        /* Victory Title Slam */
        .victory-title-slam {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%) translateY(-200%);
            font-family: 'Bangers';
            font-size: 8rem;
            z-index: 500;
            color: #fbbf24;
            text-shadow:
                4px 4px 0px #000,
                0 0 30px #fbbf24,
                0 0 60px #fbbf24;
            animation: titleSlam 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            filter: drop-shadow(0 0 40px rgba(251, 191, 36, 0.8));
        }

        .victory-title-slam::before {
            content: '';
            position: absolute;
            inset: -30px;
            background:
                linear-gradient(45deg, transparent 40%, rgba(251, 191, 36, 0.3) 45%, rgba(251, 191, 36, 0.3) 55%, transparent 60%),
                linear-gradient(-45deg, transparent 40%, rgba(251, 191, 36, 0.3) 45%, rgba(251, 191, 36, 0.3) 55%, transparent 60%);
            z-index: -1;
            animation: impactLines 1s ease-out forwards;
        }

        @keyframes titleSlam {
            0% {
                transform: translateX(-50%) translateY(-200%);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(0%) scale(1.1);
            }
            80% {
                transform: translateX(-50%) translateY(0%) scale(0.95);
            }
            100% {
                transform: translateX(-50%) translateY(0%) scale(1);
                opacity: 1;
            }
        }

        @keyframes impactLines {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: 1; transform: scale(1.5); }
            100% { opacity: 0; transform: scale(2); }
        }

        /* Confetti Animation */
        .confetti-piece {
            position: fixed;
            width: 10px;
            height: 10px;
            z-index: 490;
            animation: confettiFall linear forwards;
            pointer-events: none;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Defeat Hero Stagger */
        .hero-stagger {
            animation: heroStagger 1s ease-in-out forwards !important;
        }

        @keyframes heroStagger {
            0% {
                transform: translateX(0) scale(1) rotate(0deg);
                filter: brightness(1);
            }
            10%, 30%, 50%, 70% {
                transform: translateX(-5px) scale(0.98) rotate(-2deg);
            }
            20%, 40%, 60%, 80% {
                transform: translateX(5px) scale(0.98) rotate(2deg);
            }
            100% {
                transform: translateX(0) scale(0.9) rotate(-5deg) skewX(-2deg);
                filter: brightness(0.7);
            }
        }

        /* Defeat Hero Retreat */
        .hero-retreat {
            animation: heroRetreat 1.5s ease-in forwards !important;
            filter: blur(0px);
        }

        @keyframes heroRetreat {
            0% {
                transform: translateX(0) scale(0.9) rotate(-5deg);
                opacity: 1;
                filter: blur(0px);
            }
            50% {
                filter: blur(3px);
            }
            100% {
                transform: translateX(-150%) scale(0.7) rotate(-15deg);
                opacity: 0;
                filter: blur(5px);
            }
        }

        /* Energy Trail for Retreat */
        .energy-trail {
            position: absolute;
            width: 200px;
            height: 100%;
            right: -50px;
            top: 0;
            pointer-events: none;
            z-index: -1;
            opacity: 0;
            animation: energyTrailFade 1.5s ease-out forwards;
        }

        @keyframes energyTrailFade {
            0% { opacity: 0; }
            30% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        /* Defeat Title Drop */
        .defeat-title-drop {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%) translateY(0);
            font-family: 'Bangers';
            font-size: 8rem;
            z-index: 500;
            color: #dc2626;
            text-shadow:
                4px 4px 0px #000,
                0 0 30px #dc2626;
            animation: titleDrop 1s cubic-bezier(0.34, 1.2, 0.64, 1) forwards;
            filter: drop-shadow(0 0 40px rgba(220, 38, 38, 0.8));
            opacity: 0;
        }

        .defeat-title-drop::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.3), transparent);
            animation: crackEffect 1s ease-out forwards;
        }

        @keyframes titleDrop {
            0% {
                transform: translateX(-50%) translateY(-50px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(5px);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        @keyframes crackEffect {
            0%, 50% { opacity: 0; }
            100% { opacity: 1; }
        }

        /* Villain Victory Pose */
        .villain-triumph {
            animation: villainTriumph 2s ease-in-out forwards !important;
            z-index: 350 !important;
        }

        @keyframes villainTriumph {
            0% {
                transform: scale(1);
                filter: brightness(1);
            }
            50% {
                transform: scale(1.15);
                filter: brightness(1.4) saturate(1.5);
            }
            100% {
                transform: scale(1.1);
                filter: brightness(1.3) saturate(1.3);
            }
        }

        /* Dark Particles for Villain Victory */
        .dark-particle {
            position: fixed;
            width: 8px;
            height: 8px;
            background: #7f1d1d;
            border-radius: 50%;
            z-index: 340;
            animation: darkParticleRise linear forwards;
            pointer-events: none;
            box-shadow: 0 0 10px #7f1d1d;
        }

        @keyframes darkParticleRise {
            0% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100vh) scale(0);
                opacity: 0;
            }
        }

        /* Screen Desaturation */
        .screen-desaturate {
            position: fixed;
            inset: 0;
            z-index: 380;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.3);
            animation: desaturateScreen 0.5s ease-out forwards;
        }

        @keyframes desaturateScreen {
            from {
                filter: grayscale(0);
                opacity: 0;
            }
            to {
                filter: grayscale(0.6);
                opacity: 1;
            }
        }

        /* Screen Vignette */
        .screen-vignette {
            position: fixed;
            inset: 0;
            z-index: 390;
            pointer-events: none;
            background: radial-gradient(circle at center, transparent 40%, rgba(0, 0, 0, 0.8) 100%);
            opacity: 0;
            animation: vignetteIn 1s ease-out forwards;
        }

        @keyframes vignetteIn {
            to { opacity: 1; }
        }

        /* Skip Button */
        .skip-cinematic-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 600;
            padding: 12px 24px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #fff;
            color: #fff;
            font-family: 'Rajdhani';
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            opacity: 0;
            animation: skipButtonFadeIn 0.3s ease-in forwards;
            transition: all 0.2s;
        }

        .skip-cinematic-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        @keyframes skipButtonFadeIn {
            to { opacity: 1; }
        }

        /* Gauntlet Champion Effects */
        .gauntlet-firework {
            position: fixed;
            z-index: 485;
            pointer-events: none;
        }

        .gauntlet-subtitle {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Bangers';
            font-size: 3rem;
            color: #a855f7;
            text-shadow: 0 0 20px #a855f7;
            z-index: 501;
            opacity: 0;
            animation: subtitleFadeIn 0.5s 0.5s ease-out forwards;
        }

        @keyframes subtitleFadeIn {
            to { opacity: 1; }
        }

        /* Speed Lines for Time Attack */
        .speed-line {
            position: fixed;
            height: 2px;
            background: linear-gradient(90deg, transparent, #fbbf24, transparent);
            top: 50%;
            right: 100%;
            z-index: 480;
            animation: speedLineZoom 0.3s ease-out forwards;
        }

        /* Record Flash Effect */
        .record-flash {
            position: fixed;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Bangers';
            font-size: 4rem;
            color: #fbbf24;
            text-shadow: 0 0 30px #fbbf24;
            z-index: 502;
            animation: recordFlash 1s ease-in-out infinite;
        }

        @keyframes recordFlash {
            0%, 100% { opacity: 1; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.5; transform: translateX(-50%) scale(1.1); }
        }

        /* Solo Victory Spotlight */
        .solo-spotlight {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at center, transparent 25%, rgba(0, 0, 0, 0.9) 70%);
            z-index: 395;
            pointer-events: none;
            animation: spotlightIn 1s ease-out forwards;
        }

        @keyframes spotlightIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== WORLD MAP STYLES ==================== */

        /* World Map Overlay */
        .world-map-overlay {
            position: fixed;
            inset: 0;
            z-index: 1500;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a12 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .world-map-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .world-map-container {
            width: 90%;
            max-width: 1400px;
            height: 85vh;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 27, 75, 0.9) 100%);
            border: 4px solid #fbbf24;
            border-radius: 20px;
            box-shadow: 0 0 60px rgba(251, 191, 36, 0.3);
            display: grid;
            grid-template-rows: auto 1fr auto;
            overflow: hidden;
            position: relative;
        }

        .world-map-header {
            padding: 2rem;
            text-align: center;
            border-bottom: 2px solid rgba(251, 191, 36, 0.3);
            position: relative;
        }

        .world-map-title {
            font-family: "Bangers", cursive;
            font-size: clamp(3rem, 6vw, 5rem);
            letter-spacing: 6px;
            background: linear-gradient(to right, #fff 20%, #fbbf24 40%, #fbbf24 60%, #fff 80%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }

        /* Map View */
        .map-view {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background:
                radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
        }

        .map-paths-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .map-regions {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        /* Region Nodes */
        .region-node {
            position: absolute;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 4px solid currentColor;
            background: rgba(0, 0, 0, 0.7);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            backdrop-filter: blur(5px);
        }

        .region-node:hover {
            transform: translate(-50%, -50%) scale(1.2);
            box-shadow: 0 0 40px currentColor;
            z-index: 10;
        }

        .region-node.locked {
            filter: grayscale(1) brightness(0.4);
            opacity: 0.5;
            cursor: not-allowed;
        }

        .region-node.locked:hover {
            transform: translate(-50%, -50%) scale(1);
            box-shadow: none;
        }

        .region-node.completed {
            box-shadow: 0 0 30px currentColor;
        }

        .region-icon {
            filter: drop-shadow(0 0 10px currentColor);
        }

        .completion-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #22c55e;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 15px #22c55e;
        }

        .progress-badge {
            position: absolute;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-family: "Rajdhani";
            font-weight: 700;
            white-space: nowrap;
            border: 1px solid currentColor;
        }

        .lock-badge {
            font-size: 2rem;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }

        /* Region Detail Panel */
        .region-detail-panel {
            padding: 2rem;
            background: rgba(0, 0, 0, 0.5);
            border-top: 2px solid rgba(251, 191, 36, 0.3);
            max-height: 300px;
            overflow-y: auto;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .region-detail-panel.active {
            opacity: 1;
        }

        .region-detail-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .region-detail-icon {
            font-size: 4rem;
            filter: drop-shadow(0 0 10px currentColor);
        }

        .region-detail-name {
            font-family: "Bangers";
            font-size: 2.5rem;
            letter-spacing: 2px;
            margin: 0;
        }

        .region-detail-difficulty {
            color: #fbbf24;
            font-size: 1.2rem;
            margin: 0.5rem 0;
        }

        .region-detail-desc {
            font-size: 1.1rem;
            color: #cbd5e1;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .region-detail-progress {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
        }

        .completed-badge {
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
        }

        .region-detail-villains,
        .region-detail-rewards {
            margin: 0.8rem 0;
            font-size: 1rem;
        }

        .region-detail-rewards div {
            margin: 0.3rem 0;
        }

        .enter-region-btn {
            margin-top: 1.5rem;
            padding: 1rem 3rem;
            font-family: "Bangers";
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-transform: uppercase;
        }

        .enter-region-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px currentColor;
        }

        .locked-message {
            margin-top: 1.5rem;
            padding: 1rem;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            color: #fca5a5;
        }

        /* Stage Select Overlay */
        .stage-select-overlay {
            position: fixed;
            inset: 0;
            z-index: 1600;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .stage-select-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .stage-select-container {
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            background: rgba(15, 23, 42, 0.98);
            border: 3px solid #a855f7;
            border-radius: 20px;
            padding: 2rem;
            overflow-y: auto;
            box-shadow: 0 0 50px rgba(168, 85, 247, 0.5);
        }

        .stage-select-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .stage-select-header h2 {
            font-family: "Bangers";
            font-size: 3rem;
            letter-spacing: 3px;
            margin: 0;
        }

        .stage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .stage-card {
            background: rgba(30, 27, 75, 0.8);
            border: 2px solid rgba(168, 85, 247, 0.5);
            border-radius: 15px;
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            position: relative;
        }

        .stage-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.4);
            border-color: #a855f7;
        }

        .stage-card.completed {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .stage-card.locked {
            filter: grayscale(1);
            opacity: 0.4;
            cursor: not-allowed;
        }

        .stage-card.locked:hover {
            transform: none;
            box-shadow: none;
        }

        .stage-number {
            font-family: "Bangers";
            font-size: 1.5rem;
            color: #a855f7;
            margin-bottom: 0.5rem;
        }

        .stage-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.8rem;
        }

        .stage-type {
            font-size: 0.9rem;
            color: #fbbf24;
            margin-bottom: 0.5rem;
        }

        .stage-reward {
            font-size: 0.9rem;
            color: #22d3ee;
        }

        .stage-complete-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #22c55e;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 0 15px #22c55e;
        }

        .stage-lock-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
        }

        /* Stage Intro Overlay */
        .stage-intro-overlay {
            position: fixed;
            inset: 0;
            z-index: 1700;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s;
        }

        .stage-intro-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .stage-intro-container {
            text-align: center;
        }

        .stage-intro-content {
            padding: 3rem;
        }

        .stage-intro-region {
            font-family: "Bangers";
            font-size: 2rem;
            letter-spacing: 3px;
            margin-bottom: 1rem;
            text-shadow: 0 0 20px currentColor;
        }

        .stage-intro-name {
            font-family: "Bangers";
            font-size: 4rem;
            color: white;
            letter-spacing: 4px;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .stage-intro-type {
            font-size: 1.5rem;
            color: #fbbf24;
            margin-bottom: 1rem;
            text-shadow: 0 0 15px #fbbf24;
        }

        .stage-intro-villain {
            font-size: 1.8rem;
            color: #ef4444;
            margin-bottom: 2rem;
            text-shadow: 0 0 20px #ef4444;
        }

        .stage-intro-begin-btn {
            padding: 1.5rem 4rem;
            font-family: "Bangers";
            font-size: 2rem;
            letter-spacing: 3px;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            text-transform: uppercase;
            box-shadow: 0 0 40px currentColor;
        }

        .stage-intro-begin-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 60px currentColor;
        }

        /* Locked Hero Card Styles */
        .hero-card.locked-hero {
            filter: grayscale(1) brightness(0.4);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .hero-card.locked-hero::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            z-index: 100;
            text-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .hero-card.locked-hero:hover {
            transform: none;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .region-node {
                width: 60px;
                height: 60px;
                font-size: 2rem;
            }

            .world-map-title {
                font-size: 2.5rem;
            }

            .stage-grid {
                grid-template-columns: 1fr;
            }

            .region-detail-icon {
                font-size: 3rem;
            }

            .region-detail-name {
                font-size: 2rem;
            }
        }
    </style>
</head>

<body>

    <div class="space-bg">
        <div class="stars"></div>
        <div class="stars md"></div>
        <div class="nebula-layer"></div>
    </div>
    <div class="grid-overlay"></div>
    <div id="flashOverlay"></div>
    <div id="elementalOverlay"></div>
    <div id="particleContainer"></div>
    
    <!-- SYNERGY OVERLAY CONTAINER -->
    <div id="synergyOverlay" class="synergy-overlay">
         <div id="synergyText" class="synergy-text"></div>
    </div>

    <!-- ITEM SELECTION OVERLAY -->
    <div id="itemSelectionOverlay" class="item-selection-overlay">
        <div class="item-selection-container">
            <div class="item-selection-title">CHOOSE YOUR GEAR</div>
            <div class="item-selection-counter" id="itemCounter">Select up to 2 items (0/2 Selected)</div>

            <div class="items-grid" id="itemsGrid">
                <!-- Items will be populated by JavaScript -->
            </div>

            <button class="enter-battle-btn" onclick="confirmItemSelection()">ENTER BATTLE</button>
        </div>
    </div>

    <div class="app">
        <header>
            <h1>Hawthorn <span style="color:#fbbf24; text-shadow: 0 0 30px #fbbf24;">Superheroes</span></h1>
            <div class="subtitle">Platinum Edition</div>
        </header>

        <div class="controls-bar">
            <div class="filter-group">
                <button class="filter-btn active" onclick="filterGrid('all', this)" style="--active-color:#fff">All</button>
                <button class="filter-btn" onclick="filterGrid('electric', this)" style="--active-color:#fbbf24">Electric</button>
                <button class="filter-btn" onclick="filterGrid('ice', this)" style="--active-color:#22d3ee">Ice</button>
                <button class="filter-btn" onclick="filterGrid('impact', this)" style="--active-color:#ef4444">Impact</button>
            </div>
            <div class="filter-group">
                 <button class="filter-btn" id="worldMapBtn" onclick="StoryModeSystem.openWorldMap()" title="World Map" style="background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24;"> World Map</button>
                 <button class="filter-btn battle-btn" id="muddlewickBtn" onclick="toggleBattleMode()"> Muddlewick has Chosen</button>
                 <button class="filter-btn" id="muteBtn" onclick="AudioEngine.toggleMute()" title="Toggle Sound"></button>
            </div>
        </div>
        
        <div id="battleInstructions" style="text-align:center; margin-bottom:1rem; color:#a855f7; font-weight:bold; display:none; text-transform:uppercase; letter-spacing:2px; animation:fadeSlideDown 0.5s forwards;">
             <div id="selectText" style="margin-bottom: 20px; font-size: 1.2rem;">Select 2 Heroes to Fight!</div>
             <button id="startFightBtn" class="battle-btn-initiate" onclick="openBattleArena()">INITIATE BATTLE</button>
        </div>

        <div id="heroGrid" class="hero-grid"></div>
    </div>

    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()">
        <div id="modalCard" class="modal-card" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeModal()"></div>
            <div class="modal-col-img">
                <img id="modalImage" class="modal-image-full">
                <div id="modalTypeBadge" class="modal-type-badge"
                    style="position:absolute; top:30px; left:30px; width:70px; height:70px; border-radius:12px; background:rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.2); color:#fff; display:flex; align-items:center; justify-content:center; font-size:2.5rem; backdrop-filter:blur(10px); z-index:5; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                </div>
            </div>
            <div class="modal-col-data">
                <div class="modal-header-group">
                    <div id="modalName" class="modal-name-display"></div>
                    <div id="modalRole" class="modal-role-display"></div>
                </div>
                <p id="modalDescription" class="modal-desc"></p>
                <div class="dashboard-grid">
                    <div class="dash-panel">
                        <div class="panel-label" style="font-size:0.7rem; text-transform:uppercase; color:#64748b; font-weight:800; margin-bottom:1.2rem; letter-spacing:2px; display:flex; justify-content:space-between;">
                            <span>Signature Moves</span> <span>PWR</span></div>
                        <div id="modalMoves"></div>
                    </div>
                    <div class="dash-panel">
                        <div class="panel-label" style="font-size:0.7rem; text-transform:uppercase; color:#64748b; font-weight:800; margin-bottom:1.2rem; letter-spacing:2px; display:flex; justify-content:space-between;">
                            <span>Attributes</span> <span>LVL</span></div>
                        <div id="modalStats"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- VILLAIN DOSSIER MODAL -->
    <div id="villainModal" class="modal-overlay" onclick="closeVillainModal()">
        <div class="modal-card villain-theme" onclick="event.stopPropagation()">
            <div class="close-btn" onclick="closeVillainModal()"></div>
            
            <div class="modal-col-img">
                <img id="vmImage" class="modal-image-full" style="filter: contrast(1.2) sepia(0.2);">
                <div class="warning-stripe" style="position:absolute; bottom:0; left:0;"></div>
                <div id="vmTypeBadge" class="modal-type-badge"
                    style="position:absolute; top:30px; left:30px; width:70px; height:70px; border-radius:12px; background:rgba(0,0,0,0.8); border:2px solid #ef4444; color:#ef4444; display:flex; align-items:center; justify-content:center; font-size:2.5rem; backdrop-filter:blur(10px); z-index:5; box-shadow:0 0 20px rgba(239, 68, 68, 0.4);">
                </div>
            </div>
            
            <div class="modal-col-data">
                <div class="villain-header-band">
                    <span> THREAT ASSESSMENT </span>
                </div>
                
                <div class="modal-header-group">
                    <div id="vmName" class="modal-name-display" style="color:#fff; -webkit-text-fill-color: initial; background: none; text-shadow: 0 0 20px rgba(0,0,0,0.5);"></div>
                    <div id="vmType" class="modal-role-display" style="color:#ef4444;"></div>
                </div>
                
                <p id="vmDesc" class="modal-desc" style="border-left-color: #ef4444; color: #e2e8f0;"></p>
                
                <div class="dashboard-grid">
                    <div class="dash-panel" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="panel-label" style="color: #ef4444;">Combat Profile</div>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size:0.8rem; color:#94a3b8; text-transform:uppercase; font-weight:700;">Signature Move</div>
                            <div id="vmSignature" style="font-family:'Bangers'; font-size:1.6rem; color:#fff; letter-spacing:1px;"></div>
                        </div>
                        <div class="weakness-box">
                            <div id="vmWeakness"></div>
                        </div>
                    </div>
                    
                    <div class="dash-panel" style="border-color: rgba(239, 68, 68, 0.3);">
                        <div class="panel-label" style="color: #ef4444;">Threat Stats</div>
                        <div id="vmStats"></div>
                    </div>
                </div>

                <!-- NEW START BUTTON -->
                <button id="vmStartBtn" class="battle-btn-commence" onclick="enterArena()">ENTER BATTLE ARENA</button>
            </div>
        </div>
    </div>
    
    <div id="battleOverlay" class="battle-overlay">
         <div class="battle-stage" id="battleStage">
              <div class="close-btn" onclick="closeBattle()"></div>
              
              <div id="combatStartOverlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; z-index:100; background:rgba(0,0,0,0.4); backdrop-filter:blur(2px);">
                  <button class="battle-btn-commence" onclick="beginCombatSequence()">START COMBAT</button>
              </div>
              
              <!-- POST BATTLE MODAL (NEW) -->
              <div id="postBattleModal" class="post-battle-modal">
                   <div class="victory-header" id="pbTitle">VICTORY!</div>
                   <div class="star-row" id="pbStars">
                       <!-- Stars injected by JS -->
                   </div>
                   <div class="score-details" id="pbScore">
                       <!-- Score details injected by JS -->
                   </div>
                   <button class="battle-btn-commence" onclick="closeBattle()">CONTINUE</button>
              </div>

              <div class="battle-header">
                   <div class="battle-title" id="battleTitle">BOSS BATTLE</div>
              </div>
              
              <div class="battle-area">
                   <div class="side" id="villainSide">
                        <h2 style="color:#a855f7; font-family:'Bangers'; letter-spacing:2px; margin-bottom:0;" id="villainName">Baddie</h2>
                        <button class="dossier-btn" onclick="openVillainModal()"> View Dossier</button>
                        <div style="position:relative; display:inline-block; margin-top: 10px;">
                            <img id="villainImg" class="side-img" src="">
                        </div>
                        <div class="hp-bar-container">
                             <div id="villainHP" class="hp-fill hp-villain"></div>
                        </div>
                   </div>
                   
                   <div style="font-family:'Bangers'; font-size:4rem; color:#fff; text-shadow:0 0 20px white;">VS</div>
                   
                   <div class="side" id="heroesSide">
                        <h2 style="color:#22c55e; font-family:'Bangers'; letter-spacing:2px; margin-bottom:10px;">The Heroes</h2>
                        <div style="display:flex; justify-content:center; gap:10px;">
                             <div style="position:relative;">
                                <img id="hero1Img" class="side-img" style="width:100px; height:100px;" src="">
                             </div>
                             <div style="position:relative;">
                                <img id="hero2Img" class="side-img" style="width:100px; height:100px;" src="">
                             </div>
                        </div>
                        <div class="hp-bar-container">
                             <div id="heroesHP" class="hp-fill hp-heroes"></div>
                        </div>
                   </div>
              </div>

              <!-- BATTLE ITEMS CONTAINER -->
              <div class="battle-items-container" id="battleItemsContainer">
                  <button class="battle-item-btn" id="battleItem0" onclick="useBattleItem(0)" style="display:none;">
                      <span class="item-icon"></span><span class="item-name"></span>
                  </button>
                  <button class="battle-item-btn" id="battleItem1" onclick="useBattleItem(1)" style="display:none;">
                      <span class="item-icon"></span><span class="item-name"></span>
                  </button>
              </div>

              <div class="battle-log">
                   <span id="battleText">Waiting for command...</span>
              </div>
         </div>
    </div>

    <!-- WORLD MAP OVERLAY -->
    <div class="world-map-overlay" id="worldMapOverlay">
        <div class="world-map-container">
            <div class="world-map-header">
                <h1 class="world-map-title">WORLD MAP</h1>
                <button class="close-btn" onclick="StoryModeSystem.closeWorldMap()"></button>
            </div>
            <div class="map-view">
                <svg class="map-paths-svg" id="worldMapPaths" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <!-- Paths will be rendered here -->
                </svg>
                <div class="map-regions" id="worldMapContainer">
                    <!-- Region nodes will be rendered here -->
                </div>
            </div>
            <div class="region-detail-panel" id="regionDetailPanel">
                <p style="text-align:center; color:#666;">Select a region to view details</p>
            </div>
        </div>
    </div>

    <!-- STAGE SELECT OVERLAY -->
    <div class="stage-select-overlay" id="stageSelectOverlay">
        <div class="stage-select-container" id="stageSelectContainer">
            <!-- Stage selection will be rendered here -->
        </div>
    </div>

    <!-- STAGE INTRO OVERLAY -->
    <div class="stage-intro-overlay" id="stageIntroOverlay">
        <div class="stage-intro-container" id="stageIntroContainer">
            <!-- Stage intro will be rendered here -->
        </div>
    </div>

    <script>
        /* HERO DATA */
        const heroes = [
            { id: "art", type: "electric", icon: "", role: "Speedster Class", name: "Art", alias: "Velocity", image: "images/art.png", pronoun: "his", description: "The fastest kid alive! Art can race around the entire world before his breakfast toast pops up. When he runs, he leaves a golden lightning trail behind him. Nothing can slow him down. He zooms up tall buildings, runs across oceans like they're nothing, and can even vibrate so fast that he becomes invisible! Last week, he stopped a runaway train by running in front of it and pushing it to a stop. His super speed also makes his brain work faster, so he can read an entire book in three seconds and ace every test!", moves: [{ name: "Hypersonic Sprint", pwr: 94 }, { name: "Vertical Wall Run", pwr: 75 }, { name: "Vacuum Funnel", pwr: 88 }], stats: { bravery: 4, speed: 5, strength: 3, teamwork: 4, focus: 5 } },
            { id: "alexei", type: "electric", icon: "", role: "Tech Artificer", name: "Alexei", alias: "Magnet Master", image: "images/alexei.png", pronoun: "his", description: "A genius inventor with magnetic superpowers! Alexei can sense every piece of metal around him, even if it's hidden inside walls. He can pull metal objects to him from across the room and reshape them with his mind. Once, he turned old bike parts into a flying drone in under a minute! When the team needed to cross a river, he lifted a metal bridge from the scrapyard and moved it into place. He's built hundreds of gadgets in his secret workshop, and he always carries spare parts in his backpack for emergency inventions. His best creation? A magnetic skateboard that can ride up walls!", moves: [{ name: "Magnetic Crush", pwr: 90 }, { name: "Scrap Shield", pwr: 85 }, { name: "Tech Disruption", pwr: 70 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 5 } },
            { id: "florrie", type: "ice", icon: "", role: "Cryomancer", name: "Florrie", alias: "Frostbeam", image: "images/florrie.png", pronoun: "her", description: "The coolest hero in town, literally! With just a touch, Florrie can freeze anything solid. She creates beautiful ice sculptures that come to life as frozen guardians to protect the team. She can freeze the water in the air to make ice bridges, walls, or even ice slides to surf on! During one battle, she froze an entire lake in two seconds to stop enemies from escaping. When she's really focused, she can lower the temperature of an entire room to freezing. Her breath creates icy fog that she uses to hide her team from enemies. She once made an ice palace that lasted all summer!", moves: [{ name: "Flash Freeze", pwr: 88 }, { name: "Glacial Wall", pwr: 92 }, { name: "Ice Slide", pwr: 65 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 4 } },
            { id: "joshua", type: "impact", icon: "", role: "Guardian Tank", name: "Joshua", alias: "Shield Guardian", image: "images/joshua.png", pronoun: "his", description: "The ultimate protector! Joshua's shield isn't made of metal. It's pure energy that glows bright blue. Every time something hits his shield, it makes it stronger! He can absorb the force of explosions, laser beams, or super strong punches, then release that energy as protective force fields around his teammates. During a robot attack, he absorbed twenty laser blasts and then reflected them all back at once! Joshua is also incredibly brave and will always put himself between danger and his friends. His shield can grow big enough to protect an entire building from falling debris!", moves: [{ name: "Titan Charge", pwr: 95 }, { name: "Energy Reflect", pwr: 85 }, { name: "Shield Bash", pwr: 80 }], stats: { bravery: 5, speed: 3, strength: 4, teamwork: 5, focus: 3 } },
            { id: "lulu", type: "electric", icon: "", role: "Speed Striker", name: "Lulu", alias: "Red Comet", image: "images/lulu.png", pronoun: "his", description: "A crimson speedster who moves so fast he's just a red blur! Lulu vibrates his body at super high speeds, which lets him phase through solid walls like a ghost. He can disrupt electronic locks and security systems just by touching them. When he runs at top speed, he creates sonic booms and can run up walls and even across ceilings! During a bank robbery, he vibrated through the vault door, grabbed the money back, and returned it before the robbers even knew what happened. His speed is so incredible that he can be in three different places in the same second, making it look like there are multiple Lulus fighting at once!", moves: [{ name: "Mach-1 Strike", pwr: 93 }, { name: "Red Blur", pwr: 82 }, { name: "After-Image", pwr: 70 }], stats: { bravery: 5, speed: 5, strength: 3, teamwork: 5, focus: 4 } },
            { id: "manny", type: "impact", icon: "", role: "Heavy Hitter", name: "Manny", alias: "Earth Hammer", image: "images/manny.png", pronoun: "his", description: "Connected to the planet itself! Manny can feel vibrations through the ground and knows when trouble is coming from miles away. When he punches the ground, he creates earthquakes that only affect bad guys. He's the strongest hero on the team and can lift cars, buses, or even small buildings! When a skyscraper started to collapse, Manny held it up with his bare hands while everyone evacuated. When he plants his feet, nothing can move him. He becomes as solid as a mountain. He also talks to rocks and can make stone walls rise up from the ground to protect his team. Once, he created an entire stone fortress in ten seconds!", moves: [{ name: "Seismic Slam", pwr: 96 }, { name: "Tremor Wave", pwr: 85 }, { name: "Fortify", pwr: 90 }], stats: { bravery: 5, speed: 2, strength: 5, teamwork: 5, focus: 3 } },
            { id: "maurits", type: "ice", icon: "", role: "Storm Mage", name: "Maurits", alias: "Storm Caller", image: "images/maurits.png", pronoun: "his", description: "Master of the weather! Maurits can summon thunderstorms, blizzards, and hurricanes with a wave of his hand. He rides on storm clouds like they're magic carpets and can call down lightning strikes with pinpoint accuracy. When a forest fire threatened the city, he summoned a rainstorm that put it out in minutes. When he's angry, the sky turns dark and thunder rumbles overhead. He can also create gentle rain to help plants grow or thick fog to hide his team. His eyes glow bright white when he uses his weather powers, and he can sense changes in the atmosphere before anyone else. He once created a small tornado to lift a cat safely out of a tree!", moves: [{ name: "Lightning Bolt", pwr: 94 }, { name: "Blizzard Howl", pwr: 88 }, { name: "Fog Cover", pwr: 60 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 5 } },
            { id: "noa", type: "impact", icon: "", role: "Sniper Scout", name: "Noa", alias: "Sky Archer", image: "images/noa.png", pronoun: "her", description: "She never misses! Noa's eyes can zoom in like a telescope, letting her see dangers from three miles away. She can even see in the dark and spot invisible enemies! Her bow creates arrows made of pure energy that can explode, freeze, or electrify on impact. The amazing part? Her arrows can curve around buildings and obstacles to hit targets she can't even see directly. Last month, she shot an arrow that curved around five buildings to stop a getaway car! She's also an expert tracker and can follow trails that are days old. She once found a lost puppy by following its tiny paw prints across the entire city!", moves: [{ name: "Sure Shot", pwr: 95 }, { name: "Eagle Eye", pwr: 50 }, { name: "Ricochet Arrow", pwr: 82 }], stats: { bravery: 4, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "noah", type: "ice", icon: "", role: "Sonic Controller", name: "Noah", alias: "Soundwave", image: "images/noah.png", pronoun: "her", description: "The hero who controls all sound! Noah can hear a whisper from across the city and knows every sound by heart. She can create zones of total silence where no one can hear anything, perfect for sneaky missions. When she wants to, she releases sonic booms powerful enough to shatter steel and knock back enemies without hurting her friends. During an alien invasion, she used a sonic blast to crack open their spaceship's hull! Noah can also mimic any voice perfectly and use echolocation like a bat to see in complete darkness. When she concentrates, she can even make sounds solid, creating sound walls for protection. She once sang a note so perfect it made everyone cry happy tears!", moves: [{ name: "Sonic Boom", pwr: 91 }, { name: "Silence Bubble", pwr: 70 }, { name: "Echo Pulse", pwr: 85 }], stats: { bravery: 4, speed: 3, strength: 3, teamwork: 5, focus: 4 } },
            { id: "phaedra", type: "ice", icon: "", role: "Wind Dancer", name: "Phaedra", alias: "Whirlwind", image: "images/phaedra.png", pronoun: "her", description: "She dances on air and commands the wind! Phaedra can fly by riding wind currents and never needs to touch the ground. She creates tornadoes that lift enemies into the sky, gentle breezes that catch falling people, and wind barriers that deflect bullets and energy blasts. When a bus full of kids drove off a bridge, she created a cushion of air that gently lowered it to the ground! When she spins, she becomes a human hurricane that can blow away anything in her path. She can also sense changes in air pressure, which means she knows when something's about to happen. Her greatest trick? Making air so thick it becomes like an invisible cushion to save people from any fall!", moves: [{ name: "Tornado Spin", pwr: 96 }, { name: "Hurricane Blast", pwr: 92 }, { name: "Air Cushion", pwr: 82 }], stats: { bravery: 4, speed: 5, strength: 3, teamwork: 5, focus: 5 } },
            { id: "rex", type: "electric", icon: "", role: "Trickster", name: "Rex", alias: "Triple Strike", image: "images/rex.png", pronoun: "his", description: "The boy who exists in three places at once! Rex has mastered time powers that let him split into three identical copies. Each copy can think and act independently, making him the ultimate multitasker! His time abilities also let him glimpse a few seconds into the future, so he can dodge attacks before they even happen. During one mission, his three copies surrounded a villain from all sides and caught him in three seconds! When his three copies work together, they can pull off combination moves that seem impossible. Sometimes he uses his power to try something, see if it works, then rewind time to do it perfectly. He once aced a test by seeing the questions in the future!", moves: [{ name: "Tri-Attack", pwr: 92 }, { name: "Clone Swap", pwr: 75 }, { name: "Confusion", pwr: 65 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 3 } },
            { id: "rory", type: "impact", icon: "", role: "Duelist", name: "Rory", alias: "Blue Flash", image: "images/rory.png", pronoun: "his", description: "A plasma blade master! Rory's twin swords aren't metal. They're made of super hot blue plasma that can slice through almost anything. He moves like lightning in combat, his blades creating dazzling patterns of blue light. He's mastered an ancient sword fighting style that he learned from mysterious warrior monks. When a giant robot attacked downtown, he sliced it into pieces in under five seconds! Rory can also use his blades to deflect energy attacks back at enemies and even cut through solid steel doors. When he focuses his energy, his swords extend into long plasma whips that can reach enemies fifty feet away!", moves: [{ name: "Blade Dance", pwr: 93 }, { name: "Cross Slash", pwr: 88 }, { name: "Flash Cut", pwr: 90 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "viola", type: "impact", icon: "", role: "Blade Master", name: "Viola", alias: "Twin Saber", image: "images/viola.png", pronoun: "her", description: "The most graceful fighter you'll ever see! Viola's twin energy sabers glow with purple light and can cut through any material. She fights like she's dancing, flowing around attacks and using her opponents' own force against them. Her incredible reflexes let her deflect bullets and energy blasts with her sabers. Once, she deflected a hundred laser shots in ten seconds without getting hit once! Viola can also create temporary energy shields with her blades and throw them like boomerangs that always return to her hands. She's trained in twelve different martial arts and never wastes a single movement. In one battle, she disarmed twenty robots without breaking a sweat!", moves: [{ name: "Saber Deflect", pwr: 94 }, { name: "Twin Strike", pwr: 89 }, { name: "Pushback", pwr: 80 }], stats: { bravery: 5, speed: 4, strength: 3, teamwork: 5, focus: 4 } },
            { id: "wilbur", type: "impact", icon: "", role: "Titan", name: "Wilbur", alias: "Titan Punch", image: "images/wilbur.png", pronoun: "his", description: "The gentle giant with the strength of a hundred men! Despite being the strongest person on Earth, Wilbur is kind and uses his power carefully. He can lift entire trucks over his head, punch through concrete walls, and create shockwaves by clapping his hands together. When an earthquake hit the city, he held up a collapsing building for two hours while people escaped! His incredible strength also makes him nearly invincible. Bullets bounce off his skin! Wilbur loves using his power to help people by lifting fallen trees, moving heavy debris after disasters, and carrying people to safety. When he stomps, the ground shakes for blocks. He once arm wrestled a tank and won!", moves: [{ name: "Mega Punch", pwr: 98 }, { name: "Ground Breaker", pwr: 92 }, { name: "Atlas Lift", pwr: 85 }], stats: { bravery: 5, speed: 3, strength: 5, teamwork: 5, focus: 4 } },
            { id: "zane", type: "electric", icon: "", role: "Technomancer", name: "Zane", alias: "Storm Pulse", image: "images/zane.png", pronoun: "his", description: "A walking power plant! Zane's body crackles with lightning and electricity at all times. He can drain power from any machine nearby to supercharge himself, or share his energy to power up broken devices. His lightning bolts are so precise he can hit targets the size of a coin from across the room. When the city had a blackout, he powered the entire hospital with his electricity for three days! Zane can also create EMP pulses that shut down all electronics in an area, perfect for stopping robots and tech villains. When he's fully charged, electricity arcs between his fingertips and his hair stands straight up. He never needs to charge his phone because he IS the charger!", moves: [{ name: "Overload", pwr: 95 }, { name: "Static Shock", pwr: 85 }, { name: "EMP Blast", pwr: 90 }], stats: { bravery: 5, speed: 5, strength: 3, teamwork: 5, focus: 4 } }
        ];
        heroes.sort((a, b) => a.name.localeCompare(b.name));

        // UPDATED: Villains now have elemental types for strategic matchups
        const villains = [
             { 
                 name: "Neon Tiger", 
                 type: "electric", 
                 img: "images/tiger.png", 
                 move: "Razor Slash",
                 description: "A genetically enhanced predator escaped from a secret lab. Covered in bioluminescent stripes that crackle with stolen electricity, it stalks the neon-lit streets hunting for energy sources to drain.",
                 stats: { danger: 4, speed: 5, cunning: 3, power: 3 },
                 weakness: "Ground/Impact attacks disrupt its electrical field.",
                 signature: "Voltage Claw"
             },
             { 
                 name: "Cyber Grizzly", 
                 type: "impact", 
                 img: "images/bear.png", 
                 move: "Crushing Maul",
                 description: "A robotic beast built from scrapped military hardware. Its crushing strength can flatten cars like tin cans, and its roar creates sonic shockwaves that shatter glass.",
                 stats: { danger: 5, speed: 2, cunning: 2, power: 5 },
                 weakness: "Cold temperatures freeze its hydraulic fluid.",
                 signature: "Titan Bite"
             },
             { 
                 name: "Shadow Panther", 
                 type: "ice", 
                 img: "images/panthers.png", 
                 move: "Silent Strike",
                 description: "A spectral feline that phases between dimensions. Leaves trails of freezing mist wherever it stalks, lowering the ambient temperature to absolute zero in seconds.",
                 stats: { danger: 4, speed: 5, cunning: 5, power: 3 },
                 weakness: "Bright electrical flashes disrupt its stealth cloak.",
                 signature: "Frost Bite"
             },
             { 
                 name: "Thunder Gorilla", 
                 type: "electric", 
                 img: "images/gorilla.png", 
                 move: "Seismic Smash",
                 description: "An ancient primate awakened by a lightning strike. Channels storm energy through its massive fists, capable of generating localized thunderstorms when it beats its chest.",
                 stats: { danger: 5, speed: 3, cunning: 3, power: 5 },
                 weakness: "Ice can ground its electrical discharge.",
                 signature: "Storm Slam"
             },
             { 
                 name: "Omega Droid", 
                 type: "impact", 
                 img: "images/robot.png", 
                 move: "Plasma Beam",
                 description: "The final creation of a mad inventor. Cold, calculating, and programmed only to destroy. It learns from every battle, upgrading its armor in real-time.",
                 stats: { danger: 5, speed: 4, cunning: 5, power: 4 },
                 weakness: "Overloads from excessive electricity.",
                 signature: "Annihilation Beam"
             }
        ];

        /* --- WORLD MAP / STORY MODE DATA --- */

        // World Regions Configuration
        const WORLD_REGIONS = {
            downtown: {
                id: "downtown",
                name: "Downtown City",
                description: "The bustling heart of the city where heroes first appear",
                theme: "urban",
                color: "#3b82f6",
                icon: "",
                position: { x: 20, y: 50 }, // Position on map (%)
                difficulty: 1,
                totalStages: 5,
                villains: ["Neon Tiger"],
                unlockRequirement: null, // Always unlocked
                rewards: {
                    heroes: [], // No new heroes unlocked here (starting heroes)
                    xpBonus: 100
                }
            },

            frozen_peaks: {
                id: "frozen_peaks",
                name: "Frozen Peaks",
                description: "Treacherous mountains where cold-hearted villains hide",
                theme: "ice",
                color: "#22d3ee",
                icon: "",
                position: { x: 35, y: 25 },
                difficulty: 2,
                totalStages: 5,
                villains: ["Shadow Panther"],
                unlockRequirement: { region: "downtown", completed: true },
                rewards: {
                    heroes: ["florrie", "maurits"], // Unlock these heroes
                    xpBonus: 200
                }
            },

            thunder_jungle: {
                id: "thunder_jungle",
                name: "Thunder Jungle",
                description: "Ancient jungle where primal forces clash",
                theme: "electric",
                color: "#fbbf24",
                icon: "",
                position: { x: 35, y: 75 },
                difficulty: 2,
                totalStages: 5,
                villains: ["Thunder Gorilla"],
                unlockRequirement: { region: "downtown", completed: true },
                rewards: {
                    heroes: ["zane", "art"],
                    xpBonus: 200
                }
            },

            iron_fortress: {
                id: "iron_fortress",
                name: "Iron Fortress",
                description: "A massive industrial complex of gears and danger",
                theme: "impact",
                color: "#f97316",
                icon: "",
                position: { x: 60, y: 50 },
                difficulty: 3,
                totalStages: 6,
                villains: ["Cyber Grizzly"],
                unlockRequirement: {
                    anyOf: ["frozen_peaks", "thunder_jungle"],
                    completed: true
                },
                rewards: {
                    heroes: ["wilbur", "manny"],
                    xpBonus: 300
                }
            },

            omega_tower: {
                id: "omega_tower",
                name: "Omega Tower",
                description: "The final confrontation awaits at the top",
                theme: "tech",
                color: "#a855f7",
                icon: "",
                position: { x: 80, y: 50 },
                difficulty: 4,
                totalStages: 7,
                villains: ["Omega Droid"],
                unlockRequirement: { region: "iron_fortress", completed: true },
                rewards: {
                    heroes: [],
                    xpBonus: 500,
                    special: "legendary_card" // Special reward
                }
            },

            secret_dimension: {
                id: "secret_dimension",
                name: "Secret Dimension",
                description: "Cosmic realm where all challenges are remixed",
                theme: "cosmic",
                color: "#ec4899",
                icon: "",
                position: { x: 50, y: 10 },
                difficulty: 5,
                totalStages: 8,
                villains: ["Neon Tiger", "Shadow Panther", "Thunder Gorilla", "Cyber Grizzly", "Omega Droid"],
                unlockRequirement: {
                    allRegionsCompleted: true,
                    completion: 100
                },
                rewards: {
                    heroes: [],
                    xpBonus: 1000,
                    special: "ultimate_champion"
                }
            }
        };

        // Stage definitions for each region
        const REGION_STAGES = {
            downtown: [
                { stageNumber: 1, name: "Street Patrol", type: "battle", difficulty: "miniboss", rewards: { xp: 50 } },
                { stageNumber: 2, name: "Rooftop Chase", type: "battle", difficulty: "boss", rewards: { xp: 75 } },
                { stageNumber: 3, name: "Subway Showdown", type: "battle", difficulty: "boss", rewards: { xp: 75 } },
                { stageNumber: 4, name: "Night Raid", type: "battle", difficulty: "elite", rewards: { xp: 100 } },
                { stageNumber: 5, name: "Neon Tiger's Den", type: "boss", villain: "Neon Tiger", rewards: { xp: 150 } }
            ],
            frozen_peaks: [
                { stageNumber: 1, name: "Ice Cave Entry", type: "battle", difficulty: "miniboss", rewards: { xp: 75 } },
                { stageNumber: 2, name: "Avalanche Run", type: "battle", difficulty: "boss", rewards: { xp: 100 } },
                { stageNumber: 3, name: "Frost Bridge", type: "battle", difficulty: "boss", rewards: { xp: 100 } },
                { stageNumber: 4, name: "Frozen Temple", type: "battle", difficulty: "elite", rewards: { xp: 125 } },
                { stageNumber: 5, name: "Panther's Lair", type: "boss", villain: "Shadow Panther", rewards: { xp: 200 } }
            ],
            thunder_jungle: [
                { stageNumber: 1, name: "Jungle Path", type: "battle", difficulty: "miniboss", rewards: { xp: 75 } },
                { stageNumber: 2, name: "Ancient Ruins", type: "battle", difficulty: "boss", rewards: { xp: 100 } },
                { stageNumber: 3, name: "Storm Clearing", type: "battle", difficulty: "boss", rewards: { xp: 100 } },
                { stageNumber: 4, name: "Thunder Falls", type: "battle", difficulty: "elite", rewards: { xp: 125 } },
                { stageNumber: 5, name: "Gorilla King's Domain", type: "boss", villain: "Thunder Gorilla", rewards: { xp: 200 } }
            ],
            iron_fortress: [
                { stageNumber: 1, name: "Factory Floor", type: "battle", difficulty: "miniboss", rewards: { xp: 100 } },
                { stageNumber: 2, name: "Assembly Line", type: "battle", difficulty: "boss", rewards: { xp: 125 } },
                { stageNumber: 3, name: "Furnace Room", type: "battle", difficulty: "boss", rewards: { xp: 125 } },
                { stageNumber: 4, name: "Control Center", type: "battle", difficulty: "elite", rewards: { xp: 150 } },
                { stageNumber: 5, name: "Robot Arena", type: "battle", difficulty: "elite", rewards: { xp: 175 } },
                { stageNumber: 6, name: "Grizzly's Core", type: "boss", villain: "Cyber Grizzly", rewards: { xp: 250 } }
            ],
            omega_tower: [
                { stageNumber: 1, name: "Tower Entrance", type: "battle", difficulty: "boss", rewards: { xp: 125 } },
                { stageNumber: 2, name: "Security Floor", type: "battle", difficulty: "boss", rewards: { xp: 150 } },
                { stageNumber: 3, name: "Data Core", type: "battle", difficulty: "elite", rewards: { xp: 175 } },
                { stageNumber: 4, name: "Power Station", type: "battle", difficulty: "elite", rewards: { xp: 200 } },
                { stageNumber: 5, name: "Elite Guards", type: "battle", difficulty: "elite", rewards: { xp: 225 } },
                { stageNumber: 6, name: "Command Center", type: "battle", difficulty: "elite", rewards: { xp: 250 } },
                { stageNumber: 7, name: "Omega's Chamber", type: "boss", villain: "Omega Droid", rewards: { xp: 500 } }
            ],
            secret_dimension: [
                { stageNumber: 1, name: "Cosmic Gateway", type: "battle", difficulty: "elite", rewards: { xp: 200 } },
                { stageNumber: 2, name: "Void Maze", type: "battle", difficulty: "elite", rewards: { xp: 250 } },
                { stageNumber: 3, name: "Star Chamber", type: "boss", villain: "Neon Tiger", rewards: { xp: 300 } },
                { stageNumber: 4, name: "Dimension Rift", type: "boss", villain: "Shadow Panther", rewards: { xp: 300 } },
                { stageNumber: 5, name: "Thunder Plains", type: "boss", villain: "Thunder Gorilla", rewards: { xp: 300 } },
                { stageNumber: 6, name: "Iron Citadel", type: "boss", villain: "Cyber Grizzly", rewards: { xp: 300 } },
                { stageNumber: 7, name: "Final Trial", type: "boss", villain: "Omega Droid", rewards: { xp: 400 } },
                { stageNumber: 8, name: "Ultimate Challenge", type: "boss", villain: "Omega Droid", rewards: { xp: 1000 } }
            ]
        };

        /* --- BATTLE ITEMS --- */
        const BATTLE_ITEMS = {
            health_potion: {
                id: "health_potion",
                name: "Health Potion",
                icon: "",
                description: "Restore 30 HP to your heroes",
                effect: "heal",
                value: 30,
                rarity: "common",
                uses: 1
            },

            shield_boost: {
                id: "shield_boost",
                name: "Shield Boost",
                icon: "",
                description: "Reduce incoming damage by 50% for 3 turns",
                effect: "defense",
                value: 0.5,
                duration: 3,
                rarity: "common",
                uses: 1
            },

            critical_charm: {
                id: "critical_charm",
                name: "Critical Strike Charm",
                icon: "",
                description: "Guarantee critical hits for 2 turns",
                effect: "critical",
                duration: 2,
                rarity: "rare",
                uses: 1
            },

            energy_surge: {
                id: "energy_surge",
                name: "Energy Surge",
                icon: "",
                description: "Instantly fill 50% of synergy meter",
                effect: "synergy",
                value: 50,
                rarity: "rare",
                uses: 1
            },

            smoke_bomb: {
                id: "smoke_bomb",
                name: "Smoke Bomb",
                icon: "",
                description: "Dodge the next enemy attack guaranteed",
                effect: "dodge",
                duration: 1,
                rarity: "uncommon",
                uses: 1
            },

            power_crystal: {
                id: "power_crystal",
                name: "Power Crystal",
                icon: "",
                description: "Increase all damage by 40% for 3 turns",
                effect: "damage",
                value: 0.4,
                duration: 3,
                rarity: "rare",
                uses: 1
            }
        };

        /* --- PRELOADER --- */
        function preloadImages() {
            const imageUrls = [...heroes.map(h => h.image), ...villains.map(v => v.img)];
            imageUrls.forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }
        window.addEventListener('load', preloadImages);

        /* --- AUDIO ENGINE & MUSIC SYNTH --- */
        const AudioEngine = {
            ctx: null,
            interval: null,
            isMuted: false,
            
            init: function () { 
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    // Load saved state
                    const savedMute = localStorage.getItem('hawthorn_muted');
                    if(savedMute === 'true') {
                        this.isMuted = true;
                        document.getElementById('muteBtn').innerText = '';
                    }
                } 
            },

            toggleMute: function() {
                this.init();
                this.isMuted = !this.isMuted;
                localStorage.setItem('hawthorn_muted', this.isMuted);
                
                const btn = document.getElementById('muteBtn');
                btn.innerText = this.isMuted ? '' : '';

                if(this.isMuted) this.stopMusic();
                else if(isBattleActive) this.startMusic();
            },

            playTone: function(freq, type, duration) {
                if(this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            },

            // Soft "Cinematic Heartbeat" Music Generator
            startMusic: function(isDanger = false) {
                if(this.isMuted || !this.ctx) { this.init(); return; }
                if(this.interval) clearInterval(this.interval);
                
                this.ctx.resume();
                let beat = 0;
                // TEMPO INCREASES IN DANGER MODE
                const tempo = isDanger ? 300 : 600; 
                
                this.interval = setInterval(() => {
                    const t = this.ctx.currentTime;
                    // KICK DRUM
                    const osc = this.ctx.createOscillator();
                    const gain = this.ctx.createGain();
                    osc.type = 'sine';
                    osc.connect(gain); gain.connect(this.ctx.destination);
                    osc.frequency.setValueAtTime(isDanger ? 120 : 100, t); // Higher pitch danger kick
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);
                    gain.gain.setValueAtTime(0.3, t);
                    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.5);
                    osc.start(t); osc.stop(t + 0.5);

                    // BASS
                    if(beat % 2 !== 0) {
                        const bassOsc = this.ctx.createOscillator();
                        const bassGain = this.ctx.createGain();
                        bassOsc.type = 'sine';
                        bassOsc.connect(bassGain); bassGain.connect(this.ctx.destination);
                        bassOsc.frequency.setValueAtTime(isDanger ? 60 : 50, t); 
                        bassOsc.frequency.linearRampToValueAtTime(40, t + 0.4);
                        bassGain.gain.setValueAtTime(0.1, t);
                        bassGain.gain.linearRampToValueAtTime(0, t + 0.5);
                        bassOsc.start(t); bassOsc.stop(t + 0.5);
                    }
                    beat++;
                }, tempo);
            },

            stopMusic: function() {
                if(this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            },

            hitSound: function() {
                if(this.isMuted || !this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.2);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.2);
            }
        };

        // Auto-Init Audio
        document.addEventListener('click', () => { AudioEngine.init(); }, { once: true });

        /* --- VISUAL EFFECTS SYSTEM --- */
        const VisualFX = {
            // Projectile launcher
            fireProjectile: function(fromElement, toElement, type) {
                const stage = document.getElementById('battleStage');
                const fromRect = fromElement.getBoundingClientRect();
                const toRect = toElement.getBoundingClientRect();
                const stageRect = stage.getBoundingClientRect();

                const startX = fromRect.left + fromRect.width/2 - stageRect.left;
                const startY = fromRect.top + fromRect.height/2 - stageRect.top;
                const endX = toRect.left + toRect.width/2 - stageRect.left;
                const endY = toRect.top + toRect.height/2 - stageRect.top;

                // Color based on type
                const colors = {
                    electric: '#fbbf24',
                    ice: '#22d3ee',
                    impact: '#ef4444'
                };
                const color = colors[type] || '#fff';

                // Create projectile
                const projectile = document.createElement('div');
                projectile.className = 'projectile';
                projectile.style.background = color;
                projectile.style.boxShadow = `0 0 30px ${color}`;
                projectile.style.left = startX + 'px';
                projectile.style.top = startY + 'px';
                projectile.style.setProperty('--start-x', '0px');
                projectile.style.setProperty('--start-y', '0px');
                projectile.style.setProperty('--end-x', (endX - startX) + 'px');
                projectile.style.setProperty('--end-y', (endY - startY) + 'px');

                stage.appendChild(projectile);

                // Create trail
                const trail = document.createElement('div');
                trail.className = 'projectile-trail';
                trail.style.background = `linear-gradient(90deg, ${color}, transparent)`;
                trail.style.left = startX + 'px';
                trail.style.top = startY + 'px';
                const angle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                trail.style.transform = `rotate(${angle}deg)`;
                stage.appendChild(trail);

                // Cleanup
                setTimeout(() => {
                    projectile.remove();
                    trail.remove();
                }, 800);
            },

            // Show floating damage number
            showDamage: function(element, damage, isCritical = false, multiplier = 1, isHeal = false) {
                const rect = element.getBoundingClientRect();
                const stage = document.getElementById('battleStage');
                const stageRect = stage.getBoundingClientRect();

                const damageNum = document.createElement('div');
                damageNum.className = 'damage-number' + (isCritical ? ' critical' : '');
                damageNum.textContent = (isHeal ? '+' : '') + Math.round(damage);
                damageNum.style.left = (rect.left + rect.width/2 - stageRect.left) + 'px';
                damageNum.style.top = (rect.top + rect.height/2 - stageRect.top) + 'px';

                if(isHeal) {
                    damageNum.style.color = '#22c55e';
                    damageNum.style.textShadow = '0 0 10px #22c55e';
                } else if(isCritical) {
                    damageNum.textContent += '!';
                } else if(multiplier > 1.2) {
                    damageNum.textContent += ''; // Bonus indicator
                } else if(multiplier < 0.8) {
                    damageNum.textContent += ''; // Weak indicator
                }

                stage.appendChild(damageNum);
                setTimeout(() => damageNum.remove(), 1500);
            },
            
            // Show Speech Bubble
            showSpeech: function(element, text, color = '#fff') {
                const bubble = document.createElement('div');
                bubble.className = 'speech-bubble';
                bubble.innerText = text;
                bubble.style.borderColor = color;
                
                // Attach to the side-img parent, not the image itself so it doesn't rotate with the image
                element.parentNode.appendChild(bubble);
                
                setTimeout(() => {
                    bubble.style.opacity = 0;
                    setTimeout(() => bubble.remove(), 300);
                }, 1500);
            },

            // Create impact ring
            createImpactRing: function(element, color) {
                const rect = element.getBoundingClientRect();
                const stage = document.getElementById('battleStage');
                const stageRect = stage.getBoundingClientRect();

                const ring = document.createElement('div');
                ring.className = 'impact-ring';
                ring.style.borderColor = color;
                ring.style.left = (rect.left + rect.width/2 - stageRect.left) + 'px';
                ring.style.top = (rect.top + rect.height/2 - stageRect.top) + 'px';

                stage.appendChild(ring);
                setTimeout(() => ring.remove(), 600);
            },

            // Charge up animation
            chargeUp: function(element, type) {
                const colors = {
                    electric: '#fbbf24',
                    ice: '#22d3ee',
                    impact: '#ef4444'
                };
                element.style.setProperty('--charge-color', colors[type] || '#fff');
                element.classList.add('charging');

                return () => element.classList.remove('charging');
            },

            // Camera focus
            focusOn: function(side) {
                const stage = document.getElementById('battleStage');
                stage.classList.remove('focus-left', 'focus-right');
                if(side) {
                    stage.classList.add('focus-' + side);
                }
            },

            // Screen shake with intensity
            shake: function(intensity = 'normal') {
                const stage = document.getElementById('battleStage');
                stage.classList.remove('shake-light', 'shake', 'shake-hard');

                if(intensity === 'light') stage.classList.add('shake-light');
                else if(intensity === 'hard') stage.classList.add('shake-hard');
                else stage.classList.add('shake');

                setTimeout(() => {
                    stage.classList.remove('shake-light', 'shake', 'shake-hard');
                }, 600);
            },

            // Update background intensity
            setIntensity: function(level) {
                const stage = document.getElementById('battleStage');
                stage.classList.remove('intensity-low', 'intensity-high');
                if(level === 'low') stage.classList.add('intensity-low');
                if(level === 'high') stage.classList.add('intensity-high');
            }
        };

        // Combo Counter Manager
        const ComboSystem = {
            count: 0,
            element: null,

            init: function() {
                if(!this.element) {
                    this.element = document.createElement('div');
                    this.element.className = 'combo-counter';
                    document.getElementById('battleStage').appendChild(this.element);
                }
            },

            increment: function() {
                this.init();
                this.count++;
                this.element.textContent = `${this.count} HIT COMBO!`;
                this.element.classList.remove('high');

                if(this.count >= 5) {
                    this.element.classList.add('high');
                }

                // Reset opacity to trigger animation
                this.element.style.opacity = '0';
                setTimeout(() => this.element.style.animation = 'none', 10);
                setTimeout(() => this.element.style.animation = '', 20);
            },

            reset: function() {
                this.count = 0;
                if(this.element) {
                    this.element.style.opacity = '0';
                }
            }
        };

        /* --- BATTLE STATS TRACKER (NEW) --- */
        const BattleStats = {
            maxCombo: 0,
            critsDealt: 0,
            startHP: 100,
            reset: function() {
                this.maxCombo = 0;
                this.critsDealt = 0;
            },
            checkCombo: function() {
                if(ComboSystem.count > this.maxCombo) this.maxCombo = ComboSystem.count;
            }
        };

        /* === CINEMATIC SYSTEM === */
        const CinematicSystem = {
            isPlaying: false,
            skipRequested: false,
            cinematicElements: [],

            // Helper: Create delay promise
            delay: function(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            // Helper: Clear all cinematic elements
            cleanup: function() {
                this.cinematicElements.forEach(el => {
                    if(el && el.parentNode) el.remove();
                });
                this.cinematicElements = [];
                this.isPlaying = false;
                this.skipRequested = false;
            },

            // Helper: Add screen flash
            flashScreen: async function(color, duration) {
                const flash = document.createElement('div');
                flash.className = 'screen-flash flash-' + color;
                document.body.appendChild(flash);
                this.cinematicElements.push(flash);

                await this.delay(duration);
                flash.remove();
            },

            // Helper: Show title with animation
            showTitle: async function(text, style, duration) {
                const title = document.createElement('div');
                title.className = style === 'gold' ? 'victory-title-slam' : 'defeat-title-drop';
                title.textContent = text;
                document.body.appendChild(title);
                this.cinematicElements.push(title);

                // Screen shake on impact
                const stage = document.getElementById('battleStage');
                if(stage) {
                    stage.classList.add('shake-hard');
                    setTimeout(() => stage.classList.remove('shake-hard'), 300);
                }

                await this.delay(duration);
            },

            // Helper: Create confetti
            startConfetti: function() {
                const colors = ['#fbbf24', '#22d3ee', '#ef4444', '#a855f7', '#22c55e'];
                const shapes = ['', '', '', ''];

                const confettiInterval = setInterval(() => {
                    if(this.skipRequested) {
                        clearInterval(confettiInterval);
                        return;
                    }

                    for(let i = 0; i < 5; i++) {
                        const confetti = document.createElement('div');
                        confetti.className = 'confetti-piece';
                        confetti.textContent = shapes[Math.floor(Math.random() * shapes.length)];
                        confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                        confetti.style.left = Math.random() * window.innerWidth + 'px';
                        confetti.style.top = '-20px';
                        confetti.style.fontSize = (10 + Math.random() * 20) + 'px';
                        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';

                        document.body.appendChild(confetti);
                        setTimeout(() => confetti.remove(), 4000);
                    }
                }, 200);

                // Store interval so we can clear it
                setTimeout(() => clearInterval(confettiInterval), 5000);
            },

            // Helper: Add auras to heroes
            addAuras: function(hero1, hero2, synergyType) {
                const hImgs = document.querySelectorAll('.hero-battle-img');

                hImgs.forEach((img, index) => {
                    const hero = index === 0 ? hero1 : hero2;
                    const aura = document.createElement('div');

                    if(synergyType) {
                        aura.className = 'victory-aura synergy';
                    } else {
                        aura.className = 'victory-aura ' + hero.type;
                    }

                    img.style.position = 'relative';
                    img.appendChild(aura);
                    this.cinematicElements.push(aura);
                });
            },

            // Helper: Animate heroes to center
            animateHeroesToCenter: async function(hero1, hero2) {
                const hImgs = document.querySelectorAll('.hero-battle-img');

                hImgs.forEach(img => {
                    img.classList.add('hero-victory-center');
                });

                await this.delay(1500);
            },

            // Helper: Create skip button
            createSkipButton: function(onSkip) {
                const skipBtn = document.createElement('button');
                skipBtn.className = 'skip-cinematic-btn';
                skipBtn.textContent = 'SKIP ';
                skipBtn.onclick = () => {
                    this.skipRequested = true;
                    onSkip();
                };

                document.body.appendChild(skipBtn);
                this.cinematicElements.push(skipBtn);

                return skipBtn;
            },

            // VICTORY CINEMATIC
            playVictory: async function(hero1, hero2, synergyType) {
                if(this.isPlaying) return;
                this.isPlaying = true;
                this.skipRequested = false;

                const skipBtn = this.createSkipButton(() => this.cleanup());

                // Show skip button after 1 second
                setTimeout(() => {
                    if(!this.skipRequested && skipBtn.parentNode) {
                        skipBtn.style.display = 'block';
                    }
                }, 1000);

                try {
                    // 1. Slow-mo final moment (0.5s)
                    const stage = document.getElementById('battleStage');
                    if(stage) stage.classList.add('slow-motion-active');
                    AudioEngine.playTone(200, 'sine', 0.5);
                    await this.delay(500);
                    if(this.skipRequested) return;
                    if(stage) stage.classList.remove('slow-motion-active');

                    // 2. Flash transition (0.3s)
                    await this.flashScreen('white', 300);
                    if(this.skipRequested) return;

                    // Hide villain
                    const vImg = document.querySelector('.villain-battle-img');
                    if(vImg) {
                        vImg.style.transition = 'opacity 0.5s';
                        vImg.style.opacity = '0';
                    }

                    // 3. Position heroes center and add celebration effects (1.5s)
                    await this.animateHeroesToCenter(hero1, hero2);
                    if(this.skipRequested) return;

                    this.addAuras(hero1, hero2, synergyType);
                    this.startConfetti();

                    // 4. Slam in title (1s)
                    await this.showTitle('VICTORY!', 'gold', 1000);
                    if(this.skipRequested) return;

                    // 5. Play victory fanfare
                    this.playVictoryFanfare();

                    // Wait a bit before showing results
                    await this.delay(1500);

                } catch(error) {
                    console.error('Victory cinematic error:', error);
                } finally {
                    // Don't cleanup here - let showVictoryScreen handle it
                }
            },

            // DEFEAT CINEMATIC
            playDefeat: async function(hero1, hero2, villain) {
                if(this.isPlaying) return;
                this.isPlaying = true;
                this.skipRequested = false;

                const skipBtn = this.createSkipButton(() => this.cleanup());

                // Show skip button after 1 second
                setTimeout(() => {
                    if(!this.skipRequested && skipBtn.parentNode) {
                        skipBtn.style.display = 'block';
                    }
                }, 1000);

                try {
                    // 1. Slow-mo and desaturate (0.5s)
                    const stage = document.getElementById('battleStage');
                    if(stage) stage.classList.add('slow-motion-active');

                    const desaturate = document.createElement('div');
                    desaturate.className = 'screen-desaturate';
                    document.body.appendChild(desaturate);
                    this.cinematicElements.push(desaturate);

                    AudioEngine.playTone(150, 'sawtooth', 0.5);
                    await this.delay(500);
                    if(this.skipRequested) return;
                    if(stage) stage.classList.remove('slow-motion-active');

                    // 2. Heroes stagger (1s)
                    const hImgs = document.querySelectorAll('.hero-battle-img');
                    hImgs.forEach(img => img.classList.add('hero-stagger'));

                    AudioEngine.playTone(100, 'square', 0.2);
                    await this.delay(1000);
                    if(this.skipRequested) return;

                    // 3. Heroes retreat (1.5s)
                    hImgs.forEach((img, index) => {
                        img.classList.remove('hero-stagger');
                        img.classList.add('hero-retreat');

                        // Add energy trail
                        const hero = index === 0 ? hero1 : hero2;
                        const trail = document.createElement('div');
                        trail.className = 'energy-trail';
                        trail.style.background = `linear-gradient(90deg, ${this.getTypeColor(hero.type)}, transparent)`;
                        img.style.position = 'relative';
                        img.appendChild(trail);
                        this.cinematicElements.push(trail);
                    });

                    await this.delay(1500);
                    if(this.skipRequested) return;

                    // 4. Villain victory pose
                    const vImg = document.querySelector('.villain-battle-img');
                    if(vImg) {
                        vImg.classList.add('villain-triumph');

                        // Add dark particles
                        for(let i = 0; i < 20; i++) {
                            setTimeout(() => {
                                const particle = document.createElement('div');
                                particle.className = 'dark-particle';
                                const vRect = vImg.getBoundingClientRect();
                                particle.style.left = (vRect.left + vRect.width/2 + (Math.random() - 0.5) * 100) + 'px';
                                particle.style.top = (vRect.top + vRect.height) + 'px';
                                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                                document.body.appendChild(particle);
                                setTimeout(() => particle.remove(), 4000);
                            }, i * 100);
                        }
                    }

                    // Add vignette
                    const vignette = document.createElement('div');
                    vignette.className = 'screen-vignette';
                    document.body.appendChild(vignette);
                    this.cinematicElements.push(vignette);

                    // 5. Show defeat title (1s)
                    await this.showTitle('DEFEAT', 'darkred', 1000);
                    if(this.skipRequested) return;

                    // 6. Play defeat sound
                    this.playDefeatSound();

                    // Wait before showing results
                    await this.delay(1500);

                } catch(error) {
                    console.error('Defeat cinematic error:', error);
                } finally {
                    // Don't cleanup here - let showVictoryScreen handle it
                }
            },

            // GAUNTLET VICTORY CINEMATIC
            playGauntletVictory: async function(hero1, hero2, synergyType) {
                await this.playVictory(hero1, hero2, synergyType);

                if(this.skipRequested) return;

                // Add extra effects
                const subtitle = document.createElement('div');
                subtitle.className = 'gauntlet-subtitle';
                subtitle.textContent = 'GAUNTLET CHAMPION!';
                document.body.appendChild(subtitle);
                this.cinematicElements.push(subtitle);

                // Create fireworks
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => {
                        createMegaBurst('electric');
                        AudioEngine.playTone(600 + i * 100, 'sine', 0.2);
                    }, i * 500);
                }
            },

            // TIME ATTACK RECORD CINEMATIC
            playTimeAttackRecord: async function(hero1, hero2, synergyType) {
                // Speed lines effect
                for(let i = 0; i < 10; i++) {
                    const speedLine = document.createElement('div');
                    speedLine.className = 'speed-line';
                    speedLine.style.width = (200 + Math.random() * 400) + 'px';
                    speedLine.style.top = (Math.random() * 100) + '%';
                    document.body.appendChild(speedLine);
                    this.cinematicElements.push(speedLine);
                    setTimeout(() => speedLine.remove(), 300);
                }

                await this.playVictory(hero1, hero2, synergyType);

                if(this.skipRequested) return;

                // "NEW RECORD!" flashing
                const record = document.createElement('div');
                record.className = 'record-flash';
                record.textContent = 'NEW RECORD!';
                document.body.appendChild(record);
                this.cinematicElements.push(record);

                // Play ascending tones
                for(let i = 0; i < 5; i++) {
                    setTimeout(() => AudioEngine.playTone(400 + i * 200, 'sine', 0.1), i * 100);
                }
            },

            // Helper: Get type color
            getTypeColor: function(type) {
                const colors = {
                    electric: '#fbbf24',
                    ice: '#22d3ee',
                    impact: '#ef4444'
                };
                return colors[type] || '#fff';
            },

            // Audio: Victory fanfare
            playVictoryFanfare: function() {
                // Triumphant ascending melody
                const notes = [400, 500, 600, 800];
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        AudioEngine.playTone(freq, 'sine', 0.2);
                    }, i * 150);
                });

                // Crowd cheer simulation (subtle)
                setTimeout(() => {
                    for(let i = 0; i < 10; i++) {
                        setTimeout(() => {
                            AudioEngine.playTone(800 + Math.random() * 400, 'sine', 0.05);
                        }, i * 50);
                    }
                }, 600);
            },

            // Audio: Defeat sound
            playDefeatSound: function() {
                // Low, somber descending tone
                const notes = [300, 250, 200, 150];
                notes.forEach((freq, i) => {
                    setTimeout(() => {
                        AudioEngine.playTone(freq, 'sawtooth', 0.3);
                    }, i * 200);
                });

                // Distant rumble
                setTimeout(() => {
                    AudioEngine.playTone(80, 'sawtooth', 0.8);
                }, 800);
            }
        };

        /* --- ITEM SYSTEM --- */
        const ItemSystem = {
            selectedItems: [],
            usedItems: [],
            activeEffects: [], // {effectType, turnsRemaining, value}

            reset: function() {
                this.selectedItems = [];
                this.usedItems = [];
                this.activeEffects = [];
                this.updateBattleUI();
            },

            selectItem: function(itemId) {
                if(this.selectedItems.length >= 2) return false;
                if(this.selectedItems.includes(itemId)) return false;
                this.selectedItems.push(itemId);
                return true;
            },

            deselectItem: function(itemId) {
                const index = this.selectedItems.indexOf(itemId);
                if(index > -1) {
                    this.selectedItems.splice(index, 1);
                    return true;
                }
                return false;
            },

            useItem: function(itemId) {
                if(this.usedItems.includes(itemId)) return;
                const item = BATTLE_ITEMS[itemId];
                if(!item) return;

                this.usedItems.push(itemId);

                // Apply effect based on item type
                switch(item.effect) {
                    case 'heal':
                        this.applyHeal(item.value);
                        break;
                    case 'defense':
                        this.applyDefense(item.value, item.duration);
                        break;
                    case 'critical':
                        this.applyCritical(item.duration);
                        break;
                    case 'synergy':
                        this.applySynergy(item.value);
                        break;
                    case 'dodge':
                        this.applyDodge(item.duration);
                        break;
                    case 'damage':
                        this.applyDamage(item.value, item.duration);
                        break;
                }

                this.updateBattleUI();
            },

            tickEffects: function() {
                for(let i = this.activeEffects.length - 1; i >= 0; i--) {
                    const effect = this.activeEffects[i];
                    if(effect.duration !== undefined) {
                        effect.turnsRemaining--;
                        if(effect.turnsRemaining <= 0) {
                            this.activeEffects.splice(i, 1);
                        }
                    }
                }
            },

            getActiveEffect: function(effectType) {
                return this.activeEffects.find(e => e.effectType === effectType) || null;
            },

            applyHeal: function(value) {
                currentHeroHP = Math.min(100, currentHeroHP + value);
                updateHealthUI('heroes', currentHeroHP);
                updateBattleLog(`Heroes restored ${value} HP! `);

                // Visual effects
                const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
                hImgs.forEach(img => {
                    VisualFX.showDamage(img, value, false, 1, true); // true for heal
                    this.createHealingParticles(img);
                });
                AudioEngine.playTone(800, 'sine', 0.4);
            },

            applyDefense: function(value, duration) {
                this.activeEffects.push({
                    effectType: 'defense',
                    value: value,
                    turnsRemaining: duration
                });
                updateBattleLog(`Shield activated! Damage reduced by ${value * 100}% for ${duration} turns! `);
                this.showShieldEffect();
                AudioEngine.playTone(600, 'triangle', 0.3);
            },

            applyCritical: function(duration) {
                this.activeEffects.push({
                    effectType: 'critical',
                    turnsRemaining: duration
                });
                updateBattleLog(`Critical strikes guaranteed for ${duration} turns! `);
                this.showCriticalEffect();
                AudioEngine.playTone(1000, 'square', 0.3);
            },

            applySynergy: function(value) {
                // Note: This would need SynergySystem if it exists, for now just visual feedback
                updateBattleLog(`Energy surged! Power increased! `);
                this.showEnergyEffect();
                AudioEngine.playTone(1200, 'sine', 0.4);
            },

            applyDodge: function(duration) {
                this.activeEffects.push({
                    effectType: 'dodge',
                    turnsRemaining: duration
                });
                updateBattleLog(`Smoke bomb deployed! Next attack will be dodged! `);
                this.showSmokeEffect();
                AudioEngine.playTone(400, 'sawtooth', 0.2);
            },

            applyDamage: function(value, duration) {
                this.activeEffects.push({
                    effectType: 'damage',
                    value: value,
                    turnsRemaining: duration
                });
                updateBattleLog(`Power crystal activated! Damage increased by ${value * 100}% for ${duration} turns! `);
                this.showPowerEffect();
                AudioEngine.playTone(900, 'sine', 0.4);
            },

            // Visual effects helpers
            createHealingParticles: function(targetElement) {
                const rect = targetElement.getBoundingClientRect();
                for(let i = 0; i < 8; i++) {
                    setTimeout(() => {
                        const particle = document.createElement('div');
                        particle.textContent = '';
                        particle.style.position = 'fixed';
                        particle.style.left = (rect.left + rect.width/2) + 'px';
                        particle.style.top = (rect.top + rect.height/2) + 'px';
                        particle.style.fontSize = '1.5rem';
                        particle.style.pointerEvents = 'none';
                        particle.style.zIndex = '2000';
                        particle.style.animation = 'floatUp 1s ease-out forwards';
                        document.body.appendChild(particle);
                        setTimeout(() => particle.remove(), 1000);
                    }, i * 100);
                }
            },

            showShieldEffect: function() {
                const hSide = document.getElementById('heroesSide');
                const shield = document.createElement('div');
                shield.className = 'shield-effect';
                shield.textContent = '';
                hSide.appendChild(shield);
                setTimeout(() => shield.remove(), 2000);
            },

            showCriticalEffect: function() {
                const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
                hImgs.forEach(img => {
                    img.classList.add('critical-glow');
                });
            },

            showEnergyEffect: function() {
                const stage = document.getElementById('battleStage');
                const flash = document.createElement('div');
                flash.style.position = 'absolute';
                flash.style.inset = '0';
                flash.style.background = 'radial-gradient(circle, rgba(251, 191, 36, 0.5) 0%, transparent 70%)';
                flash.style.pointerEvents = 'none';
                flash.style.zIndex = '10';
                flash.style.animation = 'fadeOut 1s ease-out';
                stage.appendChild(flash);
                setTimeout(() => flash.remove(), 1000);
            },

            showSmokeEffect: function() {
                const hSide = document.getElementById('heroesSide');
                const smoke = document.createElement('div');
                smoke.className = 'smoke-effect';
                smoke.textContent = '';
                hSide.appendChild(smoke);
                setTimeout(() => smoke.remove(), 2000);
            },

            showPowerEffect: function() {
                const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
                hImgs.forEach(img => {
                    img.classList.add('power-glow');
                });
            },

            updateBattleUI: function() {
                // Update item buttons in battle
                this.selectedItems.forEach((itemId, index) => {
                    const btn = document.getElementById(`battleItem${index}`);
                    if(btn) {
                        const item = BATTLE_ITEMS[itemId];
                        btn.innerHTML = `<span class="item-icon">${item.icon}</span><span class="item-name">${item.name}</span>`;

                        if(this.usedItems.includes(itemId)) {
                            btn.classList.add('used');
                            btn.disabled = true;
                        } else {
                            btn.classList.remove('used');
                            btn.disabled = false;
                        }
                    }
                });
            }
        };

        /* --- STORY MODE SYSTEM --- */
        const StoryModeSystem = {
            progress: {},
            currentRegion: null,
            currentStage: null,
            storyModeEnabled: true, // Set to false to disable story mode

            // Initialize story mode
            init() {
                this.load();
                // Initialize progress for all regions if not exists
                Object.keys(WORLD_REGIONS).forEach(regionId => {
                    if (!this.progress[regionId]) {
                        this.progress[regionId] = {
                            unlocked: regionId === 'downtown', // Downtown always unlocked
                            stages: {},
                            completed: false,
                            rewardClaimed: false
                        };
                    }
                });
                this.checkAndUnlockRegions();
                this.save();
            },

            // Load progress from localStorage
            load() {
                try {
                    const saved = localStorage.getItem('hawthorn_story_progress');
                    if (saved) {
                        this.progress = JSON.parse(saved);
                    } else {
                        this.progress = {};
                    }
                } catch (e) {
                    console.error('Failed to load story progress:', e);
                    this.progress = {};
                }
            },

            // Save progress to localStorage
            save() {
                try {
                    localStorage.setItem('hawthorn_story_progress', JSON.stringify(this.progress));
                } catch (e) {
                    console.error('Failed to save story progress:', e);
                }
            },

            // Check and unlock regions based on completion
            checkAndUnlockRegions() {
                Object.keys(WORLD_REGIONS).forEach(regionId => {
                    const region = WORLD_REGIONS[regionId];
                    if (this.isRegionUnlocked(regionId)) {
                        if (!this.progress[regionId]) {
                            this.progress[regionId] = {
                                unlocked: true,
                                stages: {},
                                completed: false,
                                rewardClaimed: false
                            };
                        } else {
                            this.progress[regionId].unlocked = true;
                        }
                    }
                });
            },

            // Check if a region is unlocked
            isRegionUnlocked(regionId) {
                const region = WORLD_REGIONS[regionId];
                if (!region.unlockRequirement) return true; // Always unlocked

                const req = region.unlockRequirement;

                // Check for "anyOf" requirement
                if (req.anyOf) {
                    return req.anyOf.some(reqRegionId => {
                        return this.progress[reqRegionId]?.completed || false;
                    });
                }

                // Check for single region requirement
                if (req.region) {
                    return this.progress[req.region]?.completed || false;
                }

                // Check for all regions completed
                if (req.allRegionsCompleted) {
                    const mainRegions = ['downtown', 'frozen_peaks', 'thunder_jungle', 'iron_fortress', 'omega_tower'];
                    return mainRegions.every(r => this.progress[r]?.completed || false);
                }

                return false;
            },

            // Check if a region is completed
            isRegionCompleted(regionId) {
                return this.progress[regionId]?.completed || false;
            },

            // Get region progress (completed stages / total stages)
            getRegionProgress(regionId) {
                const region = WORLD_REGIONS[regionId];
                const progress = this.progress[regionId];
                if (!progress) return { completed: 0, total: region.totalStages };

                const completedCount = Object.values(progress.stages).filter(s => s === true).length;
                return { completed: completedCount, total: region.totalStages };
            },

            // Get current stage for a region (next uncompleted stage)
            getCurrentStage(regionId) {
                const stages = REGION_STAGES[regionId];
                const progress = this.progress[regionId];
                if (!stages || !progress) return null;

                for (let stage of stages) {
                    if (!progress.stages[stage.stageNumber]) {
                        return stage;
                    }
                }
                return null; // All stages completed
            },

            // Complete a stage
            completeStage(regionId, stageNum, result) {
                if (!this.progress[regionId]) {
                    this.progress[regionId] = {
                        unlocked: true,
                        stages: {},
                        completed: false,
                        rewardClaimed: false
                    };
                }

                this.progress[regionId].stages[stageNum] = true;

                // Check if region is now completed
                const region = WORLD_REGIONS[regionId];
                const completedStages = Object.keys(this.progress[regionId].stages).filter(
                    s => this.progress[regionId].stages[s]
                ).length;

                if (completedStages >= region.totalStages) {
                    this.progress[regionId].completed = true;
                    this.checkAndUnlockRegions(); // Unlock new regions
                }

                this.save();
            },

            // Claim region rewards
            claimRegionReward(regionId) {
                const region = WORLD_REGIONS[regionId];
                if (!this.isRegionCompleted(regionId)) return null;
                if (this.progress[regionId].rewardClaimed) return null;

                this.progress[regionId].rewardClaimed = true;
                this.save();

                return region.rewards;
            },

            // Get unlocked heroes list
            getUnlockedHeroes() {
                const unlocked = new Set();

                // Starting heroes (always available)
                const startingHeroes = ['joshua', 'lulu', 'noa', 'noah', 'phaedra', 'rex', 'rory', 'viola', 'alexei'];
                startingHeroes.forEach(h => unlocked.add(h));

                // Heroes from completed regions
                Object.keys(this.progress).forEach(regionId => {
                    if (this.progress[regionId].rewardClaimed) {
                        const region = WORLD_REGIONS[regionId];
                        if (region.rewards.heroes) {
                            region.rewards.heroes.forEach(h => unlocked.add(h));
                        }
                    }
                });

                return Array.from(unlocked);
            },

            // Check if a hero is unlocked
            isHeroUnlocked(heroId) {
                return this.getUnlockedHeroes().includes(heroId);
            },

            // Open world map
            openWorldMap() {
                const overlay = document.getElementById('worldMapOverlay');
                if (overlay) {
                    overlay.classList.add('active');
                    this.renderWorldMap();
                }
            },

            // Close world map
            closeWorldMap() {
                const overlay = document.getElementById('worldMapOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            },

            // Render world map
            renderWorldMap() {
                const container = document.getElementById('worldMapContainer');
                if (!container) return;

                let html = '';
                Object.keys(WORLD_REGIONS).forEach(regionId => {
                    const region = WORLD_REGIONS[regionId];
                    const unlocked = this.isRegionUnlocked(regionId);
                    const completed = this.isRegionCompleted(regionId);
                    const progress = this.getRegionProgress(regionId);

                    const nodeClass = `region-node ${unlocked ? '' : 'locked'} ${completed ? 'completed' : ''}`;
                    const style = `left: ${region.position.x}%; top: ${region.position.y}%; color: ${region.color}; border-color: ${region.color};`;

                    html += `
                        <div class="${nodeClass}" style="${style}"
                             onclick="StoryModeSystem.selectRegion('${regionId}')"
                             data-region="${regionId}">
                            <div class="region-icon">${region.icon}</div>
                            ${completed ? '<div class="completion-badge"></div>' : ''}
                            ${unlocked && !completed ? `<div class="progress-badge">${progress.completed}/${progress.total}</div>` : ''}
                            ${!unlocked ? '<div class="lock-badge"></div>' : ''}
                        </div>
                    `;
                });

                container.innerHTML = html;
                this.renderMapPaths();
            },

            // Render paths between regions
            renderMapPaths() {
                const pathsContainer = document.getElementById('worldMapPaths');
                if (!pathsContainer) return;

                const paths = [
                    { from: 'downtown', to: 'frozen_peaks' },
                    { from: 'downtown', to: 'thunder_jungle' },
                    { from: 'frozen_peaks', to: 'iron_fortress' },
                    { from: 'thunder_jungle', to: 'iron_fortress' },
                    { from: 'iron_fortress', to: 'omega_tower' },
                    { from: 'omega_tower', to: 'secret_dimension' }
                ];

                let html = '';
                paths.forEach(path => {
                    const fromRegion = WORLD_REGIONS[path.from];
                    const toRegion = WORLD_REGIONS[path.to];
                    const unlocked = this.isRegionUnlocked(path.to);

                    const x1 = fromRegion.position.x;
                    const y1 = fromRegion.position.y;
                    const x2 = toRegion.position.x;
                    const y2 = toRegion.position.y;

                    const pathClass = unlocked ? 'map-path unlocked' : 'map-path locked';

                    html += `
                        <line x1="${x1}%" y1="${y1}%" x2="${x2}%" y2="${y2}%"
                              class="${pathClass}"
                              stroke="${unlocked ? fromRegion.color : '#333'}"
                              stroke-width="3"
                              stroke-dasharray="${unlocked ? '0' : '5,5'}" />
                    `;
                });

                pathsContainer.innerHTML = html;
            },

            // Select a region to view details
            selectRegion(regionId) {
                AudioEngine.playTone(600, 'sine', 0.1);
                const region = WORLD_REGIONS[regionId];
                const unlocked = this.isRegionUnlocked(regionId);
                const completed = this.isRegionCompleted(regionId);
                const progress = this.getRegionProgress(regionId);

                const panel = document.getElementById('regionDetailPanel');
                if (!panel) return;

                let detailsHTML = `
                    <div class="region-detail-header">
                        <div class="region-detail-icon" style="color: ${region.color};">${region.icon}</div>
                        <div>
                            <h2 class="region-detail-name" style="color: ${region.color};">${region.name}</h2>
                            <p class="region-detail-difficulty">Difficulty: ${''.repeat(region.difficulty)}</p>
                        </div>
                    </div>
                    <p class="region-detail-desc">${region.description}</p>
                    <div class="region-detail-progress">
                        <span>Progress: ${progress.completed}/${progress.total} Stages</span>
                        ${completed ? '<span class="completed-badge"> COMPLETED</span>' : ''}
                    </div>
                    <div class="region-detail-villains">
                        <strong>Villains:</strong> ${region.villains.join(', ')}
                    </div>
                    <div class="region-detail-rewards">
                        <strong>Rewards:</strong>
                        ${region.rewards.heroes?.length > 0 ? `<div> Heroes: ${region.rewards.heroes.join(', ')}</div>` : ''}
                        <div> XP Bonus: ${region.rewards.xpBonus}</div>
                        ${region.rewards.special ? `<div> ${region.rewards.special}</div>` : ''}
                    </div>
                `;

                if (unlocked) {
                    detailsHTML += `
                        <button class="enter-region-btn" onclick="StoryModeSystem.enterRegion('${regionId}')" style="background: ${region.color};">
                            ${completed ? 'REPLAY REGION' : 'ENTER REGION'}
                        </button>
                    `;
                } else {
                    detailsHTML += `<div class="locked-message"> Complete previous regions to unlock</div>`;
                }

                panel.innerHTML = detailsHTML;
                panel.classList.add('active');
            },

            // Enter a region (show stage select)
            enterRegion(regionId) {
                AudioEngine.playTone(800, 'sine', 0.15);
                this.currentRegion = regionId;
                this.showStageSelect(regionId);
            },

            // Show stage selection screen
            showStageSelect(regionId) {
                const region = WORLD_REGIONS[regionId];
                const stages = REGION_STAGES[regionId];
                const progress = this.progress[regionId];

                const overlay = document.getElementById('stageSelectOverlay');
                const container = document.getElementById('stageSelectContainer');

                let html = `
                    <div class="stage-select-header">
                        <h2 style="color: ${region.color};">${region.icon} ${region.name}</h2>
                        <button class="close-btn" onclick="StoryModeSystem.closeStageSelect()"></button>
                    </div>
                    <div class="stage-grid">
                `;

                stages.forEach((stage, index) => {
                    const completed = progress.stages[stage.stageNumber] || false;
                    const previousCompleted = index === 0 || progress.stages[stages[index - 1].stageNumber];
                    const locked = !previousCompleted;

                    const stageClass = `stage-card ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}`;

                    html += `
                        <div class="${stageClass}" onclick="${locked ? '' : `StoryModeSystem.startStage('${regionId}', ${stage.stageNumber})`}">
                            <div class="stage-number">Stage ${stage.stageNumber}</div>
                            <div class="stage-name">${stage.name}</div>
                            <div class="stage-type">${stage.type === 'boss' ? ' BOSS' : ' BATTLE'}</div>
                            <div class="stage-reward">+${stage.rewards.xp} XP</div>
                            ${completed ? '<div class="stage-complete-mark"></div>' : ''}
                            ${locked ? '<div class="stage-lock-mark"></div>' : ''}
                        </div>
                    `;
                });

                html += `</div>`;
                container.innerHTML = html;
                overlay.classList.add('active');

                // Close world map
                this.closeWorldMap();
            },

            // Close stage select
            closeStageSelect() {
                const overlay = document.getElementById('stageSelectOverlay');
                overlay.classList.remove('active');
                this.openWorldMap();
            },

            // Start a stage
            startStage(regionId, stageNumber) {
                AudioEngine.playTone(1000, 'sine', 0.2);
                this.currentRegion = regionId;
                this.currentStage = stageNumber;

                const stage = REGION_STAGES[regionId].find(s => s.stageNumber === stageNumber);
                if (!stage) return;

                // Close stage select
                document.getElementById('stageSelectOverlay').classList.remove('active');

                // Show stage intro
                this.showStageIntro(regionId, stage);
            },

            // Show stage intro screen
            showStageIntro(regionId, stage) {
                const region = WORLD_REGIONS[regionId];
                const overlay = document.getElementById('stageIntroOverlay');
                const container = document.getElementById('stageIntroContainer');

                const html = `
                    <div class="stage-intro-content">
                        <div class="stage-intro-region" style="color: ${region.color};">
                            ${region.icon} ${region.name}
                        </div>
                        <div class="stage-intro-name">${stage.name}</div>
                        <div class="stage-intro-type">${stage.type === 'boss' ? ' BOSS BATTLE' : ' BATTLE'}</div>
                        ${stage.villain ? `<div class="stage-intro-villain">Face: ${stage.villain}</div>` : ''}
                        <button class="stage-intro-begin-btn" onclick="StoryModeSystem.beginStoryBattle()" style="background: ${region.color};">
                            BEGIN BATTLE
                        </button>
                    </div>
                `;

                container.innerHTML = html;
                overlay.classList.add('active');
            },

            // Begin story battle (transition to hero selection)
            beginStoryBattle() {
                const overlay = document.getElementById('stageIntroOverlay');
                overlay.classList.remove('active');

                // Trigger battle mode with story context
                window.storyBattleMode = true;
                window.storyBattleRegion = this.currentRegion;
                window.storyBattleStage = this.currentStage;

                // Start battle selection
                document.getElementById('muddlewickBtn').click();
            },

            // Handle story battle victory
            onStoryBattleVictory() {
                if (!window.storyBattleMode) return;

                const regionId = window.storyBattleRegion;
                const stageNum = window.storyBattleStage;
                const stage = REGION_STAGES[regionId].find(s => s.stageNumber === stageNum);

                // Complete the stage
                this.completeStage(regionId, stageNum, { victory: true });

                // Check if region is now completed
                const region = WORLD_REGIONS[regionId];
                const completed = this.isRegionCompleted(regionId);

                // Show completion message
                setTimeout(() => {
                    if (completed && !this.progress[regionId].rewardClaimed) {
                        this.showRegionCompletionScreen(regionId);
                    } else {
                        this.showStageCompletionScreen(regionId, stage);
                    }
                }, 1000);

                // Reset story battle mode
                window.storyBattleMode = false;
            },

            // Show stage completion screen
            showStageCompletionScreen(regionId, stage) {
                const region = WORLD_REGIONS[regionId];
                alert(`Stage Complete!\n\n${region.name} - ${stage.name}\n+${stage.rewards.xp} XP\n\nContinue to next stage!`);

                // Return to stage select
                setTimeout(() => {
                    this.showStageSelect(regionId);
                }, 500);
            },

            // Show region completion screen
            showRegionCompletionScreen(regionId) {
                const region = WORLD_REGIONS[regionId];
                const rewards = this.claimRegionReward(regionId);

                if (!rewards) return;

                let rewardMessage = `REGION COMPLETE!\n\n${region.icon} ${region.name}\n\n`;
                rewardMessage += ` +${rewards.xpBonus} XP Bonus\n`;

                if (rewards.heroes && rewards.heroes.length > 0) {
                    rewardMessage += `\n NEW HEROES UNLOCKED:\n`;
                    rewards.heroes.forEach(heroId => {
                        const hero = heroes.find(h => h.id === heroId);
                        if (hero) {
                            rewardMessage += `   ${hero.name} (${hero.alias})\n`;
                        }
                    });
                }

                if (rewards.special) {
                    rewardMessage += `\n Special Reward: ${rewards.special}\n`;
                }

                alert(rewardMessage);

                // Re-render grid to show unlocked heroes
                renderGrid();

                // Return to world map
                setTimeout(() => {
                    this.openWorldMap();
                }, 500);
            }
        };

        /* --- BATTLE LOGIC --- */
        let isBattleSelecting = false;
        let isBattleActive = false;
        let selectedHeroes = [];
        let currentVillain = null;
        let synergyActive = false; // New Synergy Flag

        // BATTLE STATE
        let currentHeroHP = 100;
        let currentVillainHP = 100;
        const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

        function toggleBattleMode() {
            AudioEngine.playTone(400, 'sine', 0.1);
            const btn = document.getElementById('muddlewickBtn');
            const instructions = document.getElementById('battleInstructions');
            const selectTxt = document.getElementById('selectText');
            
            isBattleSelecting = !isBattleSelecting;
            selectedHeroes = [];
            document.querySelectorAll('.hero-card').forEach(c => {
                 c.classList.remove('selected', 'dimmed');
            });
            document.getElementById('startFightBtn').style.display = 'none';
            selectTxt.innerText = "Select 2 Heroes to Fight!";
            selectTxt.style.color = "#a855f7";

            if(isBattleSelecting) {
                 btn.classList.add('active');
                 btn.innerText = "Cancel Challenge";
                 instructions.style.display = 'block';
                 document.querySelectorAll('.hero-card').forEach(c => c.classList.add('dimmed'));
            } else {
                 btn.classList.remove('active');
                 btn.innerText = " Muddlewick has Chosen";
                 instructions.style.display = 'none';
                 document.querySelectorAll('.hero-card').forEach(c => c.classList.remove('dimmed'));
            }
        }

        function handleBattleSelection(id) {
             const card = document.getElementById(`card-${id}`);
             // NOTE: scrollIntoView removed to fix animation glitch
             // card.scrollIntoView({ behavior: 'smooth', block: 'center' });

             const startBtn = document.getElementById('startFightBtn');
             const selectTxt = document.getElementById('selectText');
             
             if(selectedHeroes.includes(id)) {
                  AudioEngine.playTone(200, 'sine', 0.1);
                  selectedHeroes = selectedHeroes.filter(h => h !== id);
                  card.classList.remove('selected');
                  card.classList.add('dimmed');
             } else {
                  if(selectedHeroes.length < 2) {
                        AudioEngine.playTone(600, 'sine', 0.1);
                        selectedHeroes.push(id);
                        card.classList.add('selected');
                        card.classList.remove('dimmed');
                  }
             }

             if(selectedHeroes.length === 2) {
                  startBtn.style.display = 'inline-block';
                  selectTxt.innerText = "TEAM READY!";
                  selectTxt.style.color = "#4ade80"; 
                  document.querySelectorAll('.hero-card:not(.selected)').forEach(c => c.classList.add('dimmed'));
             } else {
                  startBtn.style.display = 'none';
                  selectTxt.innerText = "Select 2 Heroes to Fight!";
                  selectTxt.style.color = "#a855f7"; 
             }
        }

        /* --- ITEM SELECTION FUNCTIONS --- */
        function populateItemsGrid() {
            const grid = document.getElementById('itemsGrid');
            grid.innerHTML = '';

            Object.values(BATTLE_ITEMS).forEach(item => {
                const card = document.createElement('div');
                card.className = `item-card rarity-${item.rarity}`;
                card.setAttribute('data-item-id', item.id);
                card.onclick = () => toggleItemSelection(item.id);

                card.innerHTML = `
                    <div class="item-icon-large">${item.icon}</div>
                    <div class="item-card-name">${item.name}</div>
                    <div class="item-card-desc">${item.description}</div>
                `;

                grid.appendChild(card);
            });
        }

        function toggleItemSelection(itemId) {
            const card = document.querySelector(`[data-item-id="${itemId}"]`);
            const isSelected = card.classList.contains('selected');

            if(isSelected) {
                ItemSystem.deselectItem(itemId);
                card.classList.remove('selected');
            } else {
                const success = ItemSystem.selectItem(itemId);
                if(success) {
                    card.classList.add('selected');
                    AudioEngine.playTone(600, 'sine', 0.2);
                } else {
                    AudioEngine.playTone(300, 'sawtooth', 0.2);
                }
            }

            updateItemCounter();
        }

        function updateItemCounter() {
            const counter = document.getElementById('itemCounter');
            const count = ItemSystem.selectedItems.length;
            counter.textContent = `Select up to 2 items (${count}/2 Selected)`;
        }

        function showItemSelection() {
            populateItemsGrid();
            const overlay = document.getElementById('itemSelectionOverlay');
            overlay.classList.add('active');
        }

        function confirmItemSelection() {
            const overlay = document.getElementById('itemSelectionOverlay');
            overlay.classList.remove('active');
            AudioEngine.playTone(800, 'sine', 0.3);

            // Show selected items in battle UI
            ItemSystem.selectedItems.forEach((itemId, index) => {
                const btn = document.getElementById(`battleItem${index}`);
                if(btn) {
                    btn.style.display = 'flex';
                }
            });
            ItemSystem.updateBattleUI();

            // Continue to dossier
            openVillainModal(true);
        }

        function useBattleItem(index) {
            if(!isBattleActive) return;

            const itemId = ItemSystem.selectedItems[index];
            if(!itemId) return;

            ItemSystem.useItem(itemId);
            AudioEngine.playTone(700, 'sine', 0.3);
        }

        // NEW: Initiate Battle Click Handler
        async function openBattleArena() {
             AudioEngine.playTone(800, 'sine', 0.3);

             // 1. SYNERGY CHECK
             const hero1 = heroes.find(h => h.id === selectedHeroes[0]);
             const hero2 = heroes.find(h => h.id === selectedHeroes[1]);

             synergyActive = (hero1.type === hero2.type);

             if(synergyActive) {
                 await playSynergyAnimation(hero1.type);
             }

             // 2. SETUP BATTLE DATA (Select Villain, Reset HP)
             setupBattleState(hero1, hero2);

             // 3. RESET ITEM SYSTEM AND SHOW ITEM SELECTION
             ItemSystem.reset();
             showItemSelection();
        }

        function setupBattleState(hero1, hero2) {
             // Check if this is a story battle and select the appropriate villain
             if (window.storyBattleMode && window.storyBattleRegion && window.storyBattleStage) {
                 const regionId = window.storyBattleRegion;
                 const stageNum = window.storyBattleStage;
                 const stage = REGION_STAGES[regionId].find(s => s.stageNumber === stageNum);

                 if (stage && stage.villain) {
                     // Select the specific villain for this stage
                     currentVillain = villains.find(v => v.name === stage.villain);
                 } else {
                     // Select a random villain from the region's villain pool
                     const region = WORLD_REGIONS[regionId];
                     const regionVillains = villains.filter(v => region.villains.includes(v.name));
                     currentVillain = regionVillains[Math.floor(Math.random() * regionVillains.length)];
                 }

                 // Fallback to random if no match found
                 if (!currentVillain) {
                     currentVillain = villains[Math.floor(Math.random() * villains.length)];
                 }
             } else {
                 // Random battle mode - select any villain
                 currentVillain = villains[Math.floor(Math.random() * villains.length)];
             }

             // Populate Battle Arena Elements (Hidden for now)
             document.getElementById('villainName').innerText = currentVillain.name;
             document.getElementById('villainImg').src = currentVillain.img;
             document.getElementById('villainImg').className = 'side-img'; 

             document.getElementById('hero1Img').src = hero1.image;
             document.getElementById('hero2Img').src = hero2.image;

             // RESET HEALTH
             currentHeroHP = 100;
             currentVillainHP = 100;
             updateHealthUI('villain', 100);
             updateHealthUI('heroes', 100);

             // HIDE POST BATTLE
             document.getElementById('postBattleModal').classList.remove('active');

             // RESET STAGE
             document.getElementById('battleText').innerText = "Waiting for command...";
             const stage = document.getElementById('battleStage');
             stage.classList.remove('slow-mo', 'shake-hard', 'shake', 'shake-light', 'focus-left', 'focus-right', 'intensity-low', 'intensity-high', 'danger');

             // RESET VISUALS
             document.getElementById('elementalOverlay').className = '';
             document.getElementById('elementalOverlay').style.opacity = 0;
             document.querySelectorAll('.side-img').forEach(img => {
                 img.classList.remove('victory-pose', 'charging');
             });
        }

        // NEW: Button handler inside Dossier
        function enterArena() {
            closeVillainModal();
            document.getElementById('combatStartOverlay').style.display = 'flex';
            document.getElementById('battleOverlay').classList.add('active');
            AudioEngine.playTone(600, 'sine', 0.2); // Entry sound
        }

        function updateHealthUI(side, pct) {
            const bar = document.getElementById(side === 'villain' ? 'villainHP' : 'heroesHP');
            bar.style.width = pct + '%';
            if(pct > 60) bar.style.background = side === 'villain' ? '#ef4444' : '#22c55e'; // Green/Red
            else if(pct > 30) bar.style.background = 'orange';
            else bar.style.background = '#dc2626'; // Deep Red
            
            // DANGER STATE TRIGGER
            if (side === 'heroes') {
                const stage = document.getElementById('battleStage');
                if (pct < 30 && pct > 0) {
                    if (!stage.classList.contains('danger')) {
                        stage.classList.add('danger');
                        AudioEngine.startMusic(true); // Start Fast Tempo
                    }
                } else {
                    if (stage.classList.contains('danger')) {
                        stage.classList.remove('danger');
                        AudioEngine.startMusic(false); // Reset Tempo
                    }
                }
            }
        }

        function beginCombatSequence() {
             document.getElementById('combatStartOverlay').style.display = 'none';
             isBattleActive = true;
             BattleStats.reset();
             AudioEngine.startMusic(false);
             
             const hero1 = heroes.find(h => h.id === selectedHeroes[0]);
             const hero2 = heroes.find(h => h.id === selectedHeroes[1]);
             
             runDynamicBattle(hero1, hero2);
        }
        
        function closeBattle() {
             isBattleActive = false;
             AudioEngine.stopMusic();
             document.getElementById('battleOverlay').classList.remove('active');
             document.getElementById('postBattleModal').classList.remove('active');

             // Hide battle item buttons
             document.getElementById('battleItem0').style.display = 'none';
             document.getElementById('battleItem1').style.display = 'none';

             // Remove active effect indicators
             const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
             hImgs.forEach(img => {
                 img.classList.remove('critical-glow', 'power-glow', 'victory-pose', 'hero-victory-center', 'hero-stagger', 'hero-retreat');
             });

             // Remove villain effects
             const vImg = document.getElementById('villainImg');
             if(vImg) {
                 vImg.classList.remove('villain-triumph');
                 vImg.style.opacity = '1';
             }

             // Cleanup cinematic system
             CinematicSystem.cleanup();

             toggleBattleMode();
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));

        function hitEffect(element) {
            element.classList.add('shake');
            element.classList.add('damage-flash');
            AudioEngine.hitSound();
            setTimeout(() => {
                element.classList.remove('shake');
                element.classList.remove('damage-flash');
            }, 500);
        }
        
        // TYPEWRITER EFFECT REMOVED - Replaced with direct text update
        function updateBattleLog(text) {
             document.getElementById('battleText').innerText = text;
        }
        
        /* --- SYNERGY ANIMATION --- */
        async function playSynergyAnimation(type) {
            const overlay = document.getElementById('synergyOverlay');
            const textEl = document.getElementById('synergyText');
            
            let text = "";
            let className = "";
            
            if (type === 'electric') { 
                text = " THUNDERSTORM SYNERGY "; 
                className = "synergy-electric"; 
            }
            if (type === 'ice') { 
                text = " BLIZZARD SYNERGY "; 
                className = "synergy-ice"; 
            }
            if (type === 'impact') { 
                text = " TITAN SMASH SYNERGY "; 
                className = "synergy-impact"; 
            }
            
            overlay.className = `synergy-overlay ${className} active`;
            textEl.innerText = text;
            
            // Trigger elemental burst effects
            createMegaBurst(type);
            setTimeout(() => createMegaBurst(type), 200);
            setTimeout(() => createMegaBurst(type), 400);
            
            // Enhanced sounds per element
            if (type === 'electric') {
                AudioEngine.playTone(100, 'sawtooth', 0.2);
                setTimeout(() => AudioEngine.playTone(200, 'square', 0.15), 100);
                setTimeout(() => AudioEngine.playTone(400, 'sawtooth', 0.2), 200);
            } else if (type === 'ice') {
                AudioEngine.playTone(1000, 'sine', 0.15);
                setTimeout(() => AudioEngine.playTone(1200, 'sine', 0.1), 150);
                setTimeout(() => AudioEngine.playTone(800, 'sine', 0.2), 300);
            } else if (type === 'impact') {
                AudioEngine.playTone(60, 'sawtooth', 0.4);
                setTimeout(() => AudioEngine.playTone(40, 'sawtooth', 0.3), 200);
            }
            
            await delay(2500);
            
            overlay.classList.remove('active');
            await delay(500);
        }

        /* --- VILLAIN MODAL LOGIC --- */
        function openVillainModal(isPreBattle = false) {
            if(!currentVillain) return;
            
            const vModal = document.getElementById('villainModal');
            const vImg = document.getElementById('vmImage');
            const vName = document.getElementById('vmName');
            const vType = document.getElementById('vmType');
            const vDesc = document.getElementById('vmDesc');
            const vSig = document.getElementById('vmSignature');
            const vWeak = document.getElementById('vmWeakness');
            const vStats = document.getElementById('vmStats');
            const vBadge = document.getElementById('vmTypeBadge');
            const startBtn = document.getElementById('vmStartBtn');

            // Show/Hide button based on context
            if (isPreBattle) {
                startBtn.style.display = 'block';
            } else {
                startBtn.style.display = 'none';
            }

            // Icons based on type
            const icons = { electric: '', ice: '', impact: '' };
            
            vImg.src = currentVillain.img;
            vName.innerText = currentVillain.name;
            vType.innerText = `Class: ${currentVillain.type.toUpperCase()}`;
            vDesc.innerText = currentVillain.description;
            vSig.innerText = currentVillain.signature;
            vWeak.innerHTML = `<strong>Weakness:</strong> ${currentVillain.weakness}`;
            vBadge.innerText = icons[currentVillain.type];

            // Render Stats
            vStats.innerHTML = `
                ${createStatRow('Danger', currentVillain.stats.danger, 'villain-stat-fill')}
                ${createStatRow('Speed', currentVillain.stats.speed, 'villain-stat-fill')}
                ${createStatRow('Cunning', currentVillain.stats.cunning, 'villain-stat-fill')}
                ${createStatRow('Power', currentVillain.stats.power, 'villain-stat-fill')}
            `;

            vModal.classList.add('active');
            
            // Trigger stat bars
            setTimeout(() => { 
                vModal.querySelectorAll('.stat-fill').forEach((bar, i) => {
                    setTimeout(() => bar.style.width = bar.getAttribute('data-pct'), i * 100);
                });
            }, 300);
            
            AudioEngine.playTone(100, 'sawtooth', 0.3);
        }

        function closeVillainModal() {
            const vModal = document.getElementById('villainModal');
            vModal.classList.remove('active');
            vModal.querySelectorAll('.stat-fill').forEach(bar => bar.style.width = '0%');
        }

        /* --- POST BATTLE REPORT (NEW) --- */
        function showVictoryScreen(victory) {
            const modal = document.getElementById('postBattleModal');
            const title = document.getElementById('pbTitle');
            const starsEl = document.getElementById('pbStars');
            const scoreEl = document.getElementById('pbScore');
            
            let stars = 0;
            let score = 0;
            
            if(victory) {
                title.innerText = "VICTORY!";
                title.style.background = "linear-gradient(180deg, #fbbf24, #f59e0b)";
                title.style.webkitBackgroundClip = "text";
                
                // Calculate Score
                const hpBonus = Math.round(currentHeroHP * 10);
                const comboBonus = BattleStats.maxCombo * 50;
                const critBonus = BattleStats.critsDealt * 100;
                score = 1000 + hpBonus + comboBonus + critBonus;
                
                // Calculate Stars (EASIER NOW)
                if(currentHeroHP >= 30) stars = 3; // 3 Stars: >30% HP
                else if(currentHeroHP >= 10) stars = 2; // 2 Stars: >10% HP
                else stars = 1;
                
                // Render Details
                scoreEl.innerHTML = `
                    <div class="score-row"><span>Battle Win</span> <span class="score-val">+1000</span></div>
                    <div class="score-row"><span>Health Bonus</span> <span class="score-val">+${hpBonus}</span></div>
                    <div class="score-row"><span>Max Combo (${BattleStats.maxCombo})</span> <span class="score-val">+${comboBonus}</span></div>
                    <div class="score-row"><span>Criticals (${BattleStats.critsDealt})</span> <span class="score-val">+${critBonus}</span></div>
                    <div style="border-top:1px solid #fff; margin-top:10px; padding-top:5px; font-size:2rem; color:#fbbf24;">${score}</div>
                `;
            } else {
                title.innerText = "DEFEAT";
                title.style.background = "linear-gradient(180deg, #ef4444, #991b1b)";
                title.style.webkitBackgroundClip = "text";
                scoreEl.innerHTML = `<div style="color:#fff; margin-top:20px;">Don't give up! Try different heroes!</div>`;
                stars = 0;
            }
            
            // Render Stars
            starsEl.innerHTML = '';
            for(let i=0; i<3; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.innerText = '';
                starsEl.appendChild(star);
                
                if(i < stars) {
                    setTimeout(() => {
                        star.classList.add('active');
                        AudioEngine.playTone(600 + (i*200), 'sine', 0.1);
                    }, 500 + (i * 400));
                }
            }

            modal.classList.add('active');

            // Handle story mode completion
            if (victory && window.storyBattleMode) {
                StoryModeSystem.onStoryBattleVictory();
            }
        }

        /* --- ELEMENTAL FINALE LOGIC --- */
        function triggerElementalFinale(type) {
            const overlay = document.getElementById('elementalOverlay');
            const stage = document.getElementById('battleStage');
            
            // Set Overlay
            if(type === 'electric') overlay.className = 'overlay-electric';
            if(type === 'ice') overlay.className = 'overlay-ice';
            if(type === 'impact') overlay.className = 'overlay-impact';
            
            // Trigger Effects
            overlay.style.opacity = 1;
            stage.classList.add('shake-hard');
            AudioEngine.playTone(150, 'sawtooth', 0.8); // Big crash sound
            
            // Massive Particles
            createMegaBurst(type);
            setTimeout(() => createMegaBurst(type), 200);
            setTimeout(() => createMegaBurst(type), 400);

            // Cleanup
            setTimeout(() => {
                overlay.style.opacity = 0;
                stage.classList.remove('shake-hard');
            }, 1000);
        }

        /* --- STRATEGIC BATTLE ENGINE --- */
        // IMPROVEMENT: Elemental Advantage Calculation
        function getMultiplier(atkType, defType) {
            // Rock Paper Scissors: Electric > Ice > Impact > Electric
            if (atkType === 'electric' && defType === 'ice') return 1.5;
            if (atkType === 'ice' && defType === 'impact') return 1.5;
            if (atkType === 'impact' && defType === 'electric') return 1.5;
            
            if (atkType === 'electric' && defType === 'impact') return 0.7; // Weak
            if (atkType === 'ice' && defType === 'electric') return 0.7;
            if (atkType === 'impact' && defType === 'ice') return 0.7;
            
            return 1.0; // Neutral
        }

        async function runDynamicBattle(h1, h2) {
            const log = document.getElementById('battleText');
            const vImg = document.getElementById('villainImg');
            const vSide = document.getElementById('villainSide');
            const hSide = document.getElementById('heroesSide');
            const hImgs = [document.getElementById('hero1Img'), document.getElementById('hero2Img')];
            const stage = document.getElementById('battleStage');

            // Reset combo and effects
            ComboSystem.reset();
            VisualFX.focusOn(null);
            VisualFX.setIntensity(null);

            // 1. Determine Winner (65% Heroes Win + Synergy Boost)
            // If synergy active, win chance increases to 85%
            const winChance = synergyActive ? 0.85 : 0.65;
            const heroesWin = Math.random() < winChance;

            // 2. Setup Moves Helpers
            const getStandardMove = (h) => h.moves[0] || h.moves[1];
            const getUltimateMove = (h) => h.moves.reduce((prev, current) => (prev.pwr > current.pwr) ? prev : current);

            updateBattleLog(`Muddlewick summons a ${currentVillain.name}!`);
            VisualFX.shake('light');
            await delay(1500); if(!isBattleActive) return;

            // 3. GENERATE BATTLE SEQUENCE (7-10 Turns)
            const totalTurns = Math.floor(Math.random() * 4) + 7;
            let heroComboCount = 0;

            for(let i = 0; i < totalTurns; i++) {
                if(!isBattleActive) return;

                // TICK ITEM EFFECTS AT START OF EACH TURN
                ItemSystem.tickEffects();

                const isHeroTurn = (i % 2 === 0) ? Math.random() > 0.35 : Math.random() > 0.6;

                if(isHeroTurn) {
                    // === HERO ATTACKS ===
                    const attackerIndex = Math.random() > 0.5 ? 0 : 1;
                    const attacker = attackerIndex === 0 ? h1 : h2;
                    const attackerImg = hImgs[attackerIndex];
                    const move = getStandardMove(attacker);

                    // CHECK FOR CRITICAL CHARM EFFECT
                    const criticalEffect = ItemSystem.getActiveEffect('critical');
                    const isCritical = criticalEffect ? true : (Math.random() > 0.75);

                    const taunts = ["Take this!", "Too slow!", "Full power!", "For Hawthorn!", "Hiyah!"];
                    const randomTaunt = taunts[Math.floor(Math.random() * taunts.length)];

                    // Calculate Advantage
                    let multiplier = getMultiplier(attacker.type, currentVillain.type);
                    if(synergyActive) multiplier += 0.2; // Synergy Boost

                    // CHECK FOR POWER CRYSTAL EFFECT
                    const damageEffect = ItemSystem.getActiveEffect('damage');
                    if(damageEffect) multiplier += damageEffect.value;

                    // FOCUS ON HERO
                    VisualFX.focusOn('right');

                    // SPEECH BUBBLE & CHARGE
                    updateBattleLog(`${attacker.name} prepares ${move.name}...`);
                    VisualFX.showSpeech(attackerImg, randomTaunt);
                    const stopCharge = VisualFX.chargeUp(attackerImg, attacker.type);
                    AudioEngine.playTone(400, 'sine', 0.3);
                    await delay(800); if(!isBattleActive) return;

                    stopCharge();

                    // LAUNCH ATTACK
                    updateBattleLog(`${attacker.name} uses ${move.name}!`);
                    VisualFX.fireProjectile(attackerImg, vImg, attacker.type);
                    AudioEngine.playTone(700 + (Math.random()*300), 'square', 0.2);
                    await delay(600); if(!isBattleActive) return;

                    // DODGE OR HIT?
                    const dodgeChance = 0.15;
                    if (Math.random() < dodgeChance) {
                        // DODGE!
                        updateBattleLog(`${currentVillain.name} dodges the attack!`);
                        VisualFX.showSpeech(vImg, "Missed me!");
                        vImg.classList.add('dodge-right'); 
                        setTimeout(() => vImg.classList.remove('dodge-right'), 500);
                        AudioEngine.playTone(150, 'sawtooth', 0.1); // Whiff
                        
                        await delay(1000);
                    } else {
                        // HIT!
                        VisualFX.focusOn('left');
                        
                        // Apply multiplier logic
                        let baseDamage = isCritical ? (20 + Math.random() * 15) : (12 + Math.random() * 10);
                        let finalDamage = baseDamage * multiplier;
                        
                        hitEffect(vImg);
                        AudioEngine.hitSound();

                        const colors = { electric: '#fbbf24', ice: '#22d3ee', impact: '#ef4444' };
                        VisualFX.createImpactRing(vImg, colors[attacker.type]);
                        
                        // NEW: HIT STOP ON CRITICAL
                        if(isCritical) await delay(150);

                        VisualFX.showDamage(vImg, finalDamage, isCritical, multiplier);
                        VisualFX.shake(isCritical ? 'normal' : 'light');
                        
                        // Text Feedback
                        if(multiplier > 1.2) updateBattleLog("IT'S SUPER EFFECTIVE!");
                        else if(multiplier < 0.8) updateBattleLog("It's not very effective...");
                        else if(isCritical) {
                            document.getElementById('flashOverlay').classList.add('screen-flash-white');
                            setTimeout(() => document.getElementById('flashOverlay').classList.remove('screen-flash-white'), 200);
                            updateBattleLog("CRITICAL HIT!");
                            BattleStats.critsDealt++;
                        } else {
                            updateBattleLog(`${currentVillain.name} staggers!`);
                        }
                        
                        // if(isCritical || multiplier > 1) await delay(500);

                        currentVillainHP = Math.max(10, currentVillainHP - finalDamage);
                        updateHealthUI('villain', currentVillainHP);
                        ComboSystem.increment();
                        BattleStats.checkCombo();
                    }

                } else {
                    // === VILLAIN ATTACKS ===
                    heroComboCount = 0;
                    ComboSystem.reset();

                    VisualFX.focusOn('left');

                    updateBattleLog(`${currentVillain.name} charges ${currentVillain.move}!`);
                    VisualFX.showSpeech(vImg, "GRAAAH!", "#ef4444");
                    const stopCharge = VisualFX.chargeUp(vImg, 'impact');
                    AudioEngine.playTone(200, 'sawtooth', 0.4);
                    await delay(1000); if(!isBattleActive) return;

                    stopCharge();

                    updateBattleLog(`${currentVillain.name} unleashes ${currentVillain.move}!`);

                    // Fire at both heroes
                    VisualFX.fireProjectile(vImg, hImgs[0], 'impact');
                    await delay(200);
                    VisualFX.fireProjectile(vImg, hImgs[1], 'impact');

                    await delay(400); if(!isBattleActive) return;

                    // CHECK FOR SMOKE BOMB DODGE EFFECT
                    const dodgeEffect = ItemSystem.getActiveEffect('dodge');
                    const dodgeChance = dodgeEffect ? 1.0 : 0.1;

                    if(Math.random() < dodgeChance) {
                        VisualFX.focusOn('right');
                        if(dodgeEffect) {
                            updateBattleLog("Smoke bomb activated! Attack dodged!");
                            // Remove the dodge effect after use
                            const index = ItemSystem.activeEffects.findIndex(e => e.effectType === 'dodge');
                            if(index > -1) ItemSystem.activeEffects.splice(index, 1);
                        } else {
                            updateBattleLog("The heroes dodge just in time!");
                        }
                        hImgs[0].classList.add('dodge-left');
                        hImgs[1].classList.add('dodge-left');
                        setTimeout(() => {
                             hImgs[0].classList.remove('dodge-left');
                             hImgs[1].classList.remove('dodge-left');
                        }, 500);
                        AudioEngine.playTone(150, 'sawtooth', 0.1);
                        await delay(1000);
                    } else {
                        VisualFX.focusOn('right');
                        let damage = 12 + Math.random() * 12;

                        // CHECK FOR SHIELD BOOST DEFENSE EFFECT
                        const defenseEffect = ItemSystem.getActiveEffect('defense');
                        if(defenseEffect) {
                            damage = damage * (1 - defenseEffect.value);
                            updateBattleLog(`Shield absorbed ${Math.round(defenseEffect.value * 100)}% damage!`);
                        }

                        hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                        AudioEngine.hitSound();
                        VisualFX.createImpactRing(hImgs[0], '#ef4444');
                        VisualFX.showDamage(hImgs[0], damage);
                        VisualFX.shake('normal');

                        currentHeroHP = Math.max(10, currentHeroHP - damage);
                        updateHealthUI('heroes', currentHeroHP);
                        if(!defenseEffect) {
                            updateBattleLog("The heroes take a hit!");
                        }
                    }
                }

                VisualFX.focusOn(null);

                // BOSS ENRAGE PHASE
                if (currentVillainHP < 40 && !vImg.classList.contains('enraged-boss')) {
                    isBattleActive = false; // Pause momentarily
                    AudioEngine.stopMusic();
                    VisualFX.focusOn('left');
                    
                    updateBattleLog(`${currentVillain.name} is ENRAGED!`);
                    VisualFX.showSpeech(vImg, "ROAAAR!!!", "#ef4444");
                    vImg.classList.add('enraged-boss');
                    AudioEngine.playTone(100, 'sawtooth', 1.0); // Big roar sound
                    VisualFX.shake('hard');
                    
                    await delay(2000); 
                    
                    AudioEngine.startMusic();
                    isBattleActive = true;
                }

                await delay(1000);
            }

            if(!isBattleActive) return;

            // 4. THE FINALE
            ComboSystem.reset();
            VisualFX.focusOn(null);

            if(heroesWin) {
                // === HEROES WIN SCENARIO ===
                VisualFX.setIntensity('high');

                updateBattleLog(`${currentVillain.name} roars with fury!`);
                await delay(1500); if(!isBattleActive) return;

                VisualFX.focusOn('left');
                const stopCharge = VisualFX.chargeUp(vImg, 'impact');
                updateBattleLog(`${currentVillain.name} prepares a devastating attack!`);
                await delay(1500); if(!isBattleActive) return;
                stopCharge();

                // Big villain attack
                VisualFX.fireProjectile(vImg, hImgs[0], 'impact');
                VisualFX.fireProjectile(vImg, hImgs[1], 'impact');
                await delay(500);

                VisualFX.focusOn('right');
                VisualFX.shake('hard');
                hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                AudioEngine.playTone(100, 'sawtooth', 0.6);
                VisualFX.showDamage(hImgs[0], 40);
                VisualFX.showDamage(hImgs[1], 40);

                currentHeroHP = 5;
                updateHealthUI('heroes', currentHeroHP);
                updateBattleLog("The heroes are barely standing!");
                await delay(2000); if(!isBattleActive) return;

                // Slow Mo Tension
                AudioEngine.stopMusic();
                stage.classList.add('slow-mo');
                VisualFX.focusOn('right');

                const finisher = Math.random() > 0.5 ? h1 : h2;
                const finisherImg = finisher === h1 ? hImgs[0] : hImgs[1];
                const ult = getUltimateMove(finisher);

                updateBattleLog(`${finisher.name} gathers their last strength...`);
                await delay(2000); if(!isBattleActive) return;

                const stopChargeUlt = VisualFX.chargeUp(finisherImg, finisher.type);
                updateBattleLog(`${finisher.name} channels ${ult.name}!`);
                VisualFX.showSpeech(finisherImg, "IT'S OVER!");
                AudioEngine.playTone(800, 'sine', 1.5);
                await delay(2000); if(!isBattleActive) return;

                stopChargeUlt();

                // ULTIMATE ATTACK
                stage.classList.remove('slow-mo');
                VisualFX.focusOn(null);
                updateBattleLog(`${ult.name.toUpperCase()}!!!`);

                // Multiple projectiles for ultimate
                VisualFX.fireProjectile(finisherImg, vImg, finisher.type);
                await delay(100);
                VisualFX.fireProjectile(finisherImg, vImg, finisher.type);
                await delay(100);
                VisualFX.fireProjectile(finisherImg, vImg, finisher.type);

                await delay(400);

                VisualFX.focusOn('left');
                triggerElementalFinale(finisher.type);
                hitEffect(vImg);
                VisualFX.showDamage(vImg, 999, true);
                updateHealthUI('villain', 0);

                updateBattleLog("K.O.!!!");
                await delay(2000); if(!isBattleActive) return;

                // VICTORY
                VisualFX.focusOn('right');
                hImgs.forEach(img => img.classList.add('victory-pose'));
                updateBattleLog(`The ${currentVillain.name} is defeated! The Heroes Win!`);
                playVictoryTunes();
                VisualFX.setIntensity(null);

                // PLAY VICTORY CINEMATIC
                await delay(1500);
                await CinematicSystem.playVictory(h1, h2, synergyActive ? h1.type : null);

                // SHOW POST BATTLE REPORT
                showVictoryScreen(true);

                // Cleanup cinematic after modal is shown
                setTimeout(() => CinematicSystem.cleanup(), 500);

            } else {
                // === HEROES LOSE SCENARIO ===
                VisualFX.setIntensity('high');

                const trier = h1;
                const trierImg = hImgs[0];

                VisualFX.focusOn('right');
                updateBattleLog(`${trier.name} attempts a final strike!`);
                VisualFX.showSpeech(trierImg, "One last shot!");
                const stopCharge = VisualFX.chargeUp(trierImg, trier.type);
                await delay(1500); if(!isBattleActive) return;

                stopCharge();
                VisualFX.fireProjectile(trierImg, vImg, trier.type);
                await delay(600);

                updateBattleLog(`But ${currentVillain.name} dodges!`);
                VisualFX.showSpeech(vImg, "Ha! Weak!");
                vImg.classList.add('dodge-right');
                setTimeout(() => vImg.classList.remove('dodge-right'), 500);
                await delay(1500); if(!isBattleActive) return;

                VisualFX.focusOn('left');
                updateBattleLog(`${currentVillain.name} unleashes TOTAL CHAOS!`);
                const stopVillainCharge = VisualFX.chargeUp(vImg, 'impact');
                await delay(1000);
                stopVillainCharge();

                VisualFX.shake('hard');
                AudioEngine.playTone(100, 'sawtooth', 0.8);

                for(let i = 0; i < 5; i++) {
                    VisualFX.fireProjectile(vImg, hImgs[0], 'impact');
                    VisualFX.fireProjectile(vImg, hImgs[1], 'impact');
                    await delay(150);
                }

                await delay(400);
                VisualFX.focusOn('right');
                hitEffect(hImgs[0]); hitEffect(hImgs[1]);
                VisualFX.showDamage(hImgs[0], 100);
                VisualFX.showDamage(hImgs[1], 100);
                updateHealthUI('heroes', 0);

                updateBattleLog("The heroes are overwhelmed!");
                await delay(2000); if(!isBattleActive) return;

                AudioEngine.stopMusic();
                VisualFX.focusOn(null);
                VisualFX.setIntensity('low');
                updateBattleLog("Muddlewick laughs... The Heroes must retreat!");
                AudioEngine.playTone(150, 'sine', 1.0);

                // PLAY DEFEAT CINEMATIC
                await delay(1000);
                await CinematicSystem.playDefeat(h1, h2, currentVillain);

                // SHOW POST BATTLE REPORT
                showVictoryScreen(false);

                // Cleanup cinematic after modal is shown
                setTimeout(() => CinematicSystem.cleanup(), 500);
            }
        }
        
        function playVictoryTunes() {
             createMegaBurst('electric'); // Confetti
             setTimeout(() => createMegaBurst('ice'), 500);
             AudioEngine.playTone(400, 'sine', 0.1);
             setTimeout(() => AudioEngine.playTone(600, 'sine', 0.1), 100);
             setTimeout(() => AudioEngine.playTone(800, 'sine', 0.2), 200);
        }

        /* --- RENDER --- */
        const grid = document.getElementById("heroGrid");

        function renderGrid(filterType = 'all') {
            grid.innerHTML = heroes.map(hero => {
                const isHidden = filterType !== 'all' && hero.type !== filterType;
                if (isHidden) return '';
                // New: Calculate colour for border
                const color = hero.type === 'electric' ? '#fbbf24' : hero.type === 'ice' ? '#22d3ee' : '#ef4444';
                // Check if hero is locked in story mode
                const isLocked = StoryModeSystem.storyModeEnabled && !StoryModeSystem.isHeroUnlocked(hero.id);
                const lockedClass = isLocked ? 'locked-hero' : '';
                const onclickHandler = isLocked ? '' : `triggerMegaReveal('${hero.id}')`;
                return `
      <div class="hero-card-container">
        <div class="hero-card ${lockedClass}" id="card-${hero.id}" data-type="${hero.type}"
             style="--hero-color: ${color};"
             onclick="${onclickHandler}"
             onmouseenter="AudioEngine.playTone(100, 'sine', 0.05)"
             onmousemove="tiltCard(event, this)"
             onmouseleave="resetTilt(this)"
             tabindex="0"
             role="button"
             aria-label="Select Hero: ${hero.name}"
             onkeypress="if(event.key === 'Enter' && !${isLocked}) triggerMegaReveal('${hero.id}')">
          <div class="class-badge">${hero.role.split(' ')[0]}</div>
          <div class="scan-line"></div>
          <div class="card-foil"></div>
          <div class="card-image-wrapper">
            <img src="${hero.image}" alt="${hero.name}" onerror="this.src='https://placehold.co/400x500/1e293b/FFF?text=${hero.name.charAt(0)}'">
          </div>
          <div class="card-content">
            <div class="hero-name">${hero.name}</div>
            <div class="hero-alias">${hero.alias}</div>
          </div>
        </div>
      </div>
    `;
            }).join("");
            setTimeout(() => {
                document.querySelectorAll('.hero-card').forEach((card, i) => {
                    setTimeout(() => card.classList.add('reveal'), i * 50);
                });
            }, 50);
        }

        // Initialize Story Mode System
        StoryModeSystem.init();

        renderGrid();

        /* --- DRAMATIC CARD FLIGHT ANIMATION --- */
        function animateCardToCenter(cardElement, hero) {
            const rect = cardElement.getBoundingClientRect();
            // Calculate Center Target
            const centerX = window.innerWidth / 2 - rect.width / 2;
            const centerY = window.innerHeight / 2 - rect.height / 2;
            const colors = {
                electric: '#fbbf24',
                ice: '#22d3ee', 
                impact: '#ef4444'
            };
            const color = colors[hero.type];
            
            // Create flying clone
            const clone = document.createElement('div');
            clone.className = 'flying-card';
            clone.style.width = rect.width + 'px';
            clone.style.height = rect.height + 'px';
            clone.innerHTML = `<img src="${hero.image}" alt="${hero.name}">`;
            clone.style.transition = 'none'; // Ensure no transition initially
            
            // Start Setup (Current Position)
            clone.style.left = rect.left + 'px';
            clone.style.top = rect.top + 'px';
            clone.style.transform = 'none'; // Ensure reset
            
            document.body.appendChild(clone);
            
            // FORCE REFLOW: Critical step for reliable CSS transitions
            void clone.offsetWidth; 

            // Create energy rings
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const ring = document.createElement('div');
                    ring.className = 'energy-ring';
                    ring.style.left = (rect.left + rect.width/2) + 'px';
                    ring.style.top = (rect.top + rect.height/2) + 'px';
                    ring.style.width = '100px';
                    ring.style.height = '100px';
                    ring.style.borderColor = color;
                    document.body.appendChild(ring);
                    setTimeout(() => ring.remove(), 800);
                }, i * 100);
            }
            
            // Create speed lines
            for (let i = 0; i < 8; i++) {
                const line = document.createElement('div');
                line.className = 'speed-line';
                line.style.setProperty('--line-color', color);
                line.style.left = (rect.left + rect.width/2 - 100) + 'px';
                line.style.top = (rect.top + rect.height/2 + (i - 4) * 30) + 'px';
                line.style.width = '200px';
                document.body.appendChild(line);
                setTimeout(() => line.remove(), 500);
            }
            
            // Trigger Animation via Timeout to guarantee start state is registered
            setTimeout(() => {
                clone.style.transition = 'all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1)';
                clone.style.left = centerX + 'px';
                clone.style.top = centerY + 'px';
                
                // RESTORED SPIN: 360 degrees
                clone.style.transform = 'scale(1.2) rotateY(360deg)'; 
                
                clone.style.boxShadow = `0 0 100px ${color}, 0 0 200px rgba(255,255,255,0.5)`;
                clone.style.zIndex = '2000';
            }, 20);
            
            // Remove clone and open modal
            setTimeout(() => {
                clone.style.opacity = '0';
                clone.style.transform = 'scale(1.5) rotateY(360deg)'; // Match rotation end
                setTimeout(() => clone.remove(), 300);
                openModal(hero);
            }, 800);
        }

        /* --- REVEAL / SELECT LOGIC --- */
        function triggerMegaReveal(id) {
            // NOTE: scrollIntoView removed to ensure animation consistency and avoid scroll jumps
            const card = document.getElementById(`card-${id}`);

            if(isBattleSelecting) {
                 handleBattleSelection(id);
                 return;
            }
            AudioEngine.playTone(600, 'sine', 0.1);
            const hero = heroes.find(h => h.id === id);
            
            const flash = document.getElementById('flashOverlay');
            flash.classList.add('active');
            setTimeout(() => flash.classList.remove('active'), 150);
            
            createMegaBurst(hero.type);
            
            // Use new dramatic animation instead of direct modal open
            animateCardToCenter(card, hero);
            AudioEngine.playTone(200, 'sine', 0.2);
        }

        function createMegaBurst(type) {
            const container = document.getElementById('particleContainer');
            const colors = type === 'electric' ? ['#fbbf24', '#fffbeb'] : type === 'ice' ? ['#22d3ee', '#ecfeff'] : ['#ef4444', '#fef2f2'];
            // UPDATED: Added shapes array
            const shapes = ['', '', '', ''];
            
            for (let i = 0; i < 40; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                // Set random shape content
                p.innerText = shapes[Math.floor(Math.random() * shapes.length)];
                p.style.color = colors[Math.floor(Math.random() * colors.length)];
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = 200 + Math.random() * 400;
                
                p.style.width = (10 + Math.random() * 10) + 'px'; 
                p.style.height = p.style.width;
                p.style.left = window.innerWidth / 2 + 'px'; p.style.top = window.innerHeight / 2 + 'px';
                p.style.setProperty('--tx', Math.cos(angle) * velocity + 'px');
                p.style.setProperty('--ty', Math.sin(angle) * velocity + 'px');
                container.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        /* --- MODAL --- */
        const overlay = document.getElementById("modalOverlay");
        const modalCardEl = document.getElementById("modalCard");
        const modalImage = document.getElementById("modalImage");
        const typeBadge = document.getElementById("modalTypeBadge");
        const nameEl = document.getElementById("modalName");
        const roleEl = document.getElementById("modalRole");
        const descEl = document.getElementById("modalDescription");
        const movesEl = document.getElementById("modalMoves");
        const statsEl = document.getElementById("modalStats");

        function openModal(hero) {
            modalImage.src = hero.image;
            modalImage.onerror = function () { this.src = `https://placehold.co/400x500/1e293b/FFF?text=${hero.name.charAt(0)}` };
            const themeColor = hero.type === 'electric' ? '#fbbf24' : hero.type === 'ice' ? '#22d3ee' : '#ef4444';
            const statClass = hero.type === 'electric' ? 'fill-electric' : hero.type === 'ice' ? 'fill-ice' : 'fill-impact';

            modalCardEl.style.setProperty('--theme-color', themeColor);
            typeBadge.style.borderColor = themeColor; typeBadge.style.color = themeColor; typeBadge.innerHTML = hero.icon; typeBadge.style.boxShadow = `0 0 30px ${themeColor}`;
            nameEl.textContent = hero.name; roleEl.innerHTML = `${hero.alias}  ${hero.role}`; descEl.textContent = hero.description;

            movesEl.innerHTML = hero.moves.map(m => `<div class="move-row"><span class="move-name">${m.name}</span><span class="move-val">${m.pwr}</span></div>`).join("");
            statsEl.innerHTML = `
                ${createStatRow('Bravery', hero.stats.bravery, statClass)}
                ${createStatRow('Speed', hero.stats.speed, statClass)}
                ${createStatRow('Strength', hero.stats.strength, statClass)}
                ${createStatRow('Teamwork', hero.stats.teamwork, statClass)}
                ${createStatRow('Focus', hero.stats.focus, statClass)}
            `;
            overlay.classList.add("active");
            setTimeout(() => { document.querySelectorAll('.stat-fill').forEach((bar, i) => setTimeout(() => bar.style.width = bar.getAttribute('data-pct'), i * 100)); }, 300);
        }

        function createStatRow(label, val, colorClass) {
            const pct = (val / 5) * 100 + '%';
            return `<div class="stat-row"><div class="stat-label">${label}</div><div class="stat-track"><div class="stat-fill ${colorClass}" data-pct="${pct}"></div></div></div>`;
        }

        function closeModal() {
            AudioEngine.playTone(300, 'sine', 0.1);
            overlay.classList.remove("active");
            document.querySelectorAll('.stat-fill').forEach(bar => bar.style.width = '0%');
        }

        /* --- TILT --- */
        function tiltCard(e, card) {
            if(isTouch) return; // Disable on touch devices
            if(card.classList.contains('selected')) return;
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            
            // Pass CSS variables for foil position
            card.style.setProperty('--x', `${(x / rect.width) * 100}%`);
            card.style.setProperty('--y', `${(y / rect.height) * 100}%`);

            const rotateX = ((y - rect.height / 2) / (rect.height / 2)) * -8;
            const rotateY = ((x - rect.width / 2) / (rect.width / 2)) * 8;
            card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
        }
        function resetTilt(card) { 
             if(card.classList.contains('selected')) { card.style.transform = `scale(1.05)`; } 
             else { card.style.transform = `rotateX(0deg) rotateY(0deg) scale(1)`; }
        }

        /* --- FILTER --- */
        function filterGrid(type, btn) {
            if(isBattleSelecting) return;
            AudioEngine.playTone(500, 'sine', 0.05);
            document.querySelectorAll('.filter-btn:not(#muddlewickBtn)').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const root = document.documentElement;
            if (type === 'electric') { root.style.setProperty('--nebula-1', 'rgba(251, 191, 36, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(245, 158, 11, 0.1)'); } 
            else if (type === 'ice') { root.style.setProperty('--nebula-1', 'rgba(34, 211, 238, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(14, 165, 233, 0.1)'); } 
            else if (type === 'impact') { root.style.setProperty('--nebula-1', 'rgba(239, 68, 68, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(220, 38, 38, 0.1)'); } 
            else { root.style.setProperty('--nebula-1', 'rgba(76, 29, 149, 0.2)'); root.style.setProperty('--nebula-2', 'rgba(56, 189, 248, 0.1)'); }
            document.querySelectorAll('.hero-card-container').forEach(c => c.classList.add('hidden'));
            setTimeout(() => renderGrid(type), 300);
        }
    </script>

</body>

</html>